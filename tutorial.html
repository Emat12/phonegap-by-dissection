<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="css/tutorial.css" />
<title>My first PhoneGap 3.x app - A tutorial by dissection</title>
</head>
<body>
<header>&nbsp;<br>&nbsp;</header>
    
    <div>
        <h1>My first PhoneGap 3.x app - A tutorial by dissection</h1>
        
        <div class="alert">
        	<ul>
        	<li>The latest, greatest and up-to-datest "source code" for this tutorial is at <a href="https://github.com/drappenheimer/phonegap-by-dissection">https://github.com/drappenheimer/phonegap-by-dissection</a></li>
        	<li>The official support forum for this tutorial is at <a href="http://drappenheimer.com/forum/2">http://drappenheimer.com/forum/2</a> (login account required)</li>
        	<li>This is version 0.9 of the tutorial (first published ??/01/2014)</li>
        	<li>The Android app in question is <em>Japxlate</em> in the Google Play market here <a href="https://play.google.com/store/apps/details?id=com.drappenheimer.japxlate">https://play.google.com/store/apps/details?id=com.drappenheimer.japxlate</a></li>
        	<li>Latest source code for the actual app is at <a href="https://github.com/drappenheimer/japxlate-android">https://github.com/drappenheimer/japxlate-android</a></li>
        	<li>App sources are always updated before the tutorial sources</li>
        	<li>This tutorial was written using PhoneGap v3.1.0, but has been updated to cover anything new or different in v3.3.0</li>
        	</ul>
        </div>
        
        <h2 id="introduction">Introduction</h2>
        <p>
            This tutorial is going to teach you how to get started with mobile app development using the <a href="http://phonegap.com">PhoneGap</a>
platform. We'll essentially rebuild, from scratch, a basic yet fully-functional app that really exists!
It's called <em>Japxlate</em> and can be found at <a href="https://play.google.com/store/apps/details?id=com.drappenheimer.japxlate">https://play.google.com/store/apps/details?id=com.drappenheimer.japxlate</a>. The app is a Japanese dictionary that you can search - even if offline.
Not to worry though, we won't get bogged down in the nitty gritty of Japanese linguistics. We'll focus
on setting up, building and finally deploying the app.
You'll laugh, you'll cry, you'll sick a little bit in the back of your throat, but the journey will definitely be worth it...
        </p>
        
        <h3>Conventions used in the text</h3>
        
		<ul>        
        
        <li>
        <p>A command that you need to type on the Linux command line will look like:</p>
        <code class="terminal"><span>you@yours$ somewhere]$</span> some linux command to type</code>
		</li>        
        
        <li>
        <p>Code (of any type - CSS, HTML or JavaScript) that you need to type in will look like:</p>
<code class="multiline"><span style='color:#3f7f59; '>//does the cursor have random fractals?</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> checkRandomFractals()
{
    <span style='color:#7f0055; font-weight:bold; '>return</span> something.or.other;
}</code>
		</li>
		
		<li>
			<p>HTML elements will be referred to like:</p>
			<p>&lt;elementname></p>
		</li>
		
		<li>
			<p>Code fragments, variable names, method names etc will look like:</p>
			<p><code>someMethod();</code></p>
		</li>

		<li>
			<p>File names and folder names will look like:</p>
			<p><code class="file">/assets/www/some_file.html</code></p>
		</li>
		
		<li>
			<p>A side note, something tangental to the main text, will look like:</p>
			<div class="sidenote">I'm hungry but my teeth hurt.</div>
		</li>
		
		<li>
			<p>New or updated information relevant for PhoneGap v3.3.0 will look like:</p>
			<div class="new_3_3_0">PhoneGap v3.3.0 uses the "Plugman" plugin manager.</div>
		</li>
</ul>    
        
        <h2 id="table_of_contents">Table of contents</h2>
        
        <ol>
            <li><a href="#what_youll_need">What you'll need</a></li>
            <li><a href="#what_is_phonegap">What is PhoneGap?</a></li>
            <li><a href="#getting_started">Getting started</a>
                <ol>
                    <li><a href="#getting_started_i">The cool new way</a></li>
                    <li><a href="#getting_started_ii">The fiddly older way</a></li>
                </ol>
            </li>
            <li><a href="#quick_runthrough_of_the_default_app">Quick run-through of the default app</a></li>
            <li><a href="#first_things_first_the_layout">First things first: The layout</a></li>
            <li><a href="#first_things_first_the_tabbing_mechanism">First things first: The tabbing mechanism</a></li>
            <li><a href="#the_search_tab">The <em>Search</em> tab</a>
                <ol>
                    <li><a href="#the_search_tab_i">Layout and interface</a></li>
                    <li><a href="#the_search_tab_ii">Creating the database</a></li>
                    <li><a href="#the_search_tab_iii">Querying the database</a></li>
                    <li><a href="#the_search_tab_iv">Results scrolling</a></li>
                    <li><a href="#the_search_tab_v">Extra credit challenges</a></li>
                </ol>
            </li>
            <li><a href="#the_discover_tab">The <em>Discover</em> tab</a>
                <ol>
                    <li><a href="#the_discover_tab_i">Layout and interface</a></li>
                    <li><a href="#the_discover_tab_ii">Extra credit challenges</a></li>
                </ol>
            </li>
            <li><a href="#the_write_tab">The <em>Write</em> tab</a>
                <ol>
                    <li><a href="#the_write_tab_i">Layout and interface</a></li>
                    <li><a href="#the_write_tab_ii">Filling the screen</a></li>
                    <li><a href="#the_write_tab_iii">Displaying a random character</a></li>
                    <li><a href="#the_write_tab_iv">Finger doodling</a></li>
                    <li><a href="#the_write_tab_v">Extra credit challenges</a></li>
                </ol>
            </li>
            <li><a href="#splash_screen">Splash screen</a></li>
            <li><a href="#launcher_icon">Launcher icon</a></li>
            <li><a href="#submitting_to_google_play">Submitting to Google Play</a></li>
            <li><a href="#thats_all_folks">That's all folks!</a></li> 
        </ol>
        
        
        <h2 id="what_youll_need">What you'll need</h2>
        
        <p>To keep things small and simple we'll focus solely on developing on <strong>Linux</strong> for an app that we'll make for
<strong>Android</strong>. Though one huge benefit of PhoneGap is that you can package the same(ish) code into a working app
for many different mobile platforms. We also won't be using any third-party JavaScript or CSS libraries, though
these will be useful to you going forward with your app development. What you'll need:</p>

<ul>
<li>A Linux desktop box</li>
<li>PhoneGap (which requires NodeJS) on the above box - at time of writing this tutorial I was using version 3.1.0.
Don't worry, we'll install this in the <a href="#getting_started">Getting started</a> chapter</li>
<li>As many Android devices as you can get your hands on! At least one</li>
<li>Google's "Android Developer Tools" bundle - or at least Eclipse with the Android plugins. 
Again we'll cover this in the <a href="#getting_started">Getting started</a> chapter</li>
<li>At least a lower-intermediate knowledge of HTML5, JavaScript and CSS</li>
<li>To not be terrified of the Linux command line!</li>
</ul>

 
 
<h2 id="what_is_phonegap">What is PhoneGap?</h2> 

<p>PhoneGap is a way to make apps for mobile devices using standard website frontend technologies.
Namely HTML5, JavaScript
and CSS. PhoneGap is free and open source. PhoneGap apps aren't true or <em>native</em> apps, but rather they are apps that open up a "WebView"
on you mobile device - 
essentially a web browser in fullscreen mode without title bars or bezels - running your
frontend code. It's not a million miles away from a desktop browser running in fullscreen
mode (usually accessed by pressing F11). Implemented well, this non-nativeness isn't necessarily a bad thing.
</p>
 
<div class="sidenote">
<strong>PhoneGap versus Cordova</strong>
<p>You've probably come across the term "Cordova" in your research for PhoneGap.
PhoneGap and Cordova are very closely related, and so it's worth explaining the difference.
There's a lot of back-story here which I'll skip, but in a nutshell:</p>

<p><strong>PhoneGap</strong> is a software product by Adobe Systems Inc. It is a branded and
maintained distribution of:</p>

<p><strong><a href="http://cordova.apache.org/">Cordova</a></strong>, which is a free and open source project maintained by the Apache Software Foundation (ASF).</p>

<p>At the time of writing, PhoneGap adds a <em>cloud build</em> service to basic Cordova. This changes the command line for PhoneGap (versus Cordova) somewhat, though you should be able to - in theory - follow this tutorial using plain vanilla Cordova instead of PhoneGap.
I also noticed, annoyingly, that a lot of PhoneGap documentation simply points to Cordova documentation which can mean that the command line syntax is wrong.</p>

</div>
 
<h2 id="getting_started">Getting started</h2>

<p>There are two routes we can go down to get started with PhoneGap development.
Both routes require the Android SDK to be installed so let's do that first.
The easiest way to install the Android SDK is to install the Android Developer Tools (or ADT)
bundle. This bundle installs the Android SDK <strong>and</strong> Eclipse IDE configured
for Android (native) development.</p>

<p>Right, let's install the Android Developer Tools. The easy peasy way is to download and install the
"ADT Bundle for Linux" from <a href="http://developer.android.com/sdk/index.html">http://developer.android.com/sdk/index.html</a> which should be worry free.</p>

<p>If you're already using Eclipse IDE, you can simply download the Android Developer Tools plugin for it at
<a href="http://developer.android.com/tools/index.html">http://developer.android.com/tools/index.html</a>.</p>

<div class="sidenote">
<strong>About IDEs</strong>
<p>You aren't forced to use Eclipse IDE for Android development, though it does make a lot of things easier
as it supports direct deploy to an actual Android device and it has a virtual device manager for
deploying to <em>emulated</em> Android devices.</p>

<p>Myself, I didn't like the way that Eclipse was opening - and highlighting - the various frontend source files
for the app (though I don't doubt that this is configurable in the options somewhere!). There's also the fact that it doesn't <em>speak</em> PhoneGap.
I found myself cutting the code in <a href="https://netbeans.org/">NetBeans IDE</a> and checking in with Eclipse every now and again
to deploy to the actual device (Ctrl-F11) or to check <code>console.log()</code> messages in LogCat.</p>

<p>Netbeans IDE v7.4 dropped just before I finished this tutorial and interestingly that seems
to have PhoneGap (well, Cordova) support built in! Definitely worth a look.</p>

<p>Bizarrely, I found that regardless of the IDE used, I often had to deploy to the device <em>twice</em>
in order to have it truly updated. This happened whenever a <em>resource</em> file was updated, ie. JavaScript or HTML or CSS.
I notice this doesn't happen when Java sources are edited which indicates some kind of caching issue.
I still haven't got to the bottom of this particular mystery.</p>
</div>

<h3 id="getting_started_i">The cool new way</h3>

<p>OK, now we can install PhoneGap itself. For some strange reason that I can't figure out (I'm guessing it's just for package management) it
requires NodeJS so go to <a href="http://nodejs.org">http://nodejs.org</a> and install it. Then, as we see at <a href="http://phonegap.com/install">http://phonegap.com/install</a>
we simply do (on the command line):</p>

<code class="terminal"><span>you@yours$ somewhere]$</span> sudo npm install -g phonegap</code>

<p>This installs the PhoneGap binaries and commands globally on our system. After that, let's actually create the PhoneGap project where we'll put all of our lovely code for the app.
There are two slightly different syntaxes for this:</p>
   

<code class="terminal"><span>you@yours$ somewhere]$</span> phonegap create --name "Japxlate" --id "com.drappenheimer.japxlate" japxlate</code>
<p>or</p>
<code class="terminal"><span>you@yours$ somewhere]$</span> phonegap create japxlate com.drappenheimer.japxlate "Japxlate"</code>

<p>This will create a PhoneGap project folder structure for building the same code to many different device targets (Android or iOS etc).
<code>"Japxlate"</code> is the name of our app (in quotes). <code>com.drappenheimer.japxlate</code> is our app's reverse domain name identifier. All Android apps have a unique identifier like this. <code>japxlate</code> is our desired folder name for the project.
We then want to do:</p>

<code class="terminal"><span>you@yours$ somewhere]$</span> cd japxlate
<span>you@yours$ japxlate]$</span> phonegap run android</code>


<p>Which will detect your Android SDK and try to run the app on the currently connected device (or configured virtual machine).
If no Android SDK is found or present, it will try to deploy the app to your account on the
PhoneGap remote cloud build environment - which is just out of beta at time of writing.
<strong>But</strong> you'll more than likely need an extra bit of setup to get this <code>run android</code> command to work.
Specifically you'll need to add a couple of folders from the Android SDK install to your PATH. The gory details are at <a href="http://docs.phonegap.com/en/edge/guide_platforms_android_index.md.html#Android%20Platform%20Guide">http://docs.phonegap.com/en/edge/guide_platforms_android_index.md.html#Android%20Platform%20Guide</a>,
but how I did it was to add the following lines to my <code class="file">~/.bashrc</code> file:</p>
 
<code class="multiline">export ANDROID_SDK_HOME=/wherever/you/installed/it/adt-bundle-linux-x86_64-20130729/sdk
export PATH=${PATH}:${ANDROID_SDK_HOME}/platform-tools:${ANDROID_SDK_HOME}/tools
</code>
 
<p>As well as this I personally needed the Java <em>development</em> libraries to be installed.<p>


<p>If the <code>run android</code> command still doesn't work after all this configuration, double check your Android SDK Manager which you can reach from the Eclipse IDE.</p>

<p>Note that this <code>run</code> command is a shortcut for the <code>build</code> followed by <code>install</code> commands.
If you don't want to actually run your PhoneGap app from the command line, you need to at least build it which is like this:</p>

<code class="terminal"><span>you@yours$ japxlate]$</span> phonegap build android</code>

<p>This will create a <code class="file">PROJECTROOT/platforms/android</code> folder with skeleton source files for our app in it.
And importantly the project files for this to be pickupable as an Android project in Eclipse IDE.</p>

<div class="sidenote">
<strong>How many mobile platforms does it take to change a lightbulb?</strong>
<p>You might be wondering now, if PhoneGap is supposed to be this amazing tool
that lets us write the same app code for multiple mobile platforms, why would
we want to dive straight in to the <code class="file">/platforms/android</code> folder?
How is that going to work on, say, iOS?</p>
<p>The answer is simple, PhoneGap is indeed a tool where the same app code can be compiled
for multiple mobile platforms, but - in a nutshell - we are cheating and taking a shortcut!
This tutorial is rather simplified and focuses solely on Android. This is why we dive right in
at <code class="file">/platforms/android</code>.</p>
<p>If your app needs to work on multiple mobile platforms - as most apps do - then you should really
create your app's code in <code class="file">PROJECTROOT/www</code>, specifying any platform-specific
customisations in <code class="file">PROJECTROOT/merges</code>, then debug each time for your
platforms with the <code>build</code>, <code>install</code> and <code>run</code> commands.
The excellent blog post at <a href="http://devgirl.org/2013/09/05/phonegap-3-0-stuff-you-should-know/">http://devgirl.org/2013/09/05/phonegap-3-0-stuff-you-should-know/</a> explains this very well.</p>
</div>


<p>Like the <code>run</code> command, the <code>build</code> command will also fallback to
the remote cloud build environment. You can disable this fallback with the command
<code>phonegap local build android</code>.</p>

<p>Right, so now you've at least built your app on the command line. You might even have run it from
the command line! Going forward with this tutorial, let's plug the skeleton code we've just built into
our Eclipse IDE as an Android project. Follow these steps:</p>

<ol>
<li>Click File --> New --> Project</li>
<li>Select Android --> <em>Android Project from Existing Code</em> (note there's also a sample native project in there!)</li>
<li>Browse to <code class="file">PROJECTROOT/platforms/android</code> folder (actually just <code class="file">PROJECTROOT</code> seems to also work)</li>
<li>Click OK</li>
<li>You'll get an "Import Projects" dialogue now with the project details that you can confirm / change and then click Finish</li>
</ol>


<div class="sidenote">
<strong>Keeping your PhoneGap up-to-date</strong>
<p>Installing PhoneGap via NodeJS has the nice advantage that you can keep your PhoneGap version up-to-date
by running this command:</p>
<code class="terminal"><span>you@yours$ somewhere]$</span> sudo npm update -g phonegap</code>
</div>

<h3 id="getting_started_ii">The fiddly older way</h3>

<p>An older way of getting started (that PhoneGap up to v2.1.0 used) still works and can
be useful if you are struggling with the configuration steps details in the above section.
You'll still need to have Eclipse with the ADT installed first, but you won't have to fiddle around
with installing NodeJS or altering PATH environment variables.</p>

<p>Simply download - rather than install - the relevant "archive" version of PhoneGap from
<a href="http://phonegap.com/install">http://phonegap.com/install</a>, and then you can
follow the steps from "Setup New Project" at <a href="http://docs.phonegap.com/en/2.1.0/guide_getting-started_android_index.md.html#Getting%20Started%20with%20Android">http://docs.phonegap.com/en/2.1.0/guide_getting-started_android_index.md.html#Getting%20Started%20with%20Android</a>.
<strong>Please note that</strong> these instructions are for older versions of PhoneGap and Eclipse
and so your mileage with the latest versions may vary.
<a href="http://www.adobe.com/devnet/html5/articles/getting-started-with-phonegap-in-eclipse-for-android.html">http://www.adobe.com/devnet/html5/articles/getting-started-with-phonegap-in-eclipse-for-android.html</a> is also a useful reference.</p>


<p>Sorry but I can't specify exactly how to do it this way as it is not the supported way any more.
It might stop working for future versions of PhoneGap. Though I could get it working - with a few tweaks - 
with PhoneGap v3.1.0.</p>

<p>Advantages of this method: You don't have to install PhoneGap or NodeJS or any dependencies.
Disadvantages of this method: You don't get PhoneGap's latest template for setting up an Android app and you have to do it manually (ie. updating the manifest etc).</p>
</p>
   

   
<h2 id="quick_runthrough_of_the_default_app">Quick run-through of the default app</h2>
   
<p>Our app starts life as the PhoneGap "Hello world" app (unless you went <a href="#getting_started_ii">The fiddly older way</a> in which case
it's empty). This is a good starting point and has some things we can build on and learn from.
Of course we'll need to ditch a lot of it as well!</p>

<p>Go ahead, hit CTRL-F11 in Eclipse to run the app on your virtual or actual device. We get a little robot icon
and a pulsing (via CSS3) "device is ready" message. Rotate your device, it redraws itself accordingly and changes the layout slightly if needed.
It also doesn't present or allow any kind of scrolling or pinching which is A Good Thing for most apps -
including Japxlate.</p>

<div class="figure">
    <img src="img/figure/fig_10.png">
    <p>Figure 1. The default PhoneGap app (landscape)</p>
</div>
        
<p>The files that we'll be wanting to edit (CSS, HTML5, JavaScript) to make our own app can be found in the assets/www
folder of our Eclipse project.</p>

<p>Let's take a look at the generated assets/www/index.html (Apache licence text removed for brevity):</p>


<code class="multiline"><span style='color:#7f0055; '>&lt;!DOCTYPE html></span>
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>html</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>head</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>meta</span> charset=<span style='color:#2a00ff; '>"utf-8"</span> <span style='color:#7f0055; '>/></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>meta</span> name=<span style='color:#2a00ff; '>"format-detection"</span> content=<span style='color:#2a00ff; '>"telephone=no"</span> <span style='color:#7f0055; '>/></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>meta</span> name=<span style='color:#2a00ff; '>"viewport"</span> content=<span style='color:#2a00ff; '>"user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi"</span> <span style='color:#7f0055; '>/></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>link</span> rel=<span style='color:#2a00ff; '>"stylesheet"</span> type=<span style='color:#2a00ff; '>"text/css"</span> href=<span style='color:#2a00ff; '>"css/index.css"</span> <span style='color:#7f0055; '>/></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>title</span><span style='color:#7f0055; '>></span>Hello World<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>title</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>head</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>body</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> class=<span style='color:#2a00ff; '>"app"</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>h1</span><span style='color:#7f0055; '>></span>PhoneGap<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>h1</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"deviceready"</span> class=<span style='color:#2a00ff; '>"blink"</span><span style='color:#7f0055; '>></span>
                <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>p</span> class=<span style='color:#2a00ff; '>"event listening"</span><span style='color:#7f0055; '>></span>Connecting to Device<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>p</span><span style='color:#7f0055; '>></span>
                <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>p</span> class=<span style='color:#2a00ff; '>"event received"</span><span style='color:#7f0055; '>></span>Device is Ready<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>p</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript" src="phonegap.js"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript" src="js/index.js"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript"</span><span style='color:#7f0055; '>></span>
            app.initialize();
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>body</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>html</span><span style='color:#7f0055; '>></span></code>

<p><span class="new_3_3_0">(PhoneGap v3.3.0 adds a comment talking about a workaround for iOS 7.)</span>
We've got the simplified "html" DOCTYPE for HTML5.
We explicity set a charset of utf-8 Unicode which is clearly going to be very important for this app!
We've got a lot of "viewport" settings which are mostly self-explanatory, but essentially say
   "this app fills the device display, defaults to 100% zoom and can not be zoomed in or out". This
is really going to help our PhoneGap app look and feel more like a native app and not a web browser
view.</p>

<p>We then link to some CSS which we'll look at shortly.
The <code>&lt;title></code> needs updating, but this won't normally be visible to the app user anyway. Especially as
	PhoneGap build puts a theme setting of <code>Theme.Black.NoTitleBar</code> in <code class="file">AndroidManifest.xml</code>.</p>

<p>Then the <code>&lt;body></code> starts and we have whatever markup the app needs.
Just before the <code>&lt;body></code> closes, we have links to some JavaScript (this is debated but considered to be something of a <a href="http://elegantcode.com/2010/03/30/your-javascript-goes-where/">performance improvement</a>).
<code class="file">phonegap.js</code> (in <code class="file">assets/www</code>) is the PhoneGap library and is how we can access phone hardware (ie. camera)
from JavaScript in our PhoneGap app.
Commenting out this file will enable you to <em>somewhat</em> preview the app just by opening the <code class="file">index.html</code> file
in Chrome desktop browser. We'll talk about this later.
</p>

<p><code class="file">js/index.js</code> is JavaScript specifically for this app. We then call <code>app.initialize()</code>. The <code>app</code> object is in
<code class="file">index.js</code> which we'll look at after taking a quick peek at the key things in the CSS file we mentioned
a moment ago (Apache licence text removed for brevity):</p>

<code class="multiline">* {
    -webkit-tap-highlight-color: rgba(0,0,0,0); <span style='color:#3f7f59; '>/* make transparent link selection, adjust last value opacity 0 to 1.0 */</span>
}

<span style='color:#7f0055; font-weight:bold; '>body</span> {
    -webkit-touch-callout: none;                <span style='color:#3f7f59; '>/* prevent callout to copy image, etc when tap to hold */</span>
    -webkit-text-size-adjust: none;             <span style='color:#3f7f59; '>/* prevent webkit from resizing text to fit */</span>
    -webkit-user-select: none;                  <span style='color:#3f7f59; '>/* prevent copy paste, to allow, change 'none' to 'text' */</span>
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#E4E4E4;
    <span style='color:#7f0055; font-weight:bold; '>background-image</span>:linear-gradient(top, #A7A7A7 0%, #E4E4E4 51%);
    <span style='color:#7f0055; font-weight:bold; '>background-image</span>:-webkit-linear-gradient(top, #A7A7A7 0%, #E4E4E4 51%);
    <span style='color:#7f0055; font-weight:bold; '>background-image</span>:-ms-linear-gradient(top, #A7A7A7 0%, #E4E4E4 51%);
    <span style='color:#7f0055; font-weight:bold; '>background-image</span>:-webkit-gradient(
        linear,
        left top,
        left bottom,
        color-stop(0, #A7A7A7),
        color-stop(0.51, #E4E4E4)
    );
    <span style='color:#7f0055; font-weight:bold; '>background-attachment</span>:fixed;
    <span style='color:#7f0055; font-weight:bold; '>font-family</span>:<span style='color:#2a00ff; '>'</span><span style='color:#2a00ff; '>HelveticaNeue-Light</span><span style='color:#2a00ff; '>'</span>, <span style='color:#2a00ff; '>'</span><span style='color:#2a00ff; '>HelveticaNeue</span><span style='color:#2a00ff; '>'</span>, Helvetica, Arial, sans-serif;
    <span style='color:#7f0055; font-weight:bold; '>font-size</span>:12px;
    <span style='color:#7f0055; font-weight:bold; '>height</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>margin</span>:0px;
    <span style='color:#7f0055; font-weight:bold; '>padding</span>:0px;
    <span style='color:#7f0055; font-weight:bold; '>text-transform</span>:uppercase;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
}

<span style='color:#3f7f59; '>/* Portrait layout (default) */</span>
.app {
    <span style='color:#7f0055; font-weight:bold; '>background</span>:<span style='color:#7f0055; font-weight:bold; '>url</span><span style='color:#2a00ff; '>(</span><span style='color:#3f3fbf; '>../img/logo.png</span><span style='color:#2a00ff; '>)</span> no-repeat center top; <span style='color:#3f7f59; '>/* 170px x 200px */</span>
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;             <span style='color:#3f7f59; '>/* position in the center of the screen */</span>
    <span style='color:#7f0055; font-weight:bold; '>left</span>:50%;
    <span style='color:#7f0055; font-weight:bold; '>top</span>:50%;
    <span style='color:#7f0055; font-weight:bold; '>height</span>:50px;                   <span style='color:#3f7f59; '>/* text area height */</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:225px;                   <span style='color:#3f7f59; '>/* text area width */</span>
    <span style='color:#7f0055; font-weight:bold; '>text-align</span>:center;
    <span style='color:#7f0055; font-weight:bold; '>padding</span>:180px 0px 0px 0px;     <span style='color:#3f7f59; '>/* image height is 200px (bottom 20px are overlapped with text) */</span>
    <span style='color:#7f0055; font-weight:bold; '>margin</span>:-115px 0px 0px -112px;  <span style='color:#3f7f59; '>/* offset vertical: half of image height and text area height */</span>
                                   <span style='color:#3f7f59; '>/* offset horizontal: half of text area width */</span>
}

<span style='color:#3f7f59; '>/* Landscape layout (with min-width) */</span>
@<span style='color:#7f0055; '>media</span> <span style='color:#7f0055; '>screen and (min-aspect-ratio: 1/1) and (min-width:400px) </span>{
    .app {
        <span style='color:#7f0055; font-weight:bold; '>background-position</span>:left center;
        <span style='color:#7f0055; font-weight:bold; '>padding</span>:75px 0px 75px 170px;  <span style='color:#3f7f59; '>/* padding-top + padding-bottom + text area = image height */</span>
        <span style='color:#7f0055; font-weight:bold; '>margin</span>:-90px 0px 0px -198px;  <span style='color:#3f7f59; '>/* offset vertical: half of image height */</span>
                                      <span style='color:#3f7f59; '>/* offset horizontal: half of image width and text area width */</span>
    }
}
&vellip;</code>

<p>The clause for <code>*</code> simply removes, from any element that we might make tappable, the default sickly orange
highlight that Android WebView gives to links and buttons and things.</p>

<p>The <code>body</code> clause starts by disabling some default Android WebView interations. This makes our PhoneGap
app feel a bit more nativey.</p>

<p>Then we set a grey gradient as the background.</p>

<p>Then we set the font type and size (12px).
Height and width are both set to 100% which makes our <code>&lt;body></code> fill the size of the WebView screen.
We specify no margin (which is gap space <em>outside</em> the <code>&lt;body></code>) and no padding (which is gap space <em>inside</em> the <code>&lt;body></code>).</p>

<p>in <code>.app</code> - our top level div in the markup - we set the layout of our app specific things.
Portrait orientation is assumed - a safe assumption for most phone apps.
I won't bore you with this too much (but if you are baffled then please see a CSS refresher) other than to say it pulls some strings with absolute positioning
and negative margins to centre a background image and some text.</p>

<p>Then we have another <code>.app</code> block wrapped in what's called a media query (<a href="http://cssmediaqueries.com/what-are-css-media-queries.html">http://cssmediaqueries.com/what-are-css-media-queries.html</a> is a useful introduction)
which triggers when the phone is rotated into landscape view. It moves the background image to the left of the text and
also moves the text such that things are still centred.</p>


<p>Right, let's get back to that <code class="file">js/index.js</code> file that we've almost forgotten about! (Apache licence text removed for brevity):</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>var</span> app = {
    <span style='color:#3f7f59; '>// Application Constructor</span>
    initialize: <span style='color:#7f0055; font-weight:bold; '>function</span>() {
        <span style='color:#7f0055; font-weight:bold; '>this</span>.bindEvents();
    },
    <span style='color:#3f7f59; '>// Bind Event Listeners</span>
    <span style='color:#3f7f59; '>//</span>
    <span style='color:#3f7f59; '>// Bind any events that are required on startup. Common events are:</span>
    <span style='color:#3f7f59; '>// 'load', 'deviceready', 'offline', and 'online'.</span>
    bindEvents: <span style='color:#7f0055; font-weight:bold; '>function</span>() {
        document.addEventListener(<span style='color:#2a00ff; '>'deviceready'</span>, <span style='color:#7f0055; font-weight:bold; '>this</span>.onDeviceReady, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    },
    <span style='color:#3f7f59; '>// deviceready Event Handler</span>
    <span style='color:#3f7f59; '>//</span>
    <span style='color:#3f7f59; '>// The scope of 'this' is the event. In order to call the 'receivedEvent'</span>
    <span style='color:#3f7f59; '>// function, we must explicity call 'app.receivedEvent(...);'</span>
    onDeviceReady: <span style='color:#7f0055; font-weight:bold; '>function</span>() {
        app.receivedEvent(<span style='color:#2a00ff; '>'deviceready'</span>);
    },
    <span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
    receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
        <span style='color:#7f0055; font-weight:bold; '>var</span> parentElement = document.getElementById(id);
        <span style='color:#7f0055; font-weight:bold; '>var</span> listeningElement = parentElement.querySelector(<span style='color:#2a00ff; '>'.listening'</span>);
        <span style='color:#7f0055; font-weight:bold; '>var</span> receivedElement = parentElement.querySelector(<span style='color:#2a00ff; '>'.received'</span>);

        listeningElement.setAttribute(<span style='color:#2a00ff; '>'style'</span>, <span style='color:#2a00ff; '>'display:none;'</span>);
        receivedElement.setAttribute(<span style='color:#2a00ff; '>'style'</span>, <span style='color:#2a00ff; '>'display:block;'</span>);

        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);
    }
};</code>

<p>All we have is one object called <code>app</code> which represents - wait for it! - our PhoneGap app.
<code>initialize()</code> is the constructor. We call this directly from <code class="file">index.html</code> if you remember.
<code>initialize()</code> simply calls <code>app.bindEvents()</code> which in turn uses a DOM standard way of adding an event listener.
The event we listen for here is 'deviceready' which is fired from the PhoneGap library when our Android device
is, well, ready. We specify that this event is to be handled by <code>app.onDeviceReady()</code> which simply calls
<code>app.receivedEvent('deviceready')</code>.</p>

<p><code>app.receivedEvent('deviceready')</code> simply hides the "connecting" message and displays the "ready" message
(which are displayed and hidden, respectively, via the default <code class="file">index.css</code>).</p>

<p><code>someElement.querySelector()</code> is very interesting here and we'll look at that later.</p>

<p><code>console.log(someMessage)</code> is worth talking about now because we are going to be hammering it during development!
Basically this logs something to the browser's console without disturbing the user. 
When running your app via Eclipse's F11, <code>console.log()</code> messages that fire on the device will show up in your
Eclipse's "LogCat" thus:</p>

<div class="figure">
    <img src="img/figure/fig_20.png">
    <p>Figure 2. <code>console.log()</code> messages as appearing in Eclipse's LogCat</p>
</div>

<p>Or, if debugging in Chrome desktop, you can see it by pressing F12 on the page in question then clicking the console tab:</p>

<div class="figure">
    <img src="img/figure/fig_30.png">
    <p>Figure 3. <code>console.log()</code> messages as appearing in Chrome desktop's debugger</p>
</div>

<p><code>console.log()</code> (and there are actually some other methods) is a general JavaScript development technique that
isn't specific to mobile development. It works on all major browsers (though IE needs help!).</p>






<h2 id="first_things_first_the_layout">First things first: The layout</h2>

<p>Japxlate is going to have a single screen or "intent". It won't jump out to, for example, your phone's
camera intent or "share to" list. The single screen is going to have three tab options - Search, Discover and Write.
We want the tab navigation and current tab content to all fit on the device display without scrolling.
OK, the PhoneGap Hello World app we just looked at is a good start, but let's see what tweaks we can do.</p>

<p>The Japxlate app is a spinoff of the <a href="https://twitter.com/japxlate">@japxlate</a> Twitter channel, so let's look at that to get some design
ideas:</p>

<div class="figure">
    <img src="img/figure/fig_40.png">
    <p>Figure 4. The @japxlate Twitter channel</p>
</div>

<p>OK, so we've got a greyish background. The logo is a red 'J' on a white background. The red is our signature red
and is actually #990000. The red 'J' on a white background is going to be a good launcher icon for our app which we'll talk about in a later chapter.</p>

<p>Right, so we need three tabs and we have some colour ideas. Here's a quick wireframe:</p>

<div class="figure">
    <img src="img/figure/fig_50.png">
    <p>Figure 5. Quick wireframe of the Japxlate app layout</p>
</div>

<p>Let's put our tabs at the top so they're out of the way of our device's core Android buttons (back, home, menu / special).
Let's have a little footer and see if we need that.
The footer and header have grey backgrounds. The tab content area is bog-standard black text on a white background.
When a tab is tapped, the header and footer will stay the same (though possibly with some kind of current tab
highlight) but the content area will load the appropriate content for that tab.</p>

<p>HTML5 gives us <code>&lt;header></code> and <code>&lt;footer></code> elements, so let's try those. Change the <code>&lt;body></code> in <code class="file">index.html</code> to look like:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>body</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span>
        header
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> class=<span style='color:#2a00ff; '>"japxlate_app"</span><span style='color:#7f0055; '>></span>    <span style='color:#3f7f59; '>&lt;!--note we've changed the class name--></span>
        content area
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span>
        footer
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span>
    <span style='color:#3f7f59; '>&lt;!--&lt;script type="text/javascript" src="phonegap.js">&lt;/script>--></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript" src="js/index.js"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript"</span><span style='color:#7f0055; '>></span>
        app.initialize();
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>body</span><span style='color:#7f0055; '>></span>
</code>

<p>Fire this up on your device (or desktop Chrome) and it looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_60.png">
    <p>Figure 6. Unstyled <code>&lt;header></code> and <code>&lt;footer></code></p>
</div>

<p>Not quite what we had in mind! The <code>&lt;header></code> and <code>&lt;footer></code> are both 100% wide which is great, but we need to give them positions and heights (with tab content
taking up the remaining space inbetween). Also let's get rid of the PhoneGap background gradient and put our own background
colours in. Also let's take out the forced uppercase. Change the <code>body</code> clause in <code class="file">index.css</code> to look like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>body</span> {
    -webkit-touch-callout: none;                <span style='color:#3f7f59; '>/* prevent callout to copy image, etc when tap to hold */</span>
    -webkit-text-size-adjust: none;             <span style='color:#3f7f59; '>/* prevent webkit from resizing text to fit */</span>
    -webkit-user-select: none;                  <span style='color:#3f7f59; '>/* prevent copy paste, to allow, change 'none' to 'text' */</span>
    <span style='color:#7f0055; font-weight:bold; '>font-family</span>:<span style='color:#2a00ff; '>'</span><span style='color:#2a00ff; '>HelveticaNeue-Light</span><span style='color:#2a00ff; '>'</span>, <span style='color:#2a00ff; '>'</span><span style='color:#2a00ff; '>HelveticaNeue</span><span style='color:#2a00ff; '>'</span>, Helvetica, Arial, sans-serif;
    <span style='color:#7f0055; font-weight:bold; '>font-size</span>:12px;
    <span style='color:#7f0055; font-weight:bold; '>height</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>margin</span>:0px;
    <span style='color:#7f0055; font-weight:bold; '>padding</span>:0px;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
}</code>

<p>Then add a clause for <code>header</code> like this:</p>

<code class="multiline">header {
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#555;  <span style='color:#3f7f59; '>/*medium grey*/</span>
    <span style='color:#7f0055; font-weight:bold; '>color</span>:#ccc;             <span style='color:#3f7f59; '>/*slightly greyish white*/</span>
    <span style='color:#7f0055; font-weight:bold; '>height</span>:40px;
    <span style='color:#7f0055; font-weight:bold; '>line-height</span>:40px;       <span style='color:#3f7f59; '>/*height of a *text* line*/</span>
}</code>

<p>Then add a clause for <code>footer</code> like this:</p>

<code class="multiline">footer {
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#555;  <span style='color:#3f7f59; '>/*medium grey*/</span>
    <span style='color:#7f0055; font-weight:bold; '>color</span>:#ccc;             <span style='color:#3f7f59; '>/*slightly greyish white*/</span>
    <span style='color:#7f0055; font-weight:bold; '>height</span>:20px;
    <span style='color:#7f0055; font-weight:bold; '>line-height</span>:20px;
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_70.png">
    <p>Figure 7. <code>&lt;footer></code> is too high</p>
</div>

<p>Hmm, the footer isn't at the bottom! Let's position it absolutely and make it flush with the bottom of its parent
(the document body). Add to the <code>footer</code> rule so that it looks like:</p>

<code class="multiline">footer {
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#555;  <span style='color:#3f7f59; '>/*medium grey*/</span>
    <span style='color:#7f0055; font-weight:bold; '>color</span>:#ccc;             <span style='color:#3f7f59; '>/*slightly greyish white*/</span>
    <span style='color:#7f0055; font-weight:bold; '>height</span>:20px;             
    <span style='color:#7f0055; font-weight:bold; '>line-height</span>:20px;
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:0;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;             <span style='color:#3f7f59; '>/*no default width for position:absolute*/</span>
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_80.png">
    <p>Figure 8. <code>&lt;footer></code> flush with bottom of document body</p>
</div>

<p>Great! Now let's put our three tabs into the header. We'll do it as an unordered list of links. Make
<code>&lt;header></code> of <code class="file">index.html</code> look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>ul</span> id=<span style='color:#2a00ff; '>"tab-bar"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span> <span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#search"</span><span style='color:#7f0055; '>></span>Search<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span> <span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#discover"</span><span style='color:#7f0055; '>></span>Discover<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#write"</span><span style='color:#7f0055; '>></span>Write<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>ul</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span></code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_90.png">
    <p>Figure 9. First attempt at tabs</p>
</div>

<p>Clearly a disaster! We need some styling to line up the list items horizontally in the header.
Add the following three clauses to the CSS file:</p>

<code class="multiline"><span style='color:#3f7f59; '>/*entire tab row*/</span>
#tab-bar {
    <span style='color:#3f7f59; '>/*clear any inside and outside gap space*/</span>
    <span style='color:#7f0055; font-weight:bold; '>margin</span>:0;
    <span style='color:#7f0055; font-weight:bold; '>padding</span>:0;
}

<span style='color:#3f7f59; '>/*each tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span> {
    <span style='color:#7f0055; font-weight:bold; '>display</span>: inline;    <span style='color:#3f7f59; '>/*prevent each item from newlining*/</span>
    <span style='color:#7f0055; font-weight:bold; '>float</span>:left;         <span style='color:#3f7f59; '>/*stack left*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>: 33.3333%;    <span style='color:#3f7f59; '>/*have a third of total tab-bar space*/</span>
}

<span style='color:#3f7f59; '>/*tappable link in each tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span> <span style='color:#7f0055; font-weight:bold; '>a</span> { 
    <span style='color:#7f0055; font-weight:bold; '>color</span>: #ccc;
    <span style='color:#7f0055; font-weight:bold; '>display</span>: block;         <span style='color:#3f7f59; '>/*make "width-having"*/</span>
    <span style='color:#7f0055; font-weight:bold; '>font-weight</span>: bold;
    <span style='color:#7f0055; font-weight:bold; '>overflow</span>: hidden;       <span style='color:#3f7f59; '>/*so long link text words get cropped*/</span>
    <span style='color:#7f0055; font-weight:bold; '>text-align</span>: center;
    <span style='color:#7f0055; font-weight:bold; '>text-decoration</span>: none;  <span style='color:#3f7f59; '>/*remove default link underline*/</span>
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_100.png">
    <p>Figure 10. Tabs line up horizontally</p>
</div>

<p>Looking good! But the tabs need a few more things to look more useful. Namely, horizontal dividers,
icons and some kind of current tab highlight.
For the horizontal dividers, let's try giving the second and third tabs a left border. CSS version 2
(the latest version being 3) has a nifty selector where we can say "element type Y only where it follows an
element type X". With this we can target any tab after the first one and apply a left border. Add the
following clause to the CSS:</p>

<code class="multiline"><span style='color:#3f7f59; '>/*a border-left for the middle and rightmost tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span> + <span style='color:#7f0055; font-weight:bold; '>li</span>
{
    <span style='color:#7f0055; font-weight:bold; '>border-left</span>:1px solid #aaa;    <span style='color:#3f7f59; '>/*light grey*/</span>
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_110.png">
    <p>Figure 11. <code>&lt;header></code> too wide for document body</p>
</div>

<p>Ouch, that's not a good look. What's happened here is that the border has <em>added</em> 1px to the total width of the 
second and third tabs. These tabs are now wider than a 3rd of the <code>&lt;header></code> row and so the last tab gets
bumped onto the next line. This is A Very Annoying Thing. One cheesy little workaround for this is to
use a simple background image to simulate the border.
Make a 1 pixel wide by 16 pixel tall image in <a href="http://www.gimp.org/">GIMP</a> (or what-have-you) and floodfill with #aaaaaa which
is a very light grey. Export to a PNG image in <code class="file">assests/www/img</code> called <code class="file">aaaaaa_16_v.png</code>.
Then change the previously added CSS clause to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>/*simulate a border-left for the middle and rightmost tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span> + <span style='color:#7f0055; font-weight:bold; '>li</span>
{
    <span style='color:#7f0055; font-weight:bold; '>background-image</span>:<span style='color:#7f0055; font-weight:bold; '>url</span><span style='color:#2a00ff; '>(</span><span style='color:#3f3fbf; '>../img/aaaaaa_16_v.png</span><span style='color:#2a00ff; '>)</span>;
    <span style='color:#7f0055; font-weight:bold; '>background-repeat</span>:repeat-y;
    <span style='color:#7f0055; font-weight:bold; '>background-position</span>:left;
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_120.png">
    <p>Figure 12. <code>&lt;header></code> fits nicely</p>
</div>

<p>Pretty good! OK, we'll do the icons next. We want each tab to have a little icon on it. There are millions of icon sets floating around these days. They tend to be one of three types:</p>
<ul>
	<li>Always free</li>
	<li>Free only for personal use (else you should pay)</li>
	<li>Always paid-for</li>
</ul>

<p>There's also new school <em>flat</em> icons versus traditional deep icons. Design memes come and go but we'll go with
something a little flat. We'll use these rather nice ones which are royalty-free, free for personal and commercial use:</p>

<p><a href="http://www.graphicsfuel.com/2013/04/20-flat-icons-psd">http://www.graphicsfuel.com/2013/04/20-flat-icons-psd</a></p>

<p>Note that these icons are in PNG format which is a raster format. Raster icons are easy to use, but can only be
shrunk or enlarged by extracting or guessing information (respectively). This means they only really look good
at their <em>native</em> size which means that, depending on the pixel density of the device display, they might be too tiny
and hard to make out or really massive and Legoish. But we'll use them for simplicity.</p>

<p>One alternative would be to use a vector format - such as SVG - for the icons which stores the image such that
it can be scaled up or down without losing information.
Another new trend is to have the browser load something called an icon font. This is like a normal font but where
each character is an icon (remember Wingdings?!). This has the advantage that the icons are sizeable just like
any other text. Also they can be bolded or italicised. <strong>But</strong> they can only be of one colour.</p>

<p>Go ahead and put all of the PNG icons in <code class="file">assets/www/img</code> (though we won't use all of them).
Let's reference some of these icons in our tab markup, change <code>&lt;header></code> in <code class="file">index.html</code>
to look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>ul</span> id=<span style='color:#2a00ff; '>"tab-bar"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#search"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/search.png"</span><span style='color:#7f0055; '>></span> Search<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#discover"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/chat-bubble.png"</span><span style='color:#7f0055; '>></span> Discover<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#write"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/file.png"</span><span style='color:#7f0055; '>></span> Write<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>ul</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span></code>

<p>Note the space after the image and before the link text. Running this gives:</p>

<div class="figure">
    <img src="img/figure/fig_130.png">
    <p>Figure 13. Icons we sourced are way too big</p>
</div>

<p>Woah, those icons are pretty big eh? The icons are a mix of square, tall or wide, but they all have a biggest
side of about 128 pixels. That's clearly way too big for us here. Let's use GIMP to resize <code class="file">search.png</code>,
<code class="file">chat-bubble.png</code> and <code class="file">file.png</code> to have a biggest side of 16px - the same as our app font size (in <code class="file">index.css</code>) [NOTETOSELF double check this].
So go ahead and make those changes and overwrite the original icon files. While you're at it, do the same
for <code class="file">paste.png</code> because we'll be using that later on. (Feel free to trash the other icon files from
<code class="file">assets/www/img</code> as we won't be needing them in this little app.) Those scalable icon formats are looking real
attractive now huh?</p>

<p>After changing the icon sizes, it looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_140.png">
    <p>Figure 14. Icons at correct size</p>
</div>

<p>Not bad at all. But hmmmm, don't you think the icons look a little out of whack? Like they're slightly
higher than the line of text? We can remedy this by adding to the CSS:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>a</span> <span style='color:#7f0055; font-weight:bold; '>img</span> {
    <span style='color:#7f0055; font-weight:bold; '>vertical-align</span>:middle;    <span style='color:#3f7f59; '>/*make more sensible relative to text baseline*/</span>
}</code>

<p>(Yes, we could do these icons as CSS background images but what the heck.) That's better.
We restrict this only to images in <code>&lt;a></code>'s so we don't screw up any other images we might
have in the markup.</p>

<p>All we need now is a highlight for the currently selected tab, and while we're at it we should
choose our default tab that we want to be displayed first on app load. Let's plump for the
Search tab. Add a class name of "current" to the Search tab thus:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>ul</span> id=<span style='color:#2a00ff; '>"tab-bar"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#search"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/search.png"</span><span style='color:#7f0055; '>></span> Search<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
    &vellip;
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>ul</span><span style='color:#7f0055; '>></span></code>

<p>Then, in the CSS, modify <code>#tab-bar li{}</code> and add <code>#tab-bar li.current{}</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>/*each tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span> {
    <span style='color:#7f0055; font-weight:bold; '>display</span>: inline;
    <span style='color:#7f0055; font-weight:bold; '>float</span>:left;
    <span style='color:#7f0055; font-weight:bold; '>width</span>: 33.3333%;
    <span style='color:#7f0055; font-weight:bold; '>border-bottom</span>:3px solid #555;   <span style='color:#3f7f59; '>/*same bg as header*/</span>
}

<span style='color:#3f7f59; '>/*current tab*/</span>
#tab-bar <span style='color:#7f0055; font-weight:bold; '>li</span>.current {
    <span style='color:#7f0055; font-weight:bold; '>border-bottom</span>:3px solid #990000;    <span style='color:#3f7f59; '>/*signature red*/</span>
}</code>

<p>We simply add a bottom border, in our signature red, to any tab bar list item that has a class of "current". 
We also add a border of the same size but using the header's background colour to <em>non</em> current tabs.
This keeps everything looking flush horizontally. Later on (soon actually!) we will use JavaScript
to detect tap events on the tabs and change the current tab. Running what you have so far looks like:</p>

<div class="figure">
    <img src="img/figure/fig_150.png">
    <p>Figure 15. Current tab highlight</p>
</div>

<p>Pretty good! Only two little things are bugging us now. The content area text starts a little too
close to the tab bar, and, thinking about it this app doesn't really need a footer at all!
Change the HTML footer to simply look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span></code>

<p>Then add <code>.japxlate_app{}</code> to CSS and also change the height of <code>footer{}</code> thus:</p>

<code class="multiline">.japxlate_app {
    <span style='color:#7f0055; font-weight:bold; '>padding-top</span>:1em;        <span style='color:#3f7f59; '>/*move content away from tab bar*/</span>
}

footer {
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#555;
    <span style='color:#7f0055; font-weight:bold; '>color</span>:#ccc;
    <span style='color:#7f0055; font-weight:bold; '>height</span>:2px;             <span style='color:#3f7f59; '>/*down to 2px from 20px*/</span>          
    <span style='color:#7f0055; font-weight:bold; '>line-height</span>:20px;       <span style='color:#3f7f59; '>/*no longer meaningful...*/</span>
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:0;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
}</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_160.png">
    <p>Figure 16. Final app layout</p>
</div>

<p>Which we'll stick with for the rest of the tutorial - and app! We have a 2px footer which is
a bit gimmicky, but will help us a bit with scroll debugging a bit later on. The tab content text is now
one newline(ish) down from the tab bar.</p>

<div class="sidenote">
<strong>To fullscreen or not?</strong>
<p>You might have noticed by now that the default PhoneGap app, and our own app's layout that we've just finished,
fill the <em>entire</em> screen of the device. Even the Android status bar (which shows the time, battery charge and
signal strength etc) is obliterated.</p>

<p>Game apps tend to fill the entire screen, but almost every utility app out there leaves the status bar.
The good news is that we can get the status bar back quite easily by opening <code class="file">PROJECTROOT/platforms/android/res/xml/config.xml</code>
and changing:</p>

<code class="multiline">&lt;preference name="fullscreen" value="true" /></code>

<p>to</p>

<code class="multiline">&lt;preference name="fullscreen" value="false" /></code>

<p>and then re-running the app.</p>

<p>You can choose which style you like and the rest of this tutorial is valid either way.
Note that figures showing device screenshots <em>won't</em> have the status bar.</p>

</div>

<h2 id="first_things_first_the_tabbing_mechanism">First things first: The tabbing mechanism</h2>

<p>The layout is in the bag now, but we need a mechanism to markup the content for our three
different tabs <strong>and</strong> a way for taps on the tabs to trigger the display of the relevent content.</p>

<p>We can markup the content for all three tabs in the HTML file and simply have Discover and Write
hidden (Search is our default remember) with CSS when the app first starts. Let's do this first before we
look at any JavaScript. Edit <code>&lt;div class="japxlate_app"></code> in <code class="file">index.html</code> so that it's contents are like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> class=<span style='color:#2a00ff; '>"japxlate_app"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"tab-content"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"search"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
            search tab content. search tab content. search tab content.
            search tab content. search tab content. search tab content.
            search tab content. search tab content. search tab content.
            search tab content. search tab content. search tab content.
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"discover"</span><span style='color:#7f0055; '>></span>
            discover tab content. discover tab content. discover tab content.
            discover tab content. discover tab content. discover tab content.
            discover tab content. discover tab content. discover tab content.
            discover tab content. discover tab content. discover tab content.
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"write"</span><span style='color:#7f0055; '>></span>
            write tab content.write tab content. write tab content.
            write tab content.write tab content. write tab content.
            write tab content.write tab content. write tab content.
            write tab content.write tab content. write tab content.
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>	

<p>Then let's default to hidden, but with <code>class="current"</code> being visible for these <code>&lt;div></code>s in <code>#tab-content</code>. Add the following two clauses to <code class="file">index.css</code>:</p>

<code class="multiline">#tab-content > <span style='color:#7f0055; font-weight:bold; '>div</span>.current {
    <span style='color:#7f0055; font-weight:bold; '>display</span>:block;
}

#tab-content > <span style='color:#7f0055; font-weight:bold; '>div</span> {
    <span style='color:#7f0055; font-weight:bold; '>display</span>:none;
}</code>

<p>Hmm, well running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_170.png">
    <p>Figure 17. Tab content spills over the footer</p>
</div>

<p>Search tab is indeed the only visible tab, but if there is a lot of content then it overflows and goes past the footer!
This will cause our PhoneGap app to be swipe scrollable which is a bad thing! To fix this, let's see what the
<code>.japxlate_app</code> master container <code>&lt;div></code> is doing in relation to the footer when it has both little and lots of content.
For that let's add this cheeky little debug to the <code>.japxlate_app{}</code> CSS:</p>

<code class="multiline">.japxlate_app {
    <span style='color:#7f0055; font-weight:bold; '>padding-top</span>:1em;        
    <span style='color:#7f0055; font-weight:bold; '>border</span>:1px solid green; <span style='color:#3f7f59; '>/*debug*/</span>
}</code>

<p>This puts a thin green border around the entire div. This is a useful debugging tool <strong>but</strong> note that it will
add two pixels to the width and two pixels to the height of the div it is applied to. This may make scrollbars
appear where usually you wouldn't have scrollbars.</p>

<p>Running with both large and small amounts of content looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_180.png">
    <p>Figure 18. Size of <code>.japxlate_app</code> div with large (left) and small (right) content amounts</p>
</div>

<p>So it looks like our master container div doesn't have a fixed height and is as tall as it needs to be for its content.
We want it to be exactly tall enough to fit perfectly under the header and above the footer.
Then, if content is lots and it overspills, it will clip above the footer and won't screw up our app's look and
feel. We may then choose to handle content scrolling manually.</p>

<p>Our <code>.japxlate_app</code> master container div has the same parent as the header and footer (ie. <code>&lt;body></code>) so
we should be able to position it absolutely, tinker with CSS top and bottom properties and "slot"
it in between the header and footer. Let's change the CSS for <code>.japxlate_app</code> to look like this:</p>

<code class="multiline">.japxlate_app {
    <span style='color:#7f0055; font-weight:bold; '>padding-top</span>:1em;
    <span style='color:#7f0055; font-weight:bold; '>border</span>:1px solid green;
    <span style='color:#7f0055; font-weight:bold; '>overflow</span>:auto;          <span style='color:#3f7f59; '>/*scrolling functionality *IF* we need it*/</span>
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>top</span>:43px;               <span style='color:#3f7f59; '>/*flush with bottom of header*/</span>
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:2px;             <span style='color:#3f7f59; '>/*flush with top of footer*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
}</code>

<p>Note that we're keeping the debug green border for the moment. Running the app now looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_190.png">
    <p>Figure 19. Improved <code>.japxlate_app</code> div with large (left) and small (right) content amounts</p>
</div>

<p>For the win! Notice how (on desktop Chrome only) we only get the scrollbar when we need it. Notice also how it's a scrollbar
just for the content div and not a full scrollbar for the entire document. This is great for our app
because users won't be able to whiz it around the screen like a normal browser page. As we'll see later though,
we will annoyingly have to implement our own scrolling for this content pane on the device. Go ahead and strip out that
<code>border:1px solid green;</code> statement for the <code>.japxlate_app{}</code> rule.</p>

<p>You must be exhausted with CSS things now (I know I am!), so let's move on to the very last first thing
(say what?!) - which is the behaviour for the tab tapping which we'll implement in good ol' JavaScript.
We need to do two things here:</p>

<ol>
<li>Detect a tap on a tab</li>
<li>Load / display content for that tab (hiding the previous tab's content at the same time)</p>
</ol>

<p>If you've been debugging the app in Chrome so far (I have!), here's where we hit a tiny stumbling block.
If you remember our default <code class="file">index.js</code>, all of the magic happens after we catch the <code>deviceready</code> event.
This is a PhoneGap event that desktop browsers won't fire. An advanced way to get around this would
be to look at something like <a href="https://github.com/alunny/stopgap">Stopgap</a> (though, at the time of writing, this is looking a bit tumbleweedy)
or, more straightforwardly, some hacks like at <a href="http://stackoverflow.com/questions/6687099/how-to-fire-deviceready-event-in-chrome-browser-trying-to-debug-phonegap-projec">http://stackoverflow.com/questions/6687099/how-to-fire-deviceready-event-in-chrome-browser-trying-to-debug-phonegap-projec</a>.
</p>

<p>What we want to do, for desktop browsers, is to <strong>not</strong> load <code class="file">phonegap.js</code>. Then, instead of waiting
for the <code>deviceready</code> event to execute our x_y_z(), we simply call x_y_z() as soon as the browser DOM is ready.
Let's use the solution by Chemik at the aforementioned StackOverflow page to only load <code class="file">phonegap.js</code>
on condition of being on a mobile device. We can do this in <code class="file">index.html</code> thus:</p>

<code class="multiline">&vellip;
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>footer</span><span style='color:#7f0055; '>></span>
<span style='color:#3f7f59; '>&lt;!--load phonegap.js only if on mobile device--></span>
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; font-weight:bold; '>if</span> (navigator.userAgent.<span style='color:#7f0055; font-weight:bold; '>match</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>(</span><span style='color:#2a00ff; '>iPhone</span><span style='color:#2a00ff; '>|</span><span style='color:#2a00ff; '>iPod</span><span style='color:#2a00ff; '>|</span><span style='color:#2a00ff; '>iPad</span><span style='color:#2a00ff; '>|</span><span style='color:#2a00ff; '>Android</span><span style='color:#2a00ff; '>|</span><span style='color:#2a00ff; '>BlackBerry</span><span style='color:#2a00ff; '>|</span><span style='color:#2a00ff; '>IEMobile</span><span style='color:#2a00ff; '>)</span><span style='color:#2a00ff; '>/</span>)) {
        <span style='color:#7f0055; font-weight:bold; '>var</span> line = <span style='color:#2a00ff; '>'&lt;script type="text/javascript" src="phonegap.js"'</span> + <span style='color:#2a00ff; '>'>&lt;/'</span>+<span style='color:#2a00ff; '>'script>'</span>;
        document.writeln(line);
    }
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
&vellip;</code>

<p>Note that we break up the ending <code>&lt;/script></code> in our string so that it isn't picked up by 
the (WebView) browser - or our IDE - as an <em>actual</em> ending script tag!
This code will now only load <code class="file">phonegap.js</code> for mobile devices. You can test this by - carefully! - inserting
a cheeky <code>alert('I am phonegap.js');</code> right at the top of <code class="file">phonegap.js</code>. Don't forget to remove this alert when you've
finished testing!</p>

<p>So now we only have <code class="file">phonegap.js</code> loaded on an actual mobile device. This gives us a little tool to help
with the <code>deviceready</code> event problem. Edit <code>bindEvents()</code> and <code>receivedEvent()</code> in <code class="file">index.js</code> to look like this:</p>

<code class="multiline">&vellip;
<span style='color:#3f7f59; '>// Bind Event Listeners</span>
<span style='color:#3f7f59; '>//</span>
<span style='color:#3f7f59; '>// Bind any events that are required on startup. Common events are:</span>
<span style='color:#3f7f59; '>// 'load', 'deviceready', 'offline', and 'online'.</span>
bindEvents: <span style='color:#7f0055; font-weight:bold; '>function</span>() {
    <span style='color:#7f0055; font-weight:bold; '>if</span> (window.cordova) {   <span style='color:#3f7f59; '>//actual app</span>
        document.addEventListener(<span style='color:#2a00ff; '>'deviceready'</span>, <span style='color:#7f0055; font-weight:bold; '>this</span>.onDeviceReady, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    } <span style='color:#7f0055; font-weight:bold; '>else</span> {    <span style='color:#3f7f59; '>//debugging in desktop browser</span>
        <span style='color:#7f0055; font-weight:bold; '>this</span>.onDeviceReady();
    }
},

<span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);
},
&vellip;</code>

<p>If <code class="file">phonegap.js</code> is loaded, it will define the <code>window.cordova</code> object which we can test for before setting up
our event listener. If <code class="file">phonegap.js</code> is not loaded, we simply call what the listener calls anyway.
Running this in both desktop Chrome and your device should produce the eventual <code>console.log()</code> message
(you'll see this via Eclipse's <em>LogCat</em> if running on your device).</p>


<div class="sidenote">
<strong>All about alerts (and PhoneGap API plugins)</strong>
<p>Since we're talking about debugging and JavaScript <code>alert()</code>s and things, let's talk about how we can use
PhoneGap to produce more native-like alerts. JavaScript alerts will definitely give your app that
non-nativey, browser app feel. In fact, using <code>alert()</code> even on desktop sites is considered a bit naff
these days!</p>

<p>Conveniently, PhoneGap exposes a Notification API for "Visual, audible, and tactile device notifications."
The documentation at <a href="http://docs.phonegap.com/en/3.1.0/cordova_notification_notification.md.html">http://docs.phonegap.com/en/3.1.0/cordova_notification_notification.md.html</a> says we can use it like
this:</p>
<code class="multiline">navigator.notification.alert(message, alertCallback, [title], [buttonName]);</code>
<p>So let's try that. Stick <code>navigator.notification.alert('Some alert message', null);</code> in the <code>receivedEvent()</code> function that we were just tinkering with. Running this (which obviously won't work in desktop Chrome) gives a spurious error
in LogCat:</p>

<div class="figure">
    <img src="img/figure/fig_200.png">
    <p>Figure 20. Error when attempting <code>navigator.notification.alert()</code></p>
</div>

<p>What's going on? Well, it turns out that "As of version 3.0, Cordova implements device-level APIs as plugins".
We have to install whichever APIs we want in our project. This removes bloat as, previously, all
APIs came pre-installed in every PhoneGap project.
I actually found this to be a bit mysterious and poorly documented (I found myself mashing up a mix
of info from Cordova docs and PhoneGap docs). But here's how to add a particular plugin to your PhoneGap
project. Go to anywhere in your project folder structure on the command line and:</p>

<code class="terminal"><span>you@yours$ japxlate]$</span> phonegap local plugin add https://git-wip-us.apache.org/repos/asf/cordova-plugin-dialogs.git</code>
<p class="new_3_3_0">(From PhoneGap v3.3.0 you can simply type <code>phonegap local plugin add org.apache.cordova.dialogs</code>)</p>
<p>Which should echo:</p>

<code class="terminal"><span style="color:cyan;">[phonegap]</span> adding the plugin: https://git-wip-us.apache.org/repos/asf/cordova-plugin-dialogs.git
<span style="color:cyan;">[phonegap]</span> successfully added the plugin</code>

<p>(Note that you won't need to run this command, and you won't get the above error, if you've gone down <a href="#getting_started_ii">The fiddly older way</a> as that bundles all plugins into your project).</>

<p>You'll get the relevant URL from the docs for whichever plugin at the "API Reference" section at <a href="http://docs.phonegap.com/en/3.1.0/">http://docs.phonegap.com/en/3.1.0/</a>
(PhoneGap has a good list of core and 3rd party plugins at <a href="https://build.phonegap.com/plugins">https://build.phonegap.com/plugins</a> but the installation
instructions for each one are seemingly out-of-date and mention tinkering with XML config files
which we don't need to do after running the above command.)
The above command has downloaded the source for the plugin and put it in <code class="file">/assets/www/plugins</code> (in this case in 
<code class="file">org.apache.cordova.dialogs</code>) <span class="new_3_3_0">(but diff on v3.3.0 etc)</span>. It has also added references to the plugin in <code class="file">/assets/www/cordova_plugins.js</code>
 - a file which has been there from the start but just as a placeholder stub.
The <code class="file">phonegap.js</code> that we include in our <code class="file">index.html</code> actually also includes <code class="file">cordova_plugins.js</code> so after running the
above command, we have all we need to start using <code>navigator.notification.alert()</code>! Try it again! It works!:</p>

<div class="figure">
    <img src="img/figure/fig_210.png">
    <p>Figure 21. Default <code>navigator.notification.alert()</code></p>
</div>

<p>Great. But hmmm, it looks just the same as a normal JavaScript <code>alert()</code>! Currently it does yes, but the advantage is that we can
customise the title and button text. We can also specify a callback function to trigger when the button is tapped.
Try:</p>

<code class="multiline">navigator.notification.alert('Some alert message', null, 'The title', 'Oki doki');</code>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_220.png">
    <p>Figure 22. Customised <code>navigator.notification.alert()</code></p>
</div>

<p>For the win! If you want to go forward with these customised alerts, keep in mind that they
won't work on desktop Chrome so you may need to write a little wrapper function to still be able to debug on desktop Chrome.
The Japxlate app won't be alerting <em>anything</em> to the user on purpose - perhaps just some important error
messages. Therefore we'll go forward in this tutorial with plain vanilla JavaScript <code>alert()</code>s. But I wanted to show you the general plugin mechanism
on what is no doubt one of the easier to use plugins. In fact, I'm not done yet!:</p>

<code class="terminal"><span>you@yours$ japxlate]$</span> phonegap local plugin list
<span style="color:cyan;">[phonegap]</span> org.apache.cordova.dialogs</code>

<p>This command lists all plugins installed in the current project.</p>

<code class="terminal"><span>you@yours$ japxlate]$</span> phonegap local plugin remove org.apache.cordova.dialogs
<span style="color:cyan;">[phonegap]</span> removing the plugin: org.apache.cordova.dialogs
<span style="color:cyan;">[phonegap]</span> successfully removed the plugin</code>

<p>This command removes the specified plugin from the current project. You specify the plugin by its
reverse-DNS identifier. You can find these out by issuing the above "list" command.</p>

<p>There are plugins to access the mobile device's camera,
accelerometer, phone contacts and many more.
Using these plugins is how we make a <em>full fat</em> mobile
app and not just a simple website-in-a-box.</p>

<p class="new_3_3_0">PhoneGap v3.3.0 also has "Plugman" which is another way of working with plugins.
Plugman lets you add or remove plugins for <em>one specific platform</em>, whereas the above method will add or remove plugins globally
to any and all platforms used in the project. Please see <a href="http://docs.phonegap.com/en/3.3.0/plugin_ref_plugman.md.html">http://docs.phonegap.com/en/3.3.0/plugin_ref_plugman.md.html</a>.</p>

</div>


<p>We've just been able to simulate our <code>deviceready</code> event on desktop Chrome for debugging and we are
ready to get our tab taps working.
<code>receivedEvent()</code> in <code class="file">index.js</code> is where the magic happens because by the time we reach there, the device
is ready (and the browser DOM is ready as we've put JavaScript includes at the <em>bottom</em> of our HTML).
But let's not go down the route of stuffing all of our JavaScript in <code class="file">index.js</code>. Let's go modular - right
from the start. Create a new JavaScript file called:</p>

<code class="file">japxlate.js</code>

<p>in <code class="file">/assets/www/js</code></p>

<p>and include it from <code class="file">index.html</code> thus:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript" src="js/japxlate.js"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript" src="js/index.js"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script type="text/javascript"</span><span style='color:#7f0055; '>></span>
    app.initialize();
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span></code>

<p>Put a function called <code>configureTabs()</code> in the newly created <code class="file">japxlate.js</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//tab clickability</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureTabs()
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> tabs = document.querySelectorAll(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>#tab-bar li a</span><span style='color:#2a00ff; '>"</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>for</span>(<span style='color:#7f0055; font-weight:bold; '>var</span> loop = 0; loop &lt; tabs.length; loop++)
    {
        <span style='color:#7f0055; font-weight:bold; '>var</span> tab = tabs.<span style='color:#7f0055; font-weight:bold; '>item</span>(loop);
        tab.addEventListener(<span style='color:#2a00ff; '>'click'</span>, <span style='color:#7f0055; font-weight:bold; '>function</span>(event){alert(event + <span style='color:#2a00ff; '>' on '</span> + <span style='color:#7f0055; font-weight:bold; '>this</span>);}, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    }
}</code>

<p>Then modify <code class="file">index.js</code> to call this new function in <code>receivedEvent()</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);

    configureTabs();
},</code>

<p>Running this, and clicking on one of the tabs results in:</p>

<div class="figure">
    <img src="img/figure/fig_230.png">
    <p>Figure 23. Debug <code>alert()</code> after clicking Discover tab</p>
</div>

<p>We are nearly there! We are detecting tab taps nicely! First let me explain some key points of
the <code>configureTabs()</code> function so far.</p>

<code class="multiline">document.querySelectorAll("#tab-bar li a");</code>

<p>This is a great new piece of modern JavaScript that returns to us an array of DOM elements (a "NodeList")
that match our CSS style selector. (The related <code>querySelector()</code> returns the <em>first</em> matching element.)
This is something that has found its way into W3C standard DOMJavaScript based on something
that jQuery has popularised (but not invented - Behaviour.js (<a href="http://bennolan.com/behaviour">http://bennolan.com/behaviour</a>) was
one of the first to do this).</p>

<p>Here we run <code>querySelectorAll()</code> on the document object so we are going to get all matches contained in &lt;body>.
Usefully, it can also be run on an Element object - for example a certain table or form - or a DocumentFragment
element to only return matching elements in that particular container element.
<code>#tab-bar li a</code> is a CSS style query for "an &lt;a> in a &lt;li> in any element with id 'tab-bar'".</p>

<p>We loop over all matching &lt;a> elements and set a click handler using the DOM standard <code>addEventListener()</code>
(as formally described at <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-registration">http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-registration</a>).
Our event handler in this case is a simple anonymous function giving a debug alert.
In event handler functions, an Event object is passed as a parameter and contains information about
the particular event that triggered the handler - screen x and y coordinates for mouse events and which key was
pressed for keyboard events and so on. In event handler functions, <code>this</code> refers to the element on which
the event happened.</p>

<p>Let's replace the dummy click handler with something that we'll actually want to use. 
But first, remember that in the click handler function we only have the event object and the &lt;a> object (as <code>this</code>)?
We'll also need to know which content &lt;div> relates to which &lt;a>, then we can switch the content
accordingly.
Modify the header of <code class="file">index.html</code> to look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>ul</span> id=<span style='color:#2a00ff; '>"tab-bar"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#search"</span> data-div-id=<span style='color:#2a00ff; '>"search"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/search.png"</span><span style='color:#7f0055; '>></span> Search<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#discover"</span> data-div-id=<span style='color:#2a00ff; '>"discover"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/chat-bubble.png"</span><span style='color:#7f0055; '>></span> Discover<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> href=<span style='color:#2a00ff; '>"#write"</span> data-div-id=<span style='color:#2a00ff; '>"write"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/file.png"</span><span style='color:#7f0055; '>></span> Write<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>li</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>ul</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>header</span><span style='color:#7f0055; '>></span></code>

<p>HTML5 allows us to use custom or "data" attributes where we can add any attribute and value we like
to any particular element. The attribute names start with "data-".
Here we simply link each &lt;a> to its matching content div id. We'll use this attribute (soon)
in the click handler for tabs.</p>

<p>OK, next strip out the dummy handler from <code>addEventListener()</code> and make it look like this:</p>

<code class="multiline">tab.addEventListener('click', onclickForTab, false);</code>

<p>This will call the <code>onclickForTab()</code> function as a click handler. We define the <code>onclickForTab()</code> function, in <code class="file">japxlate.js</code>
thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//set up and display a newly tapped tab</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> onclickForTab(event)
{
    <span style='color:#3f7f59; '>//to prevent URL from changing and browse history building up</span>
    event.preventDefault();
    
    <span style='color:#3f7f59; '>//-------tab display logic---</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> lastTab = document.querySelector(<span style='color:#2a00ff; '>'li.current a'</span>);
    
    <span style='color:#3f7f59; '>//NOP if clicking current tab again</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(lastTab == <span style='color:#7f0055; font-weight:bold; '>this</span>)
    {
        <span style='color:#7f0055; font-weight:bold; '>return</span> <span style='color:#7f0055; font-weight:bold; '>false</span>;
    }
    
    lastTab.parentNode.className = <span style='color:#2a00ff; '>''</span>; <span style='color:#3f7f59; '>//undisplay</span>
    
    <span style='color:#7f0055; font-weight:bold; '>this</span>.parentNode.className = <span style='color:#2a00ff; '>'current'</span>;
    <span style='color:#3f7f59; '>//---------------------------</span>
    
    <span style='color:#3f7f59; '>//-----content div display logic---</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> lastDiv = document.querySelector(<span style='color:#2a00ff; '>'div.current'</span>);
    lastDiv.className = <span style='color:#2a00ff; '>''</span>; <span style='color:#3f7f59; '>//undisplay</span>
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> matchingDiv = <span style='color:#7f0055; font-weight:bold; '>this</span>.getAttribute(<span style='color:#2a00ff; '>'data-div-id'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> thisDiv = document.getElementById(matchingDiv);
    
    thisDiv.className = <span style='color:#2a00ff; '>'current'</span>;
    <span style='color:#3f7f59; '>//-----------</span>
    
    <span style='color:#3f7f59; '>//get tab div id from tab link</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> divId = <span style='color:#7f0055; font-weight:bold; '>this</span>.getAttribute(<span style='color:#2a00ff; '>'data-div-id'</span>);
}</code>

<p>Let's go through this code, which looks fiddly at first, but basically tinkers with CSS class names
such that things turn on and off as we want.</p>

<p>The first thing we do is the DOM standard <code>preventDefault()</code> which prevents the browser's
default action for the event from triggering. The default browser action for clicking
on a link is to:</p>

<ol>
<li>Change URL in address bar to that of link target</li>
<li>Add new URL to browsing history</li>
<li>Load new URL</li>
</ol>

<p>As our links are simply triggers to load tabs and not <em>proper</em> links, we don't want any
of these steps to happen. Step [2] is especially annoying. If we don't call <code>preventDefault()</code> for our tab taps,
if we open our app and click on the tabs ten times, we will have to use the device's BACK button
ten times to exit the app!</p>

<p>Next we use <code>querySelector()</code> to get the <em>single</em> current tab link. Because 'this' in our click handler
will be the cliked element, we can do a check to see if this is the same as the previous current tab.
And if so, do a "no operation" (NOP). We then manipulate classnames to activate only the clicked tab.</p>

<p>Similarly, we use <code>querySelector()</code> to get the currently active content div. We activate the content
div for the clicked tab by retreiving data-div-id from the clicked &lt;a> and using that to
get the correct div.</p>

<p>Anyway, this all works!</p>

<div class="figure">
    <img src="img/figure/fig_240.png">
    <p>Figure 24. Initial <code>configureTabs()</code> is working well</p>
</div>

<p>Thinking deeper and keeping an open mind, there's more to our tabs than just displaying the relevant
content. A given tab might have to do some one-off initialising of a resource - perhaps a database.
Or some per-load checking of, eg, network availability on the device. We also might like to add new tabs
in future as users request more features. We might simply just want to change the default tab based on
user complaints!</p>

<p>We can cover all of these bases with a few simple steps. First, alter the bottom of <code>onclickForTab()</code>
to look like:</p>

<code class="multiline">&vellip;
    <span style='color:#3f7f59; '>//get tab div id from tab link</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> divId = <span style='color:#7f0055; font-weight:bold; '>this</span>.getAttribute(<span style='color:#2a00ff; '>'data-div-id'</span>);

    onclickForNamedTab(divId);
}</code>

<p><code>onclickForTab()</code> is a generic handler for any tab tap, but we are adding <code>onclickForNamedTab()</code> to handle
tab specific initialisation. Put <code>onclickForNamedTab()</code> in <code class="file">japxlate.js</code> and it looks like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Do the one-off loading and everytime setup for whichever tab</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> onclickForNamedTab(divId)
{
    <span style='color:#7f0055; font-weight:bold; '>if</span>(divId == <span style='color:#2a00ff; '>'discover'</span>)
    {
        onclickForTab_Discover();
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span> <span style='color:#7f0055; font-weight:bold; '>if</span>(divId == <span style='color:#2a00ff; '>'search'</span>)
    {
        onclickForTab_Search();
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span> <span style='color:#7f0055; font-weight:bold; '>if</span>(divId == <span style='color:#2a00ff; '>'write'</span>)
    {
        onclickForTab_Write();
    }
}</code>

<p>We simply switch on the tab content div id, calling the appropriate <code>onclickForTab_theTab()</code>. Yes, you've guessed it,
if you want to add more tabs to the app, you will have to update this switch case (and add the corresponding 
<code>onclickForTab_theNewTab()</code>). This function is a simple dispatcher to other functions that are going
to do the actual one-off and per-load initialisations for tabs.</p>

<p>For a "one-off" initialisation, we are going to have to somehow record which tabs have been opened so far.
We'll do this using a global variable. Eek! Global variables are not current best practice for JavaScript,
but we'll do it to keep this small and simple app, er, small and simple. Put this at the top of <code class="file">japxlate.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Has the first load of each tab happened yet?</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_pagesLoaded = {discover:<span style='color:#7f0055; font-weight:bold; '>false</span>, <span style='color:#7f0055; font-weight:bold; '>search</span>:<span style='color:#7f0055; font-weight:bold; '>false</span>, write:<span style='color:#7f0055; font-weight:bold; '>false</span>};</code>

<p>We can then check - and set - these values in our <code>onclickForTab_theTabName()</code> functions that our <code>onclickForNamedTab()</code>
dispatcher calls. Let's get started with the first of these functions for our Discover tab. Put this in
 <code class="file">japxlate.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//One-off loading and each time setup for discover tab</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> onclickForTab_Discover()
{
    <span style='color:#3f7f59; '>//console.log('click on discover tab');</span>

    <span style='color:#7f0055; font-weight:bold; '>if</span>(!global_pagesLoaded.discover)
    {
        firstLoadForTab_Discover();
    }
    
    <span style='color:#3f7f59; '>//each time setup to go here</span>
}</code>

<p>We simply check if <code>global_pagesLoaded.discover</code> is false and if so call <code>firstLoadForTab_Discover()</code>.
We also have a space here for any "each time" setup of the Discover tab. Go ahead and create
functions, using this one as a template, for the Search and Write tabs (do a copy paste and then
change 'Discover' to 'Search' and 'discover' to 'search' and etc). We'll modify these functions
later if we need to.</p>

<p>OK, we still need <code>firstLoadForTab_Discover()</code> which will perform one-off initialisation for the Discover tab.
Do it like this, again in <code class="file">japxlate.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//One-off loading for discover tab</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> firstLoadForTab_Discover()
{
    <span style='color:#3f7f59; '>//console.log('first load for discover tab');</span>
    
    global_pagesLoaded.discover = <span style='color:#7f0055; font-weight:bold; '>true</span>;
    
    <span style='color:#3f7f59; '>//one-off setup to go here</span>
}</code>

<p>All we do is set <code>global_pagesLoaded.discover</code> to true so that this function does not get called again
from <code>onclickForTab_Discover()</code> when the tab is tapped a subsequent time. At the moment this is just a placeholder for whatever we might need
down the line. Like we just did for <code>onclickForTab_*()</code>, replicate this function for the Search and Write tabs.</p>

<p>If we temporarily uncomment the <code>console.log()</code> calls, running this - and clicking tabs randomly - shows that we do indeed have a first load
that fires only once and a click that fires each time.</p>

<div class="figure">
    <img src="img/figure/fig_250.png">
    <p>Figure 25. One-off tab loading is confirmed</p>
</div>

<p>Done and dusted. Money in the bank. Move along, nothing to see here&hellip;right? Well there's just one thing
missing. If you've really really been paying attention and thinking one or two steps ahead perhaps,
you may have noted that our setups (one-off and each time) for the default Search tab are only fired
if we click off that tab and then back on it. Clearly this is not useful and whichever tab is set
to be the default needs to have its setups run right off the bat.
Let's solve this problem by, on <code>deviceready</code>, calling a little function to retreive the current tab
and calling our already existing <code>onclickForNamedTab()</code> dispatcher for that tab.
Add a call to <code>initialiseDefaultTab()</code> at the bottom of <code>receivedEvent()</code> in <code class="file">index.js</code> so that it now looks
like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);
    
    configureTabs();
    
    <span style='color:#3f7f59; '>//load and show whatever we've set the initial tab to be</span>
    initialiseDefaultTab();
}</code>

<p>Then define <code>initialiseDefaultTab()</code> in <code class="file">japxlate.js</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Load and show our default initial tab</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> initialiseDefaultTab()
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> defaultTab = document.querySelector(<span style='color:#2a00ff; '>'div.current'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> divId = defaultTab.id;
    
    onclickForNamedTab(divId);
}</code>

<p>We use <code>querySelector()</code> to get whichever content div has been set as current in the HTML markup. We could in theory
select the <em>tab</em> that has been marked as current but as that will be in sync with the content div anyway it
is academic.</p>

<p>Congratulations, you have just built a working infrastructure for the Japxlate app!
This is a good starting point for <em>any</em> simple PhoneGap app.</p>





<h2 id="the_search_tab">The <em>Search</em> tab</h2>

<h3 id="the_search_tab_i">Layout and interface</h3>

<p>The Search tab - the first tab that the user will see when launching our app - is going to
be a search form for the user to search our Japanese dictionary. It will also display any and all
matching results in a scrollable area.</p>
<p>We'll have a rule that the user's search query can be in Japanese as well as English. Not only
will this increase the usefulness of our app, it will also enable a future "reversing" of the
app to be localised for Japanese speakers wanting to learn English vocabulary.
Let's have another rule that they can type the Japanese or English query into the form
in the same input box and without having to fiddle with radio buttons or other such inputs
(which are a bit old hat for search forms anyway but especially cumbersome on mobile devices).
With these rules and functionalities in mind, a wireframe of the Search tab might look like:</p>

<div class="figure">
    <img src="img/figure/fig_260.png">
    <p>Figure 26. Quick wireframe of the Search tab layout</p>
</div>


<p>OK, let's markup - and then style - the search form and the results space for dictionary queries.
Mosey on down to <a href="http://www.ajaxload.info">http://www.ajaxload.info</a> and make a "loading" spinner image (gif) for the Search tab.
I made mine use the Japxlate signature red (#990000) and a transparent background.
Download it and put it in <code class="file">/assets/www/img</code> as <code class="file">spinner.gif</code>.</p>

<p>Let's markup the form and results space - in index.html - like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"search"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"search-button"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>float</span>:right; <span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-right</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/search.png"</span><span style='color:#7f0055; '>></span>
        Search
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> id=<span style='color:#2a00ff; '>"button-spinner"</span> src=<span style='color:#2a00ff; '>"img/spinner.gif"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>visibility</span>:hidden;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>input</span> type=<span style='color:#2a00ff; '>"text"</span> id=<span style='color:#2a00ff; '>"search-query"</span> placeholder=<span style='color:#2a00ff; '>"Japanese or English"</span> size=<span style='color:#2a00ff; '>"40"</span>
           style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-left</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>br</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> id=<span style='color:#2a00ff; '>"loading-text"</span><span style='color:#7f0055; '>></span>
        [Loading core dictionary. This takes a while the first time.
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/spinner.gif"</span><span style='color:#7f0055; '>></span>]
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"results-wrapper"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"search-results"</span><span style='color:#7f0055; '>></span>
            You can search by kanji, hiragana, katakana, English or romaji!
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>

<p>We float our search button right (which means that in the markup it has to come <em>before</em> things
on the same line that would be visually to the left of it) but make it 1% (of total width) away from the edge
for nice appearance. We reuse <code class="file">search.png</code> as a button icon. We also include the <code class="file">spinner.gif</code>
that we just created but default it to <code>visibility:hidden</code>. Why not just <code>display:none</code>? Because
with <code>visibility:hidden</code>, it is hidden but still takes up space in the layout flow. This means
the layout won't "jump" when we make it appear. We'll switch this image's visibility on and off
programmatically.</p>

<p>Then we've got our text input which uses the new HTML5 <code>placeholder</code> attribute to present a hint
or instruction to the user about what kind of entry it expects. The text input is also 45% wide
with an edge spacing of 1%.</p>

<p>Why not just make both 50%? Because then they will touch in the middle which will end in tears
with big fingers on a small display!</p>

<p>We then have a "this will take a while" message and spinner that we will remove after one-off
setup is complete.</p>

<p>Finally we have a container for our search results - &lt;div id="search-results"> - which
displays a default search hint. We also have a wrapper for the search results container -
&lt;div id="results-wrapper"> - which is going to be the scroll viewport for search results.
These two divs need the following styles in <code class="file">index.css</code>:</p>

<code class="multiline">#results-wrapper {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:static;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>margin-top</span>:1em;     <span style='color:#3f7f59; '>/*space one &lt;br>(ish) from bottom of search form*/</span>
    <span style='color:#7f0055; font-weight:bold; '>overflow</span>:hidden;
}

#search-results {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:relative;  <span style='color:#3f7f59; '>/*we position this relative to its *normal* position*/</span>
    <span style='color:#7f0055; font-weight:bold; '>top</span>:0;              <span style='color:#3f7f59; '>/*but set the normal top position anyway. We will*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;         <span style='color:#3f7f59; '>/*change this top value to affect a scroll*/</span>
}</code>

<p>The keypoint here is <code>position:relative;</code> on the search-results div which means
that we will be able to position it (ie. scroll it) relative to an unmoving
parent - the results-wrapper div. Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_270.png">
    <p>Figure 27. Initial appearance of the Search tab</p>
</div>

<p>Not bad. Just two grumbles here.</p>
<ol>
<li>The height of the text area is lacking and also it's shorter
than the button. Let's even these two out. (Actually on my device the text
input and the button don't seem to be on the same baseline!)</li>
<li>Icon for search is screwy again - let's fix that like we
fixed the tab icons.</li>
</ol>

<p>In <code class="file">index.css</code>, change the existing:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>a</span> <span style='color:#7f0055; font-weight:bold; '>img</span>
{
    <span style='color:#7f0055; font-weight:bold; '>vertical-align</span>:middle;      <span style='color:#3f7f59; '>/*make more sensible relative to text baseline*/</span>
}</code>

<p>to:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>a</span> <span style='color:#7f0055; font-weight:bold; '>img</span>, <span style='color:#7f0055; font-weight:bold; '>button</span> <span style='color:#7f0055; font-weight:bold; '>img</span>
{
    <span style='color:#7f0055; font-weight:bold; '>vertical-align</span>:middle;      <span style='color:#3f7f59; '>/*make more sensible relative to text baseline*/</span>
}</code>

<p>Which covers (2). To fix (1), add this to <code class="file">index.css</code>:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>input</span>[type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text</span><span style='color:#2a00ff; '>"</span>], <span style='color:#7f0055; font-weight:bold; '>button</span> {
    <span style='color:#7f0055; font-weight:bold; '>height</span>:30px;
    <span style='color:#7f0055; font-weight:bold; '>margin</span>:0;
}</code>


<p>Running looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_280.png">
    <p>Figure 28. Improved appearance of the Search tab</p>
</div>

<p>Better!</p>


<h3 id="the_search_tab_ii">Creating the database</h3>

<p>Now, let's also have a rule to the effect of dictionary searches working even when the mobile device is
<strong>offline</strong>. That is to say the app must use some kind of local storage on the device itself or the WebView browser.
Well, it turns out that the Android WebView supports something called Web SQL which is a small,
local implementation of an SQL database (specifically SQLite) in the browser. We can load
our Japanese dictionary into a client-side database and, based on the user's search term, query
it in whichever way we need to pull out matches.</p>

<div class="sidenote">
<strong>Important note about Web SQL</strong>

<p>Web SQL is an <strong>abandoned specification</strong> (see <a href="http://www.w3.org/TR/webdatabase/">http://www.w3.org/TR/webdatabase/</a>) that W3C no longer maintain, and I <strong>do not recommend</strong> that
you use it going forward in your owns apps! W3C's beef was that it was only being implemented using SQLite - obviously
they aren't in the business of standardising a piece of vendor lock in!
For similar reasons Mozilla (ie. Firefox browser) have chosen not to implement it right from the start.
I do kind of agree that bringing a <em>heavy</em> server-side thing to the client is a bit of an
odd move. In fact, traditional SQL on the back-end is somewhat in crisis itself thesedays in the world of NoSQL
datastores. Though it is very useful for mobile apps that might not be online and need to work with some data.</p>

<strong>Why are we using it for this tutorial?</strong>
<p>Somewhat for historical reasons but also because I know it will be perfect for <em>fuzzy</em> text searching.
I know from experience that it will "just work". When using PhoneGap we are lucky too because
"Cordova provides access to both interfaces (Web SQL and something else called Web Storage) for the minority of devices that don't already support them. Otherwise the built-in implementations apply."
</p>

<strong>What would be some alternatives?</strong>
<p>Ignoring PhoneGap and the world of mobile apps, Indexed DB (a W3C standard at <a href="http://www.w3.org/TR/IndexedDB/">http://www.w3.org/TR/IndexedDB/</a>) looks
to be picking up steam. Though <a href="caniuse.com">caniuse.com</a> tells me that support is currently <em>less</em> than that of
Web SQL. Also it hasn't made its way into PhoneGap at the time of writing.
Indexed DB mirrors the more modern style of NoSQL databases more closely.</p>

<p>I hope that future versions of the app (and this tutorial) can use Indexed DB.</p>

<p class="new_3_3_0">PhoneGap v3.3.0 now supports Indexed DB, <strong>but only if the underlying WebView supports it</strong>. At the time of writing this means only Windows Phone 8 and BlackBerry 10.</p>
</div>


<p>PhoneGap's (well actually Cordova's) Web SQL docs are at <a href="http://docs.phonegap.com/en/3.1.0/cordova_storage_storage.md.html">http://docs.phonegap.com/en/3.1.0/cordova_storage_storage.md.html</a>
As you can see, it's a fairly small implementation of an SQL database. But writing for it in JavaScript
with callbacks was a novelty for this grizzled MySQL hacker!</p>

<p>OK, let's crack on now with Web SQL initialisation for the first load of the Search tab.
Stick this cheeky call - to a function we're about to create - at the bottom of <code>firstLoadForTab_Search()</code>
in <code class="file">japxlate.js</code>:</p>

<code class="multiline">tryPopulateDB();</code>

<p>Let's create this function, and other functions to do with general Web SQL setup, in a new file in <code class="file">/assets/www/js</code>
called <code class="file">websql_core.js</code>. Create this file, and the first function we'll put in it is the <code>tryPopulateDB()</code>
we've just referenced. It will look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Open / create the "Japxlate" Web SQL database and - if it's not already</span>
<span style='color:#3f7f59; '>//present - create and populate the "edict" table</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> tryPopulateDB()
{
    <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);
    
    db.transaction(checkDB);  <span style='color:#3f7f59; '>//only populate edict table if it not already exist</span>
}</code>


<p>PRO TIP: The Cordova docs on Web SQL are going to be very useful to reference when following this chapter.
They are at <a href="http://docs.phonegap.com/en/3.1.0/cordova_storage_storage.md.html">http://docs.phonegap.com/en/3.1.0/cordova_storage_storage.md.html</a>.
<span class="new_3_3_0">(The <a href="http://docs.phonegap.com/en/3.3.0/cordova_storage_storage.md.html">same page</a> for PhoneGap v3.3.0 removes the Web SQL reference, which to be honest
had at least one mistake in it, and instead points you to have a look at <a href="http://www.html5rocks.com/en/features/storage">http://www.html5rocks.com/en/features/storage</a>.)</span></p>

<p>We open a Web SQL database called Japxlate, at version 1.0, with a display name of "Japxlate DB" and
a size of 4 megabytes. I know from tinkering with the dictionary database for the <a href="https://twitter.com/japxlate">@japxlate</a> Twitter
channel that the core dictionary definitions will fit in 4 megabytes with a bit to spare.</p>

<p>Then we call <code>transaction()</code> on the returned database to run the query or queries in the
<code>checkDB()</code> function that we're about to implement.</p>

<p>Now's a good time to talk about the schema we'll use for the dictionary table. We'll call
the table "edict" as that's the name of the Japanese dictionary that powers it (at <a href="http://www.csse.monash.edu.au/~jwb/wwwjdicinf.html#dicfil_tag">http://www.csse.monash.edu.au/~jwb/wwwjdicinf.html#dicfil_tag</a>)
and the fields will be:</p>

<code>edict(id unique, kanji, kana, definition)</code>

<p>"id" will be an integer and a unique key to each record. "kanji" will hold the Chinese characters
that the word is written in. "kana" will hold the Japanese phonetic script that the word is written in.
Finally "definition" will hold one or more English language definitions for the word, separated by '/'.</p>

<p>Our <code>checkDB()</code> function needs to know if the edict table exists and is full. If not, create it and fill it.</p>

<p>The <code>checkDB()</code> function will receive a SQLTransaction object as a parameter from <code>db.transaction()</code>
Again in <code class="file">websql_core.js</code>, make <code>checkDB()</code> look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Check if "edict" table exists and has records</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> checkDB(tx)
{
    <span style='color:#3f7f59; '>//console.log('checkDB()');</span>
    tx.executeSql(<span style='color:#2a00ff; '>'SELECT COUNT(id) AS count FROM edict'</span>, [], successCheckDB, errorCheckDB);
}</code>

<p>We call <code>executeSql()</code> on the received SQLTransaction object which needs at least an SQL query 
as its first argument (and parameter values as the 2nd parameter if the query in the first argument uses parameter binding),
but can optionally take both a success and failure callback as 3rd and 4th parameter respectively.
Here we run a very simple query to get the count of rows - by id - in the edict table.
This query will throw an error if the edict table does not exist (but not if it exists and
is empty which is a condition we will knowingly ignore for this simple app).
We don't use parameter binding in this query so we provide an empty array as the 2nd parameter
simply because we need to "get" to the 3rd and 4th parameters.
We specify an error and a success callback.
Should the query fail we can assume that the table does not exist and therefore needs
to be created and populated. Let's look at the success callback first as it's simpler
and only has to clear the "database loading" message:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if checkDB() succeeds - ie. "edict" table present and full</span>
<span style='color:#3f7f59; '>//SO clear the "database loading" message</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successCheckDB(tx, results)
{
    <span style='color:#3f7f59; '>//console.log('edict already loaded');</span>
    document.getElementById(<span style='color:#2a00ff; '>'loading-text'</span>).innerHTML = <span style='color:#2a00ff; '>''</span>;
}</code>

<p>Pretty easy and not worth explaining other than to point out that the callback function
receives an SQLTransaction and an SQLResultSet object respectively.</p>

<p>Let's get started on the error callback:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if checkDB() fails - ie. no "edict" table</span>
<span style='color:#3f7f59; '>//SO create it and fill it</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> errorCheckDB(transaction, error)
{    
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'edict table not exist - will create and fill'</span>);
    
    <span style='color:#3f7f59; '>//here we need to do something to fill the table</span>
}</code>


<p>This code so far will run without errors (but don't forget include <code class="file">websql_core.js</code> from <code class="file">index.html</code> (above the <code class="file">japxlate.js</code> include)) but won't do anything useful. It will get to the "edict table not exist - will create and fill"
log message and then stop. In the error callback, we need to run another transaction on the Japxlate
database which will load all the dictionary data we need. Change <code>errorCheckDB()</code> to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if checkDB() fails - ie. no "edict" table</span>
<span style='color:#3f7f59; '>//SO create it and fill it</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> errorCheckDB(transaction, error)
{   
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'edict table not exist - will create and fill'</span>);
    
    <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);
    
    db.transaction(populateDB, errorWebSQL, successPopulate);
}</code>

<p>We open the same Japxlate database and try to run the <code>populateDB()</code> queries on it. We have new
success and error callbacks. <code>populateDB()</code> looks like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Create and fill the "edict" table</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> populateDB(tx)
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'creating and filling edict table'</span>);
    
    <span style='color:#3f7f59; '>//DROP if present (ie. because it's present but empty)</span>
    tx.executeSql(<span style='color:#2a00ff; '>'DROP TABLE IF EXISTS edict'</span>);
    
    <span style='color:#3f7f59; '>//create</span>
    tx.executeSql(<span style='color:#2a00ff; '>'CREATE TABLE IF NOT EXISTS edict(id unique, kanji, kana, definition)'</span>);
    
    websqlEdictInserts(tx); <span style='color:#3f7f59; '>//see websql_edict_inserts.js</span>
}</code>

<p>We create the table according to our schema - DROPing it first just in case and so the CREATE doesn't fail.
Finally we call <code>websqlEdictInserts()</code> which is a function we'll put in another JavaScript file. The <code>websqlEdictInserts()</code> function
accepts an SQLTransaction object and essentially runs a huge list of INSERT queries on it to populate our
table. This function isn't very <em>do-at-home</em>able because it's basically a dump of the most common words
from the <a href="https://twitter.com/japxlate">@japxlate</a> Twitter feed's database. If you are following this tutorial step by step, please
get the file <code class="file">/js/websql_edict_inserts.js</code> from the app's GitHub repository and stick it in your <code class="file">/assets/www/js</code> folder. To explain
it a little bit more, here's an excerpt from <code class="file">/js/websql_edict_inserts.js</code>:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> websqlEdictInserts(tx)
{
    tx.executeSql(<span style='color:#2a00ff; '>'INSERT INTO edict(id, kanji, kana, definition) VALUES(5,"咖哩","カレー","/curry/rice and curry/")'</span>);
    tx.executeSql(<span style='color:#2a00ff; '>'INSERT INTO edict(id, kanji, kana, definition) VALUES(21,"擤む","かむ","/to blow (one</span><span style='color:#2a00ff; '>\'</span><span style='color:#2a00ff; '>s nose)/")'</span>);
    tx.executeSql(<span style='color:#2a00ff; '>'INSERT INTO edict(id, kanji, kana, definition) VALUES(119,"１０００円","せんえん","/1000 yen/")'</span>);
    tx.executeSql(<span style='color:#2a00ff; '>'INSERT INTO edict(id, kanji, kana, definition) VALUES(138,"１割","いちわり","/ten percent/")'</span>);
    &vellip;
}</code>

<p>Note that the ID numbers aren't in sequence because these words are the most common 20,000 or so words
from <a href="https://twitter.com/japxlate">@japxlate</a>'s Edict dictionary which has nearly 200,000 entries!</p>

<p>OK, that's <code>populateDB()</code> in the bag. But don't forget <code>errorCheckDB()</code>'s custom error and success callbacks.
Let's do the error callback first:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Generic SQLError handler (for both db.transaction() and tx.executeSQL())</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> errorWebSQL(transactionOrError, errorOrNull)
{   
    <span style='color:#7f0055; font-weight:bold; '>var</span> error = <span style='color:#7f0055; font-weight:bold; '>null</span>;
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(<span style='color:#7f0055; font-weight:bold; '>typeof</span> transactionOrError == <span style='color:#2a00ff; '>'SQLTransaction'</span>) {    <span style='color:#3f7f59; '>//from tx.executeSQL()</span>
        error = errorOrNull;
    } <span style='color:#7f0055; font-weight:bold; '>else</span> {    <span style='color:#3f7f59; '>//from db.transaction()</span>
        error = transactionOrError;
    }
    
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(error); <span style='color:#3f7f59; '>//error is now an SQLError object</span>
    
    alert(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Error processing SQL: </span><span style='color:#2a00ff; '>"</span> + error.code);
}</code>

<p>Ouch! This looks a bit over-complicated. What's going on? Well, I didn't realise at first,
and I only discovered it on a hunch, but we can reference error callbacks from both
the database.transaction() and transaction.executeSQL() methods (as we are already doing) but <strong>in each case they will receive different parameters!</strong>.
The PhoneGap / Cordova docs for the Web SQL API - at the time of writing - don't seem to realise this
and actually are therefore incorrect.
<span class="new_3_3_0">(The PhoneGap v3.3.0 docs remove the entire Web SQL reference section.)</span>
This is something of a generic error callback and so we pull some strings to handle both cases.
Error callbacks as called from database.transaction() will receive (SQLError), and error callbacks
called from transaction.executeSQL() will receive (SQLTransaction, SQLError).
</p>

<p>We simply alert out the code property of the received SQLError object.
This is going to be our recyclable Web SQL error handler going forward with the app.</p>

<p>The success callback for <code>errorCheckDB()</code> is going to do the same as the success callback for <code>checkDB()</code>
(which is <code>successCheckDB()</code>):</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if errorCheckDB() succeeds - ie. "edict" table populated OK</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successPopulate()
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'finished loading edict'</span>);
    document.getElementById(<span style='color:#2a00ff; '>'loading-text'</span>).innerHTML = <span style='color:#2a00ff; '>''</span>;
}</code>

<p>Include <code class="file">websql_edict_inserts.js</code> from <code class="file">index.html</code> (above the include for <code class="file">websql_core.js</code>) and we are ready to go for a spin!</p>

<p>On first run, the "database loading" message and spinner take a few seconds to disappear,
and the log messages indicate database loading success. It looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_290.png">
    <p>Figure 29. First run of app with Web SQL database loading</p>
</div>

<p>Go ahead and run the app again after exiting it, the 2nd time around feels kind of faster right? Let's check the logs:</p>

<div class="figure">
    <img src="img/figure/fig_300.png">
    <p>Figure 30. Second, faster run of app with Web SQL database loading</p>
</div>

<p><strong>Woah!</strong> That's right, Web SQL databases that you've created <em>persist</em> over multiple sessions
of the app (or browser). Pretty hot and tasty! This is a great reason why Web SQL, as abandoned
and awkward as it is, is really useful for mobile WebView apps as it can be used for saving things
offline.</p>

<h3 id="the_search_tab_iii">Querying the database</h3>

<p>Right, so that's the database created, the table created, and the table filled. Phew!</p>

<p>We're coming to the meat and bones of it now which is getting results from the
database based on the user's search query. This will involve a bit of work on
the frontend interface and a <em>lot</em> of work on the backend. As we are kind of frazzled
with Web SQL things right now, let's get to work on the frontend interface first.</p>

<p>Let's make a new JavaScript file in <code class="file">/assets/www/js</code> called <code class="file">search_interface.js</code> to hold anything
to do with the frontend look and feel of searching. Right, one of the main things we'll want to do
is to put search results from the database into the container div in our markup. Let's add a 
function to do this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Put the matching search results (which could be zero matches) on the page</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> putResultsOnPage(results)
{
    <span style='color:#3f7f59; '>//get search results div</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> theDiv = document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>);
    
    <span style='color:#3f7f59; '>//clear current content</span>
    theDiv.innerHTML = <span style='color:#2a00ff; '>''</span>;
    
    <span style='color:#3f7f59; '>//might be no matches</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(results.rows.length === 0)
    {
        theDiv.innerHTML = <span style='color:#2a00ff; '>'No matches found in the common words dictionary.\</span>
<span style='color:#2a00ff; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;Tweet @japxlate yourAdvancedWord for advanced word definitions.'</span>;
        buttonSpinnerVisible(<span style='color:#7f0055; font-weight:bold; '>false</span>);    <span style='color:#3f7f59; '>//stop the loading spinner</span>
        <span style='color:#7f0055; font-weight:bold; '>return</span>;
    }
    
    <span style='color:#3f7f59; '>//some results so loop through and print</span>
    <span style='color:#7f0055; font-weight:bold; '>for</span>(<span style='color:#7f0055; font-weight:bold; '>var</span> loop = 0; loop &lt; results.rows.length; loop++)
    {
        <span style='color:#7f0055; font-weight:bold; '>var</span> <span style='color:#7f0055; font-weight:bold; '>item</span> = results.rows.<span style='color:#7f0055; font-weight:bold; '>item</span>(loop);
        
        <span style='color:#7f0055; font-weight:bold; '>var</span> var theRomaji = item.kana;    //TODO
        
        <span style='color:#7f0055; font-weight:bold; '>var</span> formattedDefinition = format_slashes(<span style='color:#7f0055; font-weight:bold; '>item</span>.definition);
        
        <span style='color:#7f0055; font-weight:bold; '>var</span> defText = <span style='color:#7f0055; font-weight:bold; '>item</span>.kanji + <span style='color:#2a00ff; '>' / '</span> + <span style='color:#7f0055; font-weight:bold; '>item</span>.kana + <span style='color:#2a00ff; '>' ('</span> + theRomaji + <span style='color:#2a00ff; '>') / '</span> + formattedDefinition;
        defText = defText.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#7f0055; font-weight:bold; '>new</span> RegExp(global_searchTerm, <span style='color:#2a00ff; '>'ig'</span>), <span style='color:#2a00ff; '>'&lt;span style="color:#990000;">$&amp;&lt;/span>'</span>);
        
        <span style='color:#7f0055; font-weight:bold; '>var</span> defLine = <span style='color:#2a00ff; '>'&lt;img src="img/j.png" style="vertical-align:middle;"> '</span> + defText + <span style='color:#2a00ff; '>'&lt;hr>'</span>;
        <span style='color:#3f7f59; '>//var defLine = '&lt;p class="def-line"> ' + defText + '&lt;/p>'; //had CSS styling issues (mostly text overflow)</span>
        
        theDiv.innerHTML += defLine;
    }
    
    buttonSpinnerVisible(<span style='color:#7f0055; font-weight:bold; '>false</span>);    <span style='color:#3f7f59; '>//stop the loading spinner</span>
}</code>

<p>We'll expect to be passed an SQLResultSet object which will come from a successful query on our Web SQL
database.
First we reset the current (ie. old) results by setting the container div's innerHTML property
to empty.
We then cover a scenario of no matches by printing a "no matches" message (with a plug for the 
<a href="https://twitter.com/japxlate">@japxlate</a> Twitter bot!). Note that you can split up very long quoted strings in JavaScript
by ending lines with a '\'. We then stop the "searching" spinner by calling the <code>buttonSpinnerVisible()</code>
function with a parameter of false. We'll write this function shortly and it's basically a way
to switch the "searching" spinner on and off. We then return.</p>

<div class="sidenote">
<strong><code>document.getElementById('some-id')</code> versus <code>document.querySelector('#some-id')</code></strong>

<p>You may be wondering why, for single elements, I am using <code>document.getElementById('some-id')</code>
and not the new fangled <code>document.querySelector('#some-id')</code>. Well it's true that these
will both return the same element, and it's true that <code>getElementById()</code> is a much older
piece of XML DOM, but the issue - at the time of writing - is one of performance (and
perhaps <code>getElementById()</code> is a teeny tiny bit more readable). After some benchmarking experiments
in desktop Chrome (using the mega useful <code>console.time()</code> and <code>console.timeEnd()</code> as at <a href="https://developers.google.com/chrome-developer-tools/docs/console-api#consoletimelabel">https://developers.google.com/chrome-developer-tools/docs/console-api#consoletimelabel</a>) I saw that, for single elements, <code>getElementById()</code>
was much faster than <code>querySelector()</code>. Out of curiosity I also tested jQuery's <code>$('#some-id)</code> (which
returns a jQuery-specific list of nodes) and found this to be much slower than the browser's native
<code>querySelector()</code>. Of note is that the new jQuery v2.0 was much faster than v1.x for the same selector
(though still slower than <code>querySelector()</code>).
</div>

<p>Now, if we're still in the function we'll have <em>some</em> results. We loop over and retrieve the
results using the SQLResultSet object's <code>rows.length</code> property and <code>rows.item(itemIndex)</code> method.
What we do in the loop looks fiddly, but all we are doing is replicating the style of definition lines
that <a href="https://twitter.com/japxlate">@japxlate</a> uses. If you remember the snippet of <code class="file">websql_edict_inserts.js</code> that we looked at earlier,
the format of the "definition" field in the database is "/definition one/definition two/definition three/".
We want to space these multiple definitions out a bit more and remove the lead and tail slashes;
for that we'll use a helper function called <code>format_slashes()</code> which also goes in this file:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Clean up the EDICT definition line that we get from our Web SQL DB</span>
<span style='color:#3f7f59; '>//For example, "/one/two/three/" --> "one; two; three"</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> format_slashes(slashesString)
{
    <span style='color:#3f7f59; '>//remove leading and trailing '/' characters</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> string = slashesString.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>^</span><span style='color:#2a00ff; '>\/</span><span style='color:#2a00ff; '>/</span>, <span style='color:#2a00ff; '>''</span>); <span style='color:#3f7f59; '>//leading</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> string = string.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>\/</span><span style='color:#2a00ff; '>$</span><span style='color:#2a00ff; '>/</span>, <span style='color:#2a00ff; '>''</span>); <span style='color:#3f7f59; '>//trailing</span>
    
    <span style='color:#3f7f59; '>//change remaining '/' characters to a semicolon with space</span>
    <span style='color:#7f0055; font-weight:bold; '>return</span> string.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>\/</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>, <span style='color:#2a00ff; '>'; '</span>);
}</code>

<p>We use JavaScript's core <code>replace()</code> method to change the slashes based on regex matching.
We replace single lead and tail slashes with an empty string.
We replace globally (the 'g' modifier after the regex) all remaining slashes with a semicolon
followed by space. We return the modified string.</p>

<p>OK, let's come back to explaining <code>putResultsOnPage()</code>. 
We create in <code>defText</code> a nicely formatted definition line.
We use <code>String.replace()</code> on this definition line to highlight the user's search term in our
trademark red. For this we use <code>global_searchTerm</code> which we'll define a bit later on.
</p>

<p><code>buttonSpinnerVisible()</code> is a simple CSS style toggler that also goes in <code class="file">search_interface.js</code> and looks like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Toggle for search button's loading spinner</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> buttonSpinnerVisible(visible)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> spinner = document.getElementById(<span style='color:#2a00ff; '>'button-spinner'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(visible)
    {
        spinner.style.visibility = <span style='color:#2a00ff; '>'visible'</span>;
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span>
    {
        spinner.style.visibility = <span style='color:#2a00ff; '>'hidden'</span>;
    }
}</code>

<p>Remember in <code class="file">websql_core.js</code> we did this a couple of times:</p>

<code class="multiline">document.getElementById('loading-text').innerHTML = '';</code>

<p>As this is manipulating the search interface, let's refactor this as a function in <code class="file">search_interface.js</code>.
Let's call it <code>clearLoadingMessage()</code>:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> clearLoadingMessage()
{
    document.getElementById(<span style='color:#2a00ff; '>'loading-text'</span>).innerHTML = <span style='color:#2a00ff; '>''</span>;
}</code>

<p>Then replace the two <code>document.getElementById('loading-text').innerHTML = '';</code> lines in <code class="file">websql_core.js</code>
with calls to <code>clearLoadingMessage();</code>.</p>

<p>OK, in <code class="file">search_interface.js</code> we now have all of the functions that <em>other functions</em> might call
to update the interface for database searching, but we are missing something here. The user! We need to catch
tap events on the Search button and then use their entered query to search the database and return results.
Let's start where the user starts - the Search button. Let's add a click handler. Add a call to:</p>

<code class="multiline">configureSearchButton();</code>

<p>at the bottom of <code>receivedEvent()</code> in good old <code class="file">index.js</code>.</p>

<p>We define <code>configureSearchButton()</code> in <code class="file">search_interface.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//search button clickability</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureSearchButton()
{
    document.getElementById(<span style='color:#2a00ff; '>'search-button'</span>).addEventListener(<span style='color:#2a00ff; '>'click'</span>, onclickForSearchButton, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>We define <code>onclickForSearchButton()</code> as the click handler for the search button. <code>onclickForSearchButton()</code>, also in <code class="file">search_interface.js</code>, is
like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Perform a dictionary search for entered query</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> onclickForSearchButton(event)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> q = document.getElementById(<span style='color:#2a00ff; '>'search-query'</span>).value;
    
    <span style='color:#3f7f59; '>//some kanji searches are going to be legitimately only one char</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(q.length &lt; 1)
    {
        <span style='color:#7f0055; font-weight:bold; '>return</span>;
    }
    
    buttonSpinnerVisible(<span style='color:#7f0055; font-weight:bold; '>true</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> matches = doEdictQueryOn(q);
}</code>

<p>We get the user's entered search query and - on the condition that it's at least one character long - we pass
it to <code>doEdictQueryOn()</code> after displaying the "searching" spinner.
<code>doEdictQueryOn()</code> is a function that we haven't written yet that will need a whole 'nother JavaScript
file. We've already got quite a few JavaScript files, but this is keeping it nice and modular.
Create <code class="file">websql_query.js</code> in <code class="file">/assets/www/js</code> and add <code>doEdictQueryOn()</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//function to query the database based on whatever query string</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> doEdictQueryOn(newQ)
{
    <span style='color:#3f7f59; '>//TODO</span>
}</code>

<p>What? It's empty! Yes, we're going to take a breather now and plan what we're going to do next.
A keyboard break if you like.
Remember back in the <a href="#the_search_tab_i">Layout and interface</a> section of this chapter when we laid down some rules about our app?
It's time to recap those now as it will affect how we implement dictionary searching.
We said we'll stick to a rule "that the user's search query can be in Japanese as well as English".
Obviously we'll then go down different search query routes depending on the entered language.
So we need a way to detect if the query is Japanese or English.</p>

<div class="sidenote">
<strong>Why two search querying routes?</strong>
<p>We could get away with not detecting the input query's language  and having this kind of logic:</p>
    <p>"Assume the query is English, do a search, if no results then assume it's Japanese and search again"</p>
<p>Which has two problems. We have to make an assumption about how our app is being <em>mostly</em> used.
(Admittedly we could change the assumption if we find out it's wrong.)
Another problem is performance - we may be searching unnecessarily.</p>
</div>

<p>A very simple, and linguistically incorrect!, way to do this is to see if we have
multibyte characters in our query string or not.
We've set our HTML page to be UTF-8. UTF-8 is interesting because it's a flavour of Unicode
that's backwards compatible with good ol' ASCII. ASCII can be utf-8, but so can Japanese!
But ASCII won't set the right bits in each byte to be considered a multibyte stream.
Something we can use to our advantage is that for ASCII, the length of a string in bytes
will also be the length of that string in <em>characters</em>. For multibyte utf-8 strings,
this will not be the case and the byte length will be <strong>greater than</strong> the character length.</p>

<p>Let's implement an <code>is_mb()</code> ("mb" meaning "multibyte") check using this knowledge.
Keeping things modular, and realising that we are going to need functions soon for
Japanese language handling, make a new file in <code class="file">/assets/www/js</code> called <code class="file">linguistics.js</code>. Add
<code>is_mb()</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Does the given utf8 string have multibyte characters or not?</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> is_mb(utf8String)
{
    <span style='color:#7f0055; font-weight:bold; '>return</span> utf8String.length != mb_bytelen(utf8String);
}</code>

<p>Here we compare a string's length in characters (using the <code>length</code> property
- JavaScript operates internally with utf-16 unicode) with its length in bytes.
<code>mb_bytelen()</code> is the key function here that we need to write. It will give us the
<em>byte</em> length for a utf8 string. Put it also in <code class="file">linguistics.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Get length in BYTES of a utf8 string</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mb_bytelen(utf8String)
{
    <span style='color:#3f7f59; '>//Matches only the 10.. bytes that are non-initial characters</span>
    <span style='color:#3f7f59; '>//in a multi-byte sequence.</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> m = encodeURIComponent(utf8String).<span style='color:#7f0055; font-weight:bold; '>match</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>%</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>89ABab</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>);
    <span style='color:#7f0055; font-weight:bold; '>return</span> utf8String.length + (m ? m.length : 0);
}</code>

<p>In utf-8, everything is a sequence of bytes. For an ASCII character, one byte is the full sequence -
that byte <em>is</em> the character. But it allows for multibyte characters by the initial byte
in that character's sequence of bytes setting a special bit. This special bit tells
the browser (or programming language or text editor etc) that "there's more to come!"
and the browser adds the remaining bytes in the sequence to get the full value for that character.
The remaning bytes also set a special bit so the browser knows when that particular
character has all of its bytes read. For the gory details please see <a href="http://en.wikipedia.org/wiki/UTF-8">http://en.wikipedia.org/wiki/UTF-8</a>.
</p>

<p>So what we are doing in <code>mb_bytelen()</code> is adding the length of the string in characters
to the count of non-initial character sequence bytes. This will give us the total byte length
for any utf8 string - containing multibyte characters or not!</p>

<p>OK, <code>is_mb()</code> is one important tool for our database querying logic in the bag.
Using it, let's think more about our query logic with some pseudocode:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>if</span>(is_mb(searchTerm)) {
    <span style='color:#3f7f59; '>//searchTerm is Japanese (or at least multibyte)</span>
    <span style='color:#3f7f59; '>//</span>
    <span style='color:#3f7f59; '>//[1] exact kanji match</span>
    <span style='color:#3f7f59; '>//[2] exact kana match</span>
} <span style='color:#7f0055; font-weight:bold; '>else</span> {
    <span style='color:#3f7f59; '>//searchTerm is English or, as last resort, romaji</span>
    <span style='color:#3f7f59; '>//</span>
    <span style='color:#3f7f59; '>//[1] exact definition match</span>
    <span style='color:#3f7f59; '>//[2] partial definition match</span>
    <span style='color:#3f7f59; '>//[3] exact romaji match (on kana field)</span>
}</code>

<p>So, if we detect multibyte characters in the search term, we <em>assume</em> it is Japanese and try to match it exactly
against, first, the kanji field of the words in our database. Then, if that produces no results,
we try to match it exactly against the kana field. This priority order is realistic because
kanji (Chinese idiogrammic characters) are the "correct" way to write a Japanese word. The kana
is just the way to pronounce those Chinese characters. Though note that some words are kana only and
don't hava a kanji.</p>

<p>We assume that the search term is in English if it contains no multibyte characters. Then we focus
on the definition field of our database. Remember that definition entries look like this:</p>

<code class="multiline">"/uncertain/vague/ambiguous/"</code>

<p>Multiple definitions are separated by slashes. So our most relevant results (query [1] of the English route) would
be to find the search term <strong>exactly</strong> as one of these definitions. A search for "vague" would
match the above definition, for example. If that produces no results,
we query for <em>partial</em> matches of the search term in these definitions. For example a search for
"director" will match a definition of <code>"/company director/board member/"</code>.
Finally, if we still have no results, we can take a gamble and assume that the user has entered
a term in romaji (which is Japanese written in abc like "sayonara" or "moshimoshi").
For this we'll have to convert the search term into phonetic kana and query for a matching kana
field. So this one needs a bit more work programmatically.</p>

<p>Note that if we go down the Japanese route, and get no results at the end, we <em>don't</em> then proceed
down the English route (and vice-versa).</p>

<p>Let's implement the Japanese route first as the queries are easier. We'll go back to working in
<code class="file">websql_search.sql</code>.
Remember from writing <code class="file">websql_core.js</code> how Web SQL works with callback chains?
Well, with this in mind (and don't get me wrong, there are better and cleverer ways to do this)
we're going to stick a couple of global variables at the top of <code class="file">websql_search.sql</code>
so that all callback functions can access them:</p>

<code class="multiline"><span style='color:#3f7f59; '>//User's search term as a global variable (so we can access it from all the different callbacks). Hmmm...</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_searchTerm = <span style='color:#7f0055; font-weight:bold; '>null</span>;

<span style='color:#3f7f59; '>//Maximum number of search results to return for any query</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_maxResultsCount = 40;</code>

<p>Now make <code>doEdictQueryOn()</code> look like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> doEdictQueryOn(newQ)
{
    <span style='color:#3f7f59; '>//set global_searchTerm</span>
    global_searchTerm = newQ;
    
    <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(is_mb(global_searchTerm))    <span style='color:#3f7f59; '>//Japanese (or at least multibyte)</span>
    {
        <span style='color:#3f7f59; '>//console.log('doing as japanese - kanji');</span>
        db.transaction(queryDB_ja, errorWebSQL);
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span>       <span style='color:#3f7f59; '>//ie. English (or - as last resort - romaji)</span>
    {
        <span style='color:#3f7f59; '>console.log('doing as english - exact');</span>
    }
}</code>

<p>We simply save the search term into <code>global_searchTerm</code>, open the database and attempt the
<code>queryDB_ja()</code> query function (using our generic Web SQL error handler). We'll come back to the
<code>else</code> section for English later, but in the meantime let's make <code>queryDB_ja()</code> which is like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Search edict for an exact kanji match</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> queryDB_ja(tx)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQ = global_searchTerm;
    
    <span style='color:#3f7f59; '>//use placeholders (so we don't need to escape the query)</span>
    tx.executeSql(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>SELECT * FROM edict WHERE kanji = ? LIMIT </span><span style='color:#2a00ff; '>"</span> + global_maxResultsCount, [safeQ], successQueryDB_ja, errorWebSQL);
}</code>

<p>We accept an SQLTransaction object - as per the Web SQL specification - and call it tx for short.
We use <code>tx.executeSql()</code> to run a very simple SQL query on the edict table; Matching
the kanji field exactly to the search term. Note how we get the search term from the
global variable we defined earlier.</p>
<p>In the SQL query, we have <code>"kanji = ?"</code>, the question mark is a placeholder for parameter (or value)
binding. We then specify the value to be bound to this placeholder in the 2nd argument to <code>tx.executeSql()</code>,
in this case safeQ.
Why do this? Why not just query for <code>"kanji = '" + safeQ + "'"</code>, ie. literally.
Well because, this way, if the entered search term contains single quotes or slashes
or anything that Web SQL considers "special", the SQL query will break and result in errors.
When we use parameter binding, Web SQL is going to <em>escape</em> the parameter value for us
so that we are safe from dodgy characters accidentally breaking our SQL (or malicious
"SQL injection" attacks). 
You can try this a little later if you like to see how wrong it can go!</p>

<p>So we query with a success callback of <code>successQueryDB_ja()</code> and our all-purpose error
handler. Note that <code>successQueryDB_ja()</code> will be called if the <code>executeSql()</code> query is
valid and executes - which means even if zero results are returned.
So <code>successQueryDB_ja()</code> is going to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if queryDB_ja() did not error (which includes zero results)</span>
<span style='color:#3f7f59; '>//Print kanji matches if we have any ELSE try kana matches</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successQueryDB_ja(tx, results)
{
    <span style='color:#7f0055; font-weight:bold; '>if</span>(results.rows.length == 0)    <span style='color:#3f7f59; '>//no kanji matches - try kana matches</span>
    {
        <span style='color:#3f7f59; '>//console.log('no ja kanji matches');</span>

        <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
        <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);

        db.transaction(queryDB_ja_kana, errorWebSQL);
    }
   
    <span style='color:#7f0055; font-weight:bold; '>else</span>
    {
        putResultsOnPage(results);
    } 
}</code>

<p>We receive the SQLTransaction and an SQLResultSet.
We check the <code>rows.length</code> property of the resultset to see if we got any matches or not.
If we have no matches then we open the DB again and run a different query function on it,
namely <code>queryDB_ja_kana()</code> which is going to search for kana matches against
the search term.
If we have any matches, we simply call our <code>putResultsOnPage()</code> function
(that we made previously in <code class="file">search_interface.js</code>) and pass it the resultset. Then
we are done with this particular query route.
OK, we still need to implement <code>queryDB_ja_kana()</code>, which - yes you've guessed it -
is almost identical to <code>queryDB_ja()</code> but using the kana field:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Search edict for an exact kana match</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> queryDB_ja_kana(tx)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQ = global_searchTerm;
    
    <span style='color:#3f7f59; '>//use placeholders (so we don't need to escape the query)</span>
    tx.executeSql(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>SELECT * FROM edict WHERE kana = ? LIMIT </span><span style='color:#2a00ff; '>"</span> + global_maxResultsCount, [safeQ], successQueryDB_ja_kana, errorWebSQL);
}</code>

<p>Nothing new here apart from the use of the kana field for searching. Oh and the
success callback of <code>successQueryDB_ja_kana()</code> which, as this is the last step of
our Japanese querying route, is going to be quite simple:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if queryDB_ja_kana() did not error (which includes zero results)</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successQueryDB_ja_kana(tx, results)
{
    putResultsOnPage(results);
}</code>

<p>We simply print out any and all results that we might have.</p>

<p>We are now ready to give this Japanese query route a test drive! First,
include the new JavaScript files we've made at the bottom of <code class="file">index.html</code>
so that it looks like this:</p>

<code class="multiline">&vellip;
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/linguistics.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/search_interface.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/websql_edict_inserts.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/websql_core.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/websql_search.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/japxlate.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span> src=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>js/index.js</span><span style='color:#2a00ff; '>"</span>>&lt;/script>
&lt;script type=<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>text/javascript</span><span style='color:#2a00ff; '>"</span>>
    app.initialize();
&lt;/script>
&vellip;</code>

<p>Run it! Enter an English search term and click the search button.
You'll get a console message of "doing as english - exact", and the
spinner will start to spin and not stop! We've obviously not finished the English
query route yet.</p>
<p>Let's check if it is really searching for any entered Japanese terms.
Go ahead and copy some random text from <a href="http://www.yahoo.co.jp">http://www.yahoo.co.jp</a> and paste
it into our app's search box. Click search. You'll probably
get the "no matches found" message (unless you got really lucky!).
OK, so that's working. What about an actual match? Open up the <code class="file">websql_edict_inserts.js</code>
file and copy any kanji or kana INSERT value. Search for this on the app
and you should get the corresponding definition. Nice!</p>

<p>This is pretty awesome right now. It's beginning to feel like a useful, working app!
OK, before the very final thing we need to implement for searching (I'll let
you guess what you think it is ;-)) let's tackle that English searching route.
Go back to the <code>else</code> clause in <code>doEdictQueryOn()</code> (in <code class="file">websql_search.js</code>) and edit it to
actually do something:</p>

<code class="multiline">&vellip;
<span style='color:#7f0055; font-weight:bold; '>if</span>(is_mb(global_searchTerm))    <span style='color:#3f7f59; '>//Japanese (or at least multibyte)</span>
{
    <span style='color:#3f7f59; '>//console.log('doing as japanese - kanji');</span>
    db.transaction(queryDB_ja, errorWebSQL);
}

<span style='color:#7f0055; font-weight:bold; '>else</span>       <span style='color:#3f7f59; '>//ie. English (or - as last resort - romaji)</span>
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'doing as english - exact'</span>);
    db.transaction(queryDB_en, errorWebSQL);
}
&vellip;</code>

<p>We do what we do for Japanese just with a different query function called <code>queryDB_en()</code>
which is going to do step [1] of our English route and is like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Search edict for an exact English match</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> queryDB_en(tx)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQ = global_searchTerm;
    
    <span style='color:#3f7f59; '>//use placeholders (so we don't need to escape the query)</span>
    tx.executeSql(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>SELECT * FROM edict WHERE definition LIKE ? LIMIT </span><span style='color:#2a00ff; '>"</span> + global_maxResultsCount, [<span style='color:#2a00ff; '>'%/'</span> + safeQ + <span style='color:#2a00ff; '>'/%'</span>], successQueryDB_en, errorWebSQL);
}</code>

<p>Here we query the definition field of our edict table and note how we use the LIKE
operator and not, as with the Japanese route queries, the '=' operator.
LIKE allows us to use wildcard characters which allows us to do a fuzzier search.
We need that functionality here as we are trying to match only one of
each database row's many definitions (separated by '/').</p>
<p>What's going on with our 2nd argument where we have to specify the value
for parameter binding?
Well, we basically build a LIKE condition that will match, completely, safeQ as ANY one
of the definition entries - first one, last one or any of the middle ones.
'%' is the SQL wildcard meaning "match anything" and actually it will match zero
characters if applicable too! With a definition of:</p>

<code class="multiline">"/one/two/three/"</code>

<p>then the same format of condition like: '%/one/%', '%/two/%', '%/three/%'
will match each corresponding definition respectively. We simply build this pattern and
put it in the 2nd argument.
We use the general error handler again and the success handler is <code>successQueryDB_en():</code></p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if queryDB_en() did not error (which includes zero results)</span>
<span style='color:#3f7f59; '>//Print exact matches if we have any ELSE try partial matches</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successQueryDB_en(tx, results)
{
    <span style='color:#7f0055; font-weight:bold; '>if</span>(results.rows.length == 0)    <span style='color:#3f7f59; '>//no exact matches - try partial matches</span>
    {
        <span style='color:#3f7f59; '>//console.log('no en exact matches');</span>
        
        <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
        <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);
    
        db.transaction(queryDB_en_partial, errorWebSQL);
    }
   
    <span style='color:#7f0055; font-weight:bold; '>else</span>
    {
        putResultsOnPage(results);
    } 
}</code>

<p>This is cut from the same mould as <code>successQueryDB_en()</code> that we've just done.
If we have no results from exact matching, we move on to step [2] which is
partial matches by calling <code>queryDB_en_partial()</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Search edict for a partial English match</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> queryDB_en_partial(tx)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQ = global_searchTerm;
    
    <span style='color:#3f7f59; '>//use placeholders (so we don't need to escape the query)</span>
    tx.executeSql(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>SELECT * FROM edict WHERE definition LIKE ? LIMIT </span><span style='color:#2a00ff; '>"</span> + global_maxResultsCount, [<span style='color:#2a00ff; '>'%'</span> + safeQ + <span style='color:#2a00ff; '>'%'</span>], successQueryDB_en_partial, errorWebSQL);
}</code>

<p>This is very very similar to <code>queryDB_en()</code>, but the important difference is in
the LIKE condition. We do not use slashes here which means we are not
locked down to an exact match and will match any definition list
where the user's search term <em>appears</em>. For example, searching for "user
interface" will match a definiton of:</p>

<code class="multiline">"/graphical user interface/GUI/"</code>

<p>The success callback here is <code>successQueryDB_en_partial()</code> which is
going to trigger the final step [3] of English searching, or display
results from this step [2].</p>

<p>It is in the same shape as the other success callbacks so far:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Callback for if queryDB_en_partial() did not error (which includes zero results)</span>
<span style='color:#3f7f59; '>//Print partial matches if we have any ELSE try romaji matches</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> successQueryDB_en_partial(tx, results)
{
    <span style='color:#7f0055; font-weight:bold; '>if</span>(results.rows.length == 0)    <span style='color:#3f7f59; '>//no partial matches - try as romaji</span>
    {
        <span style='color:#3f7f59; '>//console.log('no en partial matches');</span>
             
        <span style='color:#3f7f59; '>//version 1.0, 4 megabytes</span>
        <span style='color:#7f0055; font-weight:bold; '>var</span> db = window.openDatabase(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>1.0</span><span style='color:#2a00ff; '>"</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>Japxlate DB</span><span style='color:#2a00ff; '>"</span>, 4 * 1024 * 1024);
    
        db.transaction(queryDB_en_romaji, errorWebSQL);
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span>
    {
        putResultsOnPage(results);
    } 
}</code>

<p>We do step [3] - if we need to - by calling <code>queryDB_en_romaji()</code>.
This is going to be the fiddly step that we mentioned earlier as it will need
to convert search terms like "sayonara" or "moshimoshi" into phonetic Japanese
kana so we can then search the database. <code>queryDB_en_romaji()</code> is like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Search edict for a romaji match</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> queryDB_en_romaji(tx)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQ = global_searchTerm;
    <span style='color:#7f0055; font-weight:bold; '>var</span> safeQKana = romaji_to_hira(global_searchTerm);
    
    <span style='color:#3f7f59; '>//use placeholders (so we don't need to escape the query)</span>
    tx.executeSql(<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>SELECT * FROM edict WHERE kana LIKE ? LIMIT </span><span style='color:#2a00ff; '>"</span> + global_maxResultsCount, [safeQKana], successQueryDB_en_romaji, errorWebSQL);
}</code>

<p>We convert the search term into hiragana (which is <em>one</em> of the Japanese
phonetic scripts and the most common one used in the kana field of our table) via <code>romaji_to_hira()</code> which
we implement very soon.
The query is straightforward, but don't forget to implement the success callback of 
<code>successQueryDB_en_romaji()</code> which is a carbon copy of <code>successQueryDB_ja_kana()</code>
but with a different name.</p>

<p>So we've come to a bit of a dead-end as we need to implement the <code>romaji_to_hira()</code>
script conversion function.
Well, I know from the experience of building the <a href="https://twitter.com/japxlate">@japxlate</a> bot - and <a href="http://mapanese.info">Mapanese</a> -
that we can cover <strong>almost all</strong> cases of Japanese <--> English script conversion
by simple string replacement operations. For example, we have a table of all
Japanese characters and then a corresponding table of English spellings
for those characters. Then we can convert Japanese script to English and vice versa.</p>

<p>JavaScript has a builtin <code>String.replace()</code> method, but it works by replacing
the first (or all) matching regexes in the string with the supplied replacement value.
We can't give it a list of targets and a list of corresponding replacements.
We want something a little easier to use, and so we're going to go deep down and dirty
with some advanced JavaScript. We are going to <em>prototype</em> a new method onto the
String object which means we can add a new method to the String class ONCE and
it is available to any variable of type string in JavaScript!
Let's put this in <code class="file">linguistics.js</code> (we'll get back to database querying when we've
got the language conversion all done and dusted). OK, code first explanations second:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Here we use prototyping to add a method to the String class to give</span>
<span style='color:#3f7f59; '>//us the equivalent of PHP's str_replace()</span>
String.prototype.str_replace = <span style='color:#7f0055; font-weight:bold; '>function</span>(find, <span style='color:#7f0055; font-weight:bold; '>replace</span>)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> replaceString = <span style='color:#7f0055; font-weight:bold; '>this</span>;
    <span style='color:#7f0055; font-weight:bold; '>var</span> regex;
    
    <span style='color:#7f0055; font-weight:bold; '>for</span> (<span style='color:#7f0055; font-weight:bold; '>var</span> i = 0; i &lt; find.length; i++) {
        regex = <span style='color:#7f0055; font-weight:bold; '>new</span> RegExp(find[i], <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>g</span><span style='color:#2a00ff; '>"</span>);
        replaceString = replaceString.<span style='color:#7f0055; font-weight:bold; '>replace</span>(regex, <span style='color:#7f0055; font-weight:bold; '>replace</span>[i]);
    }
    
    <span style='color:#7f0055; font-weight:bold; '>return</span> replaceString;
};</code>

<p>'String' is JavaScript's object name for character strings. Any variable - or literal -
that's a string will be of object type 'String'. That's how we can run <code>.replace()</code> 
and <code>.match()</code> and things like that on any JavaScript string - because they are all String
objects and the String object has prototypes of those methods.</p>

<p>So the syntax to prototype a new method into the String object is:</p>

<code class="multiline">String.prototype.newMethodName = function(any, args, you, need){code; to; do; stuff;};</code>


<p>We name the method "str_replace" (in honour of PHP ;-)) and define it as a function
accepting two parameters; find and replace - both of which are character arrays.</p>

<p>In a prototype method, the context of 'this' will refer to the object on which the method was called.
For example, if calling <code>myStringVariable.str_replace()</code>, then in the <code>str_replace()</code> protoype,
'this' will be myStringVariable.</p>

<p>We save the string in <code>replaceString</code>. We then loop over each item in the find array
and <strong>globally</strong> (the 'g' modifier) replace any occurrences of it with the corresponding character
in the replace array. So yes, the find and replace arrays need to have the same number of
items in them which we don't explicitly police here.</p>

<p>Before we write <code>romaji_to_hira()</code>, we need the character tables that our <code>String.str_replace()</code>
will operate on. I won't dwell on these too much, and it's best to simply paste these
in to your code as a black box - this isn't a linguistics course! Though the variable
names and comments will help if you want to read through it. Stick these at the top of <code class="file">linguistics.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//----character tables----------------------------------------------------------</span>

<span style='color:#3f7f59; '>//All single character hiragana (in "biggest" first order)</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> coreHiragana =
[
    <span style='color:#2a00ff; '>'が'</span>, <span style='color:#2a00ff; '>'ぎ'</span>, <span style='color:#2a00ff; '>'ぐ'</span>, <span style='color:#2a00ff; '>'げ'</span>, <span style='color:#2a00ff; '>'ご'</span>,
    <span style='color:#2a00ff; '>'ざ'</span>, <span style='color:#2a00ff; '>'じ'</span>, <span style='color:#2a00ff; '>'ず'</span>, <span style='color:#2a00ff; '>'ぜ'</span>, <span style='color:#2a00ff; '>'ぞ'</span>,
    <span style='color:#2a00ff; '>'だ'</span>, <span style='color:#2a00ff; '>'ぢ'</span>, <span style='color:#2a00ff; '>'づ'</span>, <span style='color:#2a00ff; '>'で'</span>, <span style='color:#2a00ff; '>'ど'</span>,
    <span style='color:#2a00ff; '>'ば'</span>, <span style='color:#2a00ff; '>'び'</span>, <span style='color:#2a00ff; '>'ぶ'</span>, <span style='color:#2a00ff; '>'べ'</span>, <span style='color:#2a00ff; '>'ぼ'</span>,
    <span style='color:#2a00ff; '>'ぱ'</span>, <span style='color:#2a00ff; '>'ぴ'</span>, <span style='color:#2a00ff; '>'ぷ'</span>, <span style='color:#2a00ff; '>'ぺ'</span>, <span style='color:#2a00ff; '>'ぽ'</span>,
    <span style='color:#2a00ff; '>'か'</span>, <span style='color:#2a00ff; '>'き'</span>, <span style='color:#2a00ff; '>'く'</span>, <span style='color:#2a00ff; '>'け'</span>, <span style='color:#2a00ff; '>'こ'</span>,
    <span style='color:#2a00ff; '>'さ'</span>, <span style='color:#2a00ff; '>'し'</span>, <span style='color:#2a00ff; '>'す'</span>, <span style='color:#2a00ff; '>'せ'</span>, <span style='color:#2a00ff; '>'そ'</span>,
    <span style='color:#2a00ff; '>'た'</span>, <span style='color:#2a00ff; '>'ち'</span>, <span style='color:#2a00ff; '>'つ'</span>, <span style='color:#2a00ff; '>'て'</span>, <span style='color:#2a00ff; '>'と'</span>,
    <span style='color:#2a00ff; '>'な'</span>, <span style='color:#2a00ff; '>'に'</span>, <span style='color:#2a00ff; '>'ぬ'</span>, <span style='color:#2a00ff; '>'ね'</span>, <span style='color:#2a00ff; '>'の'</span>,
    <span style='color:#2a00ff; '>'は'</span>, <span style='color:#2a00ff; '>'ひ'</span>, <span style='color:#2a00ff; '>'ふ'</span>, <span style='color:#2a00ff; '>'へ'</span>, <span style='color:#2a00ff; '>'ほ'</span>,
    <span style='color:#2a00ff; '>'ま'</span>, <span style='color:#2a00ff; '>'み'</span>, <span style='color:#2a00ff; '>'む'</span>, <span style='color:#2a00ff; '>'め'</span>, <span style='color:#2a00ff; '>'も'</span>,
    <span style='color:#2a00ff; '>'や'</span>,       <span style='color:#2a00ff; '>'ゆ'</span>,       <span style='color:#2a00ff; '>'よ'</span>,
    <span style='color:#2a00ff; '>'ら'</span>, <span style='color:#2a00ff; '>'り'</span>, <span style='color:#2a00ff; '>'る'</span>, <span style='color:#2a00ff; '>'れ'</span>, <span style='color:#2a00ff; '>'ろ'</span>,
    <span style='color:#2a00ff; '>'わ'</span>, <span style='color:#2a00ff; '>'ゐ'</span>,       <span style='color:#2a00ff; '>'ゑ'</span>, <span style='color:#2a00ff; '>'を'</span>,
    <span style='color:#2a00ff; '>'ん'</span>, <span style='color:#2a00ff; '>'っ'</span>,
    <span style='color:#2a00ff; '>'あ'</span>, <span style='color:#2a00ff; '>'い'</span>, <span style='color:#2a00ff; '>'う'</span>, <span style='color:#2a00ff; '>'え'</span>, <span style='color:#2a00ff; '>'お'</span>,
    <span style='color:#2a00ff; '>'ゃ'</span>,       <span style='color:#2a00ff; '>'ゅ'</span>,       <span style='color:#2a00ff; '>'ょ'</span>,
    <span style='color:#2a00ff; '>'ぁ'</span>, <span style='color:#2a00ff; '>'ぃ'</span>, <span style='color:#2a00ff; '>'ぅ'</span>, <span style='color:#2a00ff; '>'ぇ'</span>, <span style='color:#2a00ff; '>'ぉ'</span>,
];

<span style='color:#3f7f59; '>//All single character katakana (in "biggest" first order)</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> coreKatakana =
[
    <span style='color:#2a00ff; '>'ガ'</span>, <span style='color:#2a00ff; '>'ギ'</span>, <span style='color:#2a00ff; '>'グ'</span>, <span style='color:#2a00ff; '>'ゲ'</span>, <span style='color:#2a00ff; '>'ゴ'</span>,
    <span style='color:#2a00ff; '>'ザ'</span>, <span style='color:#2a00ff; '>'ジ'</span>, <span style='color:#2a00ff; '>'ズ'</span>, <span style='color:#2a00ff; '>'ゼ'</span>, <span style='color:#2a00ff; '>'ゾ'</span>,
    <span style='color:#2a00ff; '>'ダ'</span>, <span style='color:#2a00ff; '>'ヂ'</span>, <span style='color:#2a00ff; '>'ヅ'</span>, <span style='color:#2a00ff; '>'デ'</span>, <span style='color:#2a00ff; '>'ド'</span>,
    <span style='color:#2a00ff; '>'バ'</span>, <span style='color:#2a00ff; '>'ビ'</span>, <span style='color:#2a00ff; '>'ブ'</span>, <span style='color:#2a00ff; '>'ベ'</span>, <span style='color:#2a00ff; '>'ボ'</span>,
    <span style='color:#2a00ff; '>'パ'</span>, <span style='color:#2a00ff; '>'ピ'</span>, <span style='color:#2a00ff; '>'プ'</span>, <span style='color:#2a00ff; '>'ペ'</span>, <span style='color:#2a00ff; '>'ポ'</span>,
    <span style='color:#2a00ff; '>'カ'</span>, <span style='color:#2a00ff; '>'キ'</span>, <span style='color:#2a00ff; '>'ク'</span>, <span style='color:#2a00ff; '>'ケ'</span>, <span style='color:#2a00ff; '>'コ'</span>,
    <span style='color:#2a00ff; '>'サ'</span>, <span style='color:#2a00ff; '>'シ'</span>, <span style='color:#2a00ff; '>'ス'</span>, <span style='color:#2a00ff; '>'セ'</span>, <span style='color:#2a00ff; '>'ソ'</span>,
    <span style='color:#2a00ff; '>'タ'</span>, <span style='color:#2a00ff; '>'チ'</span>, <span style='color:#2a00ff; '>'ツ'</span>, <span style='color:#2a00ff; '>'テ'</span>, <span style='color:#2a00ff; '>'ト'</span>,
    <span style='color:#2a00ff; '>'ナ'</span>, <span style='color:#2a00ff; '>'ニ'</span>, <span style='color:#2a00ff; '>'ヌ'</span>, <span style='color:#2a00ff; '>'ネ'</span>, <span style='color:#2a00ff; '>'ノ'</span>,
    <span style='color:#2a00ff; '>'ハ'</span>, <span style='color:#2a00ff; '>'ヒ'</span>, <span style='color:#2a00ff; '>'フ'</span>, <span style='color:#2a00ff; '>'ヘ'</span>, <span style='color:#2a00ff; '>'ホ'</span>,
    <span style='color:#2a00ff; '>'マ'</span>, <span style='color:#2a00ff; '>'ミ'</span>, <span style='color:#2a00ff; '>'ム'</span>, <span style='color:#2a00ff; '>'メ'</span>, <span style='color:#2a00ff; '>'モ'</span>,
    <span style='color:#2a00ff; '>'ヤ'</span>,       <span style='color:#2a00ff; '>'ユ'</span>,       <span style='color:#2a00ff; '>'ヨ'</span>,
    <span style='color:#2a00ff; '>'ラ'</span>, <span style='color:#2a00ff; '>'リ'</span>, <span style='color:#2a00ff; '>'ル'</span>, <span style='color:#2a00ff; '>'レ'</span>, <span style='color:#2a00ff; '>'ロ'</span>,
    <span style='color:#2a00ff; '>'ワ'</span>, <span style='color:#2a00ff; '>'ヰ'</span>,       <span style='color:#2a00ff; '>'ヱ'</span>, <span style='color:#2a00ff; '>'ヲ'</span>,
    <span style='color:#2a00ff; '>'ン'</span>, <span style='color:#2a00ff; '>'ッ'</span>,
    <span style='color:#2a00ff; '>'ア'</span>, <span style='color:#2a00ff; '>'イ'</span>, <span style='color:#2a00ff; '>'ウ'</span>, <span style='color:#2a00ff; '>'エ'</span>, <span style='color:#2a00ff; '>'オ'</span>,
    <span style='color:#2a00ff; '>'ャ'</span>,       <span style='color:#2a00ff; '>'ュ'</span>,       <span style='color:#2a00ff; '>'ョ'</span>,
    <span style='color:#2a00ff; '>'ァ'</span>, <span style='color:#2a00ff; '>'ィ'</span>, <span style='color:#2a00ff; '>'ゥ'</span>, <span style='color:#2a00ff; '>'ェ'</span>, <span style='color:#2a00ff; '>'ォ'</span>,
];

<span style='color:#3f7f59; '>//Transliterations of coreHiragana</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> coreRomaji =
[
    <span style='color:#2a00ff; '>'ga'</span>, <span style='color:#2a00ff; '>'gi'</span>, <span style='color:#2a00ff; '>'gu'</span>, <span style='color:#2a00ff; '>'ge'</span>, <span style='color:#2a00ff; '>'go'</span>,
    <span style='color:#2a00ff; '>'za'</span>, <span style='color:#2a00ff; '>'ji'</span>, <span style='color:#2a00ff; '>'zu'</span>, <span style='color:#2a00ff; '>'ze'</span>, <span style='color:#2a00ff; '>'zo'</span>,
    <span style='color:#2a00ff; '>'da'</span>, <span style='color:#2a00ff; '>'di'</span>, <span style='color:#2a00ff; '>'du'</span>, <span style='color:#2a00ff; '>'de'</span>, <span style='color:#2a00ff; '>'do'</span>,
    <span style='color:#2a00ff; '>'ba'</span>, <span style='color:#2a00ff; '>'bi'</span>, <span style='color:#2a00ff; '>'bu'</span>, <span style='color:#2a00ff; '>'be'</span>, <span style='color:#2a00ff; '>'bo'</span>,
    <span style='color:#2a00ff; '>'pa'</span>, <span style='color:#2a00ff; '>'pi'</span>, <span style='color:#2a00ff; '>'pu'</span>, <span style='color:#2a00ff; '>'pe'</span>, <span style='color:#2a00ff; '>'po'</span>,
    <span style='color:#2a00ff; '>'ka'</span>, <span style='color:#2a00ff; '>'ki'</span>, <span style='color:#2a00ff; '>'ku'</span>, <span style='color:#2a00ff; '>'ke'</span>, <span style='color:#2a00ff; '>'ko'</span>,
    <span style='color:#2a00ff; '>'sa'</span>, <span style='color:#2a00ff; '>'shi'</span>, <span style='color:#2a00ff; '>'su'</span>, <span style='color:#2a00ff; '>'se'</span>, <span style='color:#2a00ff; '>'so'</span>,
    <span style='color:#2a00ff; '>'ta'</span>, <span style='color:#2a00ff; '>'chi'</span>, <span style='color:#2a00ff; '>'tsu'</span>, <span style='color:#2a00ff; '>'te'</span>, <span style='color:#2a00ff; '>'to'</span>,
    <span style='color:#2a00ff; '>'na'</span>, <span style='color:#2a00ff; '>'ni'</span>, <span style='color:#2a00ff; '>'nu'</span>, <span style='color:#2a00ff; '>'ne'</span>, <span style='color:#2a00ff; '>'no'</span>,
    <span style='color:#2a00ff; '>'ha'</span>, <span style='color:#2a00ff; '>'hi'</span>, <span style='color:#2a00ff; '>'fu'</span>, <span style='color:#2a00ff; '>'he'</span>, <span style='color:#2a00ff; '>'ho'</span>,
    <span style='color:#2a00ff; '>'ma'</span>, <span style='color:#2a00ff; '>'mi'</span>, <span style='color:#2a00ff; '>'mu'</span>, <span style='color:#2a00ff; '>'me'</span>, <span style='color:#2a00ff; '>'mo'</span>,
    <span style='color:#2a00ff; '>'ya'</span>,       <span style='color:#2a00ff; '>'yu'</span>,       <span style='color:#2a00ff; '>'yo'</span>,
    <span style='color:#2a00ff; '>'ra'</span>, <span style='color:#2a00ff; '>'ri'</span>, <span style='color:#2a00ff; '>'ru'</span>, <span style='color:#2a00ff; '>'re'</span>, <span style='color:#2a00ff; '>'ro'</span>,
    <span style='color:#2a00ff; '>'wa'</span>, <span style='color:#2a00ff; '>'wi'</span>,       <span style='color:#2a00ff; '>'we'</span>, <span style='color:#2a00ff; '>'wo'</span>,
    <span style='color:#2a00ff; '>'n'</span>,  <span style='color:#2a00ff; '>'ッ'</span>,  <span style='color:#3f7f59; '>//preserve chiisai tsu</span>
    <span style='color:#2a00ff; '>'a'</span>,  <span style='color:#2a00ff; '>'i'</span>,  <span style='color:#2a00ff; '>'u'</span>,  <span style='color:#2a00ff; '>'e'</span>,  <span style='color:#2a00ff; '>'o'</span>,
    <span style='color:#2a00ff; '>'ya'</span>,       <span style='color:#2a00ff; '>'yu'</span>,       <span style='color:#2a00ff; '>'yo'</span>,
    <span style='color:#2a00ff; '>'a'</span>,  <span style='color:#2a00ff; '>'i'</span>,  <span style='color:#2a00ff; '>'u'</span>,  <span style='color:#2a00ff; '>'e'</span>,  <span style='color:#2a00ff; '>'o'</span>,
];

<span style='color:#3f7f59; '>//All "combination" katakana</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> comboKatakana =
[
    <span style='color:#2a00ff; '>'チャ'</span>, <span style='color:#2a00ff; '>'チュ'</span>, <span style='color:#2a00ff; '>'チェ'</span>, <span style='color:#2a00ff; '>'チョ'</span>,
    <span style='color:#2a00ff; '>'シャ'</span>, <span style='color:#2a00ff; '>'シュ'</span>, <span style='color:#2a00ff; '>'シェ'</span>, <span style='color:#2a00ff; '>'ショ'</span>,
    <span style='color:#2a00ff; '>'ジャ'</span>, <span style='color:#2a00ff; '>'ジュ'</span>, <span style='color:#2a00ff; '>'ジェ'</span>, <span style='color:#2a00ff; '>'ジョ'</span>,
    <span style='color:#2a00ff; '>'キャ'</span>, <span style='color:#2a00ff; '>'キュ'</span>,        <span style='color:#2a00ff; '>'キョ'</span>,
    <span style='color:#2a00ff; '>'ギャ'</span>, <span style='color:#2a00ff; '>'ギュ'</span>,        <span style='color:#2a00ff; '>'ギョ'</span>,
           <span style='color:#2a00ff; '>'リュ'</span>,         <span style='color:#2a00ff; '>'リョ'</span>,
    <span style='color:#2a00ff; '>'ミャ'</span>, <span style='color:#2a00ff; '>'ミュ'</span>,         <span style='color:#2a00ff; '>'ミョ'</span>,
    <span style='color:#2a00ff; '>'ヒャ'</span>, <span style='color:#2a00ff; '>'ヒュ'</span>,         <span style='color:#2a00ff; '>'ヒョ'</span>,
    <span style='color:#2a00ff; '>'ニャ'</span>, <span style='color:#2a00ff; '>'ニュ'</span>,         <span style='color:#2a00ff; '>'ニョ'</span>,
    <span style='color:#2a00ff; '>'ビャ'</span>, <span style='color:#2a00ff; '>'ビュ'</span>,         <span style='color:#2a00ff; '>'ビョ'</span>,
    <span style='color:#2a00ff; '>'ピャ'</span>, <span style='color:#2a00ff; '>'ピュ'</span>,         <span style='color:#2a00ff; '>'ピョ'</span>,
    <span style='color:#2a00ff; '>'ヂャ'</span>, <span style='color:#2a00ff; '>'ヂュ'</span>,         <span style='color:#2a00ff; '>'ヂョ'</span>,
    <span style='color:#2a00ff; '>'ファ'</span>, <span style='color:#2a00ff; '>'フィ'</span>, <span style='color:#2a00ff; '>'フェ'</span>, <span style='color:#2a00ff; '>'フォ'</span>,
           <span style='color:#2a00ff; '>'ウィ'</span>, <span style='color:#2a00ff; '>'ウェ'</span>,  <span style='color:#2a00ff; '>'ウォ'</span>,
    <span style='color:#2a00ff; '>'ヴァ'</span>, <span style='color:#2a00ff; '>'ヴィ'</span>, <span style='color:#2a00ff; '>'ヴェ'</span>, <span style='color:#2a00ff; '>'ヴォ'</span>,
           <span style='color:#2a00ff; '>'ティ'</span>,
           <span style='color:#2a00ff; '>'ディ'</span>
];

<span style='color:#3f7f59; '>//Transliterations of comboKatakana</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> comboRomaji =
[
    <span style='color:#2a00ff; '>'cha'</span>, <span style='color:#2a00ff; '>'chu'</span>, <span style='color:#2a00ff; '>'che'</span>, <span style='color:#2a00ff; '>'cho'</span>,
    <span style='color:#2a00ff; '>'sha'</span>, <span style='color:#2a00ff; '>'shu'</span>, <span style='color:#2a00ff; '>'she'</span>, <span style='color:#2a00ff; '>'sho'</span>,
    <span style='color:#2a00ff; '>'ja'</span>,  <span style='color:#2a00ff; '>'ju'</span>,  <span style='color:#2a00ff; '>'je'</span>,  <span style='color:#2a00ff; '>'jo'</span>,
    <span style='color:#2a00ff; '>'kya'</span>, <span style='color:#2a00ff; '>'kyu'</span>,        <span style='color:#2a00ff; '>'kyo'</span>,
    <span style='color:#2a00ff; '>'gya'</span>, <span style='color:#2a00ff; '>'gyu'</span>,        <span style='color:#2a00ff; '>'gyo'</span>,
           <span style='color:#2a00ff; '>'ryu'</span>,        <span style='color:#2a00ff; '>'ryo'</span>,
    <span style='color:#2a00ff; '>'mya'</span>, <span style='color:#2a00ff; '>'myu'</span>,        <span style='color:#2a00ff; '>'myo'</span>,
    <span style='color:#2a00ff; '>'hya'</span>, <span style='color:#2a00ff; '>'hyu'</span>,        <span style='color:#2a00ff; '>'hyo'</span>,
    <span style='color:#2a00ff; '>'nya'</span>, <span style='color:#2a00ff; '>'nyu'</span>,        <span style='color:#2a00ff; '>'nyo'</span>,
    <span style='color:#2a00ff; '>'bya'</span>, <span style='color:#2a00ff; '>'byu'</span>,        <span style='color:#2a00ff; '>'byo'</span>,
    <span style='color:#2a00ff; '>'pya'</span>, <span style='color:#2a00ff; '>'pyu'</span>,        <span style='color:#2a00ff; '>'pyo'</span>,
    <span style='color:#2a00ff; '>'dya'</span>, <span style='color:#2a00ff; '>'dyu'</span>,        <span style='color:#2a00ff; '>'dyo'</span>,
    <span style='color:#2a00ff; '>'fa'</span>,  <span style='color:#2a00ff; '>'fi'</span>,  <span style='color:#2a00ff; '>'fe'</span>,  <span style='color:#2a00ff; '>'fo'</span>,
           <span style='color:#2a00ff; '>'wi'</span>,  <span style='color:#2a00ff; '>'we'</span>,  <span style='color:#2a00ff; '>'wo'</span>,
    <span style='color:#2a00ff; '>'va'</span>,  <span style='color:#2a00ff; '>'vi'</span>,  <span style='color:#2a00ff; '>'ve'</span>,  <span style='color:#2a00ff; '>'vo'</span>,
           <span style='color:#2a00ff; '>'ti'</span>,
           <span style='color:#2a00ff; '>'di'</span>
];

<span style='color:#3f7f59; '>//----/end character tables-----------------------------------------------------</span></code>


<p>The "combo" tables represent larger Japanese phonics that are written with two characters.
We need to search and replace these first in order to prevent splitting any of them up
by searching and replacing single characters first.</p>

<p>Note that we don't define a "comboHiragana" table because we can get that
by computing <code>comboKatakana.str_replace(coreKatakana, coreHiragana);</code>
if we need to.</p>

<p><code>romaji_to_hira()</code> is going to now look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Convert romaji to hiragana</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> romaji_to_hira(romajiString)
{
    <span style='color:#3f7f59; '>//replace combos first</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> katakana = romajiString
            .str_replace(comboRomaji, comboKatakana)
            .str_replace(coreRomaji, coreKatakana);
    
    <span style='color:#3f7f59; '>//force hiragana</span>
    <span style='color:#7f0055; font-weight:bold; '>return</span> kata_to_hira(katakana);
}</code>

<p>We accept a string in romaji (abc) and then run <code>String.str_replace()</code> on it <em>twice</em> using
a technique called chaining. We replace combo characters first and then single
characters.
We now have a converted string in katakana, but as the function name implies we want
to return hiragana. We return the katakana as modified by <code>kata_to_hira()</code> which we
implement, again in <code class="file">linguistics.js</code>, thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Convert katakana to hiragana</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> kata_to_hira(katakanaString)
{
    <span style='color:#7f0055; font-weight:bold; '>return</span> katakanaString.str_replace(coreKatakana, coreHiragana);
}</code>

<p>Here we simply replace all katakana with the corresponding hiragana.
We don't need to bother with combo characters here as this will
cover all cases.</p>

<p>The English search route is ready to go! Give it a whirl by searching for some
words and seeing what - if any - results you get. To be double dog sure
that we are trying exact definition matches first and then falling back to 
partial matches, have a peek at the <code class="file">websql_edict_inserts.sql</code> file again
and pick out some definitions to searh for.</p>

<p>In fact, we've not had any screenshots of the app for a while so let's have 
one for each type of search (kanji, kana, English exact, English partial):</p>

<div class="figure">
    <img src="img/figure/fig_310.png">
    <p>Figure 31. Respective results for kanji, kana, English (exact matches found) and English (partial matches found) queries</p>
</div>

<p>Great! Though looking at these reminds us that we still need to,
in <code>putResultsOnPage()</code> of <code class="file">search_interface.js</code>, somehow convert the kana
field from the database into romaji to make our result lines easier to understand.
In that function, change this bit:</p>

<code class="multiline">var theRomaji = item.kana;    //TODO</code>

<p>to this:</p>

<code class="multiline">var theRomaji = kana_to_romaji(item.kana);</code>

<p>Let's implement <code>kana_to_romaji()</code> in <code class="file">linguistics.js</code> and it will be somewhat the opposite
of our current <code>romaji_to_hira()</code>. <code>kana_to_romaji()</code> is like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Convert kana (hira or kata) to romaji</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> kana_to_romaji(kanaString)
{
    <span style='color:#3f7f59; '>//force katakana</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> kata = hira_to_kata(kanaString);
    
    <span style='color:#3f7f59; '>//transliterate</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> withChiisaiTsu = kata.str_replace(comboKatakana, comboRomaji)
                            .str_replace(coreKatakana, coreRomaji);
    
    <span style='color:#3f7f59; '>//fix any remaining chiisai tsu's</span>
        <span style='color:#3f7f59; '>//before 'chi' (make "tchi")</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> romaji = withChiisaiTsu.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>ッchi</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>, <span style='color:#2a00ff; '>'tchi'</span>);
        <span style='color:#3f7f59; '>//before anything else (double the consonant)</span>
    romaji = romaji.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>ッ</span><span style='color:#2a00ff; '>(</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>a</span><span style='color:#2a00ff; '>-</span><span style='color:#2a00ff; '>z</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>{</span><span style='color:#2a00ff; '>1</span><span style='color:#2a00ff; '>}</span><span style='color:#2a00ff; '>)</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>$1$1</span><span style='color:#2a00ff; '>"</span>);
    
    <span style='color:#3f7f59; '>//TODO katakana style 'ー' (which might actually be '-' in the input string)</span>
    romaji = romaji.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>(</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>^</span><span style='color:#2a00ff; '>0</span><span style='color:#2a00ff; '>-</span><span style='color:#2a00ff; '>9</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>)</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>-</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>(</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>^</span><span style='color:#2a00ff; '>0</span><span style='color:#2a00ff; '>-</span><span style='color:#2a00ff; '>9</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>)</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>$1ー$2</span><span style='color:#2a00ff; '>"</span>);
    romaji = romaji.<span style='color:#7f0055; font-weight:bold; '>replace</span>(<span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>(</span><span style='color:#2a00ff; '>[</span><span style='color:#2a00ff; '>a</span><span style='color:#2a00ff; '>-</span><span style='color:#2a00ff; '>z</span><span style='color:#2a00ff; '>]</span><span style='color:#2a00ff; '>{</span><span style='color:#2a00ff; '>1</span><span style='color:#2a00ff; '>}</span><span style='color:#2a00ff; '>)</span><span style='color:#2a00ff; '>ー</span><span style='color:#2a00ff; '>/</span><span style='color:#7f0055; font-weight:bold; '>g</span>, <span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>$1$1</span><span style='color:#2a00ff; '>"</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>return</span> romaji;
}</code>

<p>Again it's best to think of this as a black box, but what it's doing is the opposite of 
<code>romaji_to_hira()</code> but with some extra cleanup steps at the end.
Searching for anything now has romaji (abc) in brackets on each result line:</p>

<div class="figure">
    <img src="img/figure/fig_320.png">
    <p>Figure 32. We now get each result word spelled out in abc (romaji)</p>
</div>

<p>Sweet!</p>

<p>Before scrolling - which will be epic - there's just one more niggle. You might have noticed so far that we
can get search results by clicking the search button, but <strong>not</strong> by pressing enter (or equivalent)
on the on-screen keyboard after we've typed the search term.
Correctly implemented HTML forms will let you press enter in a text input field
to submit the form. It will perform the same as clicking the form's submit button.
We don't technically have a &lt;form> here - as we aren't submitting to a remote server, it's all client-side - but we should emulate this behaviour because:</p>

<ul>
<li>Other apps do it</li>
<li>It is expected UX and is "normal"</li>
</ul>

<p>It is surprisingly easy to implement, we simply need a handler for <em>keypress</em> events on
the search input. This event fires every time a character is typed and then inserted into a text
input or textarea etc. The event will tell us which key was pressed and we simply need to
treat the ENTER key as a special case because we then want to do some processing (and not put a character
into the text field).</p>

<p>Stick a:</p>

<code class="multiline">configureSearchInput();</code>

<p>at the bottom of <code>receivedEvent()</code> in <code class="file">index.js</code>.
Define this function in <code class="file">search_interface.js</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//search box ENTER keypress</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureSearchInput()
{
    document.getElementById(<span style='color:#2a00ff; '>'search-query'</span>).addEventListener(<span style='color:#2a00ff; '>'keypress'</span>, onkeyForSearchInput, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>We set <code>onkeyForSearchInput()</code> as the keypress handler for our search text input.
<code>onkeyForSearchInput()</code> also lives in <code class="file">search_interface.js</code> and is this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Simulate a "normal" HTML form input by allowing an ENTER press in the</span>
<span style='color:#3f7f59; '>//query input to perform the same as clicking the search button</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> onkeyForSearchInput(event)
{
    <span style='color:#3f7f59; '>//.charCode or .keyCode ??</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(event.keyCode == 13) <span style='color:#3f7f59; '>//ENTER key</span>
    {
        <span style='color:#3f7f59; '>//trigger the already registered "click" handler</span>
        document.getElementById(<span style='color:#2a00ff; '>'search-button'</span>).click();
    }
}</code>

<p>We simply use the keyCode property of the received event to detect an ENTER press
and then call the already registered click handler for the search button.
For anything other than ENTER, we "do nothing".
How we call the click handler manually is worth talking about. We simply
get the relevant DOM element using <code>document.getElementById()</code> (or you could use <code>document.querySelector()</code>
or what-have-you) and then call <code>.click()</code> on it. This will trigger the registered click
handler for that element.</p>

<p>You'll be wondering now "but our click handler for the search button receives a mouse event
 - a click in fact. What will it receive in this case?"
Interestingly, after manually calling <code>.click()</code> on an element, that element's click handler
will be triggered with a <em>dummy</em> mouse event (where, for example, the x and y coordinates are zero
and etc). Depending on what you do with the mouse event in the click handler, it may or may
not make sense to call it manually with <code>.click()</code>. In our case, the click handler doesn't
even use the received event, and so we are fine.</p>

<p>Give it a whirl! You can now search by hitting the ENTER (or equivalent) key after typing a search term. It will work on desktop Chrome or your device!
Sweet!</p>


<h3 id="the_search_tab_iv">Results scrolling</h3>

<p>The final epic thing on our Search tab is results scrolling. You've probably
already noticed that if your search produces lots of results, it is simply clipped
at the bottom of the screen (actually just above our footer). If you haven't noticed
this yet, then try searching for "it's" and you'll see the problem.</p>


<p>With desktop Chrome, you can scroll as per normal with the scrollbar that appears - or your mouse wheel.
In fact, the search box and search button also scroll
because this is the <code>japxlate_app</code> div that is scrolling,
due to CSS <code>overflow:auto;</code></p>

<p>So why don't we have scrollbars or scrollability
on the device?
It's because the Android WebView browser (and the
stock browser app) will only allow scrolling when
the entire html document itself is larger than
the viewport. Even then it doesn't show scrollbars.
It would be very very fiddly on a small mobile screen
if, say, the html document itself was scrollable and then
a small div inside of that was scrollable too! This
is why CSS scrolling does not work on WebView.</p>

<p>What we need to do is to use browser events to implement
our own scrolling for search results. Also, let's limit
scrollability to our #results-wrapper div so that
we don't scroll the search box and button.</p>

<p>So, we probably want to detect a finger drag on the results
and then scroll based on that. And we've just seen that
the DOM event of "click" (on the search button) worked for
both mouse clicks and finger taps.
So, to detect a finger drag on our device we can probably
just detect a "mousemove" event or something like that huh?
Annoyingly no. The "traditional" DOM mouse events of
"mousedown", "mousemove" and "mouseup" do NOT get triggered
in WebView when putting a finger down, moving and then
releasing the finger. This is initially very annoying and
confusing, but it makes sense really because of things
like multi-finger gestures which obviously have no parallel on a mouse. Maybe in the future there will
even be pressure sensitive mobile screens?</p>

<p>The events in question are touchstart, touchmove and touchend.
These somewhat correlate to the mousedown, mousemove, and
mouseup events. Remembering that the parent #results-wrapper div is actually our
static "window" on the search results, we need to attach scrolling behaviour to
#search-results which is where the search result content gets written to.</p>

<p>Mosey on back to <code>receivedEvent()</code> in <code class="file">index.js</code> and stick a call to:</p>

<code class="multiline">configureSearchTouchScrolling();</code>

<p>at the bottom. And yes, you've guessed it, we are going to define this function in <code class="file">search_interface.js</code>
. thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//configure touch dragging for search results</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureSearchTouchScrolling()
{
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'touchstart'</span>, touchstartForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'touchmove'</span>, touchmoveForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'touchend'</span>, touchendForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>We simply register one custom handler function for each of the touch events.
To get the ball rolling, define placeholders for these handlers - still in <code class="file">search_interface.js</code> - thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Touchstart event handler for search results div - initiates touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchstartForSearchResults(event)
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'touchstart'</span>);
}

<span style='color:#3f7f59; '>//Touchmove event handler for search results div - performs touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchmoveForSearchResults(event)
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'touchmove'</span>);
}

<span style='color:#3f7f59; '>//Touchend event handler for search results div</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchendForSearchResults(event)
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'touchend'</span>);
}</code>

<p>This is now runnable but note that it won't do anything on your desktop Chrome as
nothing can trigger touch events! So run this on your device, search for "it's" (a good
test as it matches a <strong>lot</strong> of entries) and then drag your finger up and down over the results.
Your Eclipse LogCat will show something like this:</p>

<div class="figure">
    <img src="img/figure/fig_330.png">
    <p>Figure 33. Touch events captured in LogCat</p>
</div>

<p>Nice! Of interest is that if you <em>tap</em> the results, you'll trigger a touchstart immediately followed
by a touchend. ie. there will be no "move".</p>
<p>Cool, so we are already catching the events that we need for scrolling, we just need to scroll!
What we'll do is we'll get the y (or vertical) coordinate of wherever the finger was moved to,
and use that to change the CSS top property of #search-results accordingly. Remember that we
set #search-results to <code>position:relative;</code> which means that we can set its "top" property to any value (in pixels)
that we like. A negative top will move the results up and a positive top will move the results down.
Essentially, if a finger touches at y=60 and then moves up to y=30 (a lower y is higher up the screen)
we know that we should move the results div up by 30; which is to say a top value of -30px.</p>

<p>OK, we've already got three different touch events each with its own handler function.
I'm thinking already that we are going to need some evil global variables to store
things that will be shared between these handlers. For example, finger y positions and so on.
Stick these at the top of <code class="file">search_interface.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//start y axis position (in pixels) of the current scroll</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_scrollStartY;

<span style='color:#3f7f59; '>//current 'top' css value (in pixels) of our scrollable div</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_scrollDivTop;

<span style='color:#3f7f59; '>//height (in pixels) of our viewport over the scrollable div (used to activate scrolling)</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_scrollWindowHeight;

<span style='color:#3f7f59; '>//current height (in pixels) of our scrollable div's content (used to activate scrolling and for scroll locking)</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_scrollDivHeight;</code>

<p>For every finger scroll we want to know the start y of the results div and the start y of the finger.
Then we can find out how far up (or down) the finger moves and simply subtract (or add) this to the
top value of the results div. We also need to know (a) do we need scrolling at all? and (b) when to
stop scrolling to prevent content being scrolled off the viewport! For both (a) and (b) we save the height
of the scrollable content and the height of the scroll viewport.
We saw earlier from fiddling with the device screen and looking at LogCat that finger scrolling
is split into three steps; touchstart, touchmove then touchend. We'll map these three different
events to three different steps for our scrolling. Thus:</p>

<ul>
<li>touchstart => finger scrolling <em>may</em> start</li>
<li>touchmove => finger scrolling happening now!</li>
<li>touchend => finger scrolling (if it was happening at all) has stopped</li>
</ul>

<p>Sidenote now, but have you noticed that we are no longer able to debug results scrolling in
desktop Chrome? To get rid of this annoyance, we'll implement our touch scrolling in as generic
a way as possible so that we can - a little bit later in the tutorial - add <em>simulated</em> touch
scrolling by using mouse events instead of touch events.</p>

<p>OK, go back to <code>touchstartForSearchResults()</code> and <code>touchmoveForSearchResults()</code> and make them look
a bit like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Touchstart event handler for search results div - initiates touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchstartForSearchResults(event)
{
    <span style='color:#3f7f59; '>//console.log('touchstart');</span>
    
    touchobj = event.changedTouches[0]; <span style='color:#3f7f59; '>//reference *first* touch point</span>
  
    startVerticalDragScrolling(<span style='color:#7f0055; font-weight:bold; '>this</span>, touchobj.clientY);
    
    event.preventDefault(); <span style='color:#3f7f59; '>//prevent default tap behavior</span>
}

<span style='color:#3f7f59; '>//Touchmove event handler for search results div - performs touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchmoveForSearchResults(event)
{
    <span style='color:#3f7f59; '>//console.log('touchmove');</span>
    
    touchobj = event.changedTouches[0]; <span style='color:#3f7f59; '>//reference first touch point for this event</span>
    
    doVerticalDragScrolling(<span style='color:#7f0055; font-weight:bold; '>this</span>, touchobj.clientY);
    
    event.preventDefault();
}</code>

<p>Well we don't do much in these handler functions themselves, other than call soon-to-be-written
helper functions and then preventing the default action for the touch event in question.
We bundle away scroller functionality into helper functions to keep things nice and generic
which will help us later when we go back and get scrolling working with the mouse.
As the default behaviour for dragging a finger over some text would be to select that text,
we prevent this default.</p>

<p>The key point here is how to use the touch event that we receive.
Touch events contain a <code>changedTouches</code> property which is an array of touch objects.
Each touch object in the array represents a single touch directly involved in
this event. Which for touchstart means all the fingers that hit the screen, and for
touchmove means all the fingers that moved.</p>

<p>As we don't need or want to do anything fancy with
multi touch gestures on Japxlate, we can simply
access <code>.changedTouches[0]</code> and ignore the rest.
There will always be at least one touch object
in <code>changedTouches[0]</code>, and there may or may not be more.</p>

<p>We pass the clientY property of our touch object to 
our helper functions. As the first argument, we also pass 'this',
which if you remember for event handler functions
means the element that the event triggered on - in this
case the search results div.</p>

<p>See <a href="http://www.javascriptkit.com/javatutors/touchevents.shtml">http://www.javascriptkit.com/javatutors/touchevents.shtml</a> for more
about touch events in JavaScript.</p>



<div class="sidenote">
NOTETOSELF
SIDNOTE about the different JavaScript event coordinate systems

[dont 4get that for mobile there is one extra which is the current poz of the small device window on the bigger client window
</div>

<p>OK, so the meat-and-bones of scrolling are bundled away in helper functions.
Let's have a look at our scroll initiator - <code>startVerticalDragScrolling()</code> - first
of all:</p>

<code class="multiline"><span style='color:#3f7f59; '>//initialise vertical scrolling for ontouchmove</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> startVerticalDragScrolling(elementToScroll, eventClientY)
{
    <span style='color:#3f7f59; '>//console.log('initialise scrolling');</span>
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> theStyle = window.getComputedStyle(elementToScroll);
    
    global_scrollDivTop = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(theStyle.top);  <span style='color:#3f7f59; '>//get 'top' value of box</span>
    global_scrollStartY = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(eventClientY); <span style='color:#3f7f59; '>// get x coord of touch point</span>
    
    global_scrollDivHeight = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(theStyle.height); <span style='color:#3f7f59; '>//get 'height' value of box</span>
    
    <span style='color:#3f7f59; '>//work out height of #search-results versus height of results</span>
    <span style='color:#3f7f59; '>//pane (which is .japxlate_app.height - #search-form.height)</span>
    global_scrollWindowHeight =
        <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(
            window.getComputedStyle(
                document.querySelector(<span style='color:#2a00ff; '>'.japxlate_app'</span>)
            ).height, 10) -
            
            <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(
                window.getComputedStyle(
                    document.querySelector(<span style='color:#2a00ff; '>'#search-form'</span>)
            ).height);
}</code>

<p>So we expect to receive an elementToScroll which could be any old element (but with the right CSS
settings) but in our case will be the search-results div. We also expect an eventClientY value.</p>

<p>All we do in this function is save elementToScroll's CSS top value, and eventClientY to the
global variables we defined earlier on. The novelty here is the use of <code>window.getComputedStyle()</code>
which will return the CSS style properties of the specified element, but <strong>not</strong> the developer defined
style as per a CSS stylesheet rule or an inline <code>style="something"</code> attribute. Rather this
will return the CSS properties that the browser's rendering engine has given to the element to
display it where it is. This method is useful to get <em>natural</em> CSS values for elements
that we haven't styled ourselves very aggressively - or at all.</p>


<p>We also save the height of the results div (global_scrollDivHeight) and the height
of the results pane. (The results pane being all the space in .japxlate_app div
<em>under</em> the search form). We do this so we can work out if we actually
need to scroll at all! Note that to get the height of the results pane,
we subtract the height of the search form from the total height of .japxlate_app.
We get the height of the search form by getting the height of the #search-form
wrapper div which we need to implement in <code class="file">index.html</code> thus:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"search"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"search-form"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"search-button"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>float</span>:right; <span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-right</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/search.png"</span><span style='color:#7f0055; '>></span>
            Search
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> id=<span style='color:#2a00ff; '>"button-spinner"</span> src=<span style='color:#2a00ff; '>"img/spinner.gif"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>visibility</span>:hidden;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>input</span> type=<span style='color:#2a00ff; '>"text"</span> id=<span style='color:#2a00ff; '>"search-query"</span> placeholder=<span style='color:#2a00ff; '>"Japanese or English"</span> size=<span style='color:#2a00ff; '>"40"</span>
               style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-left</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>br</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> id=<span style='color:#2a00ff; '>"loading-text"</span><span style='color:#7f0055; '>></span>
            [Loading core dictionary. This takes a while the first time.
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/spinner.gif"</span><span style='color:#7f0055; '>></span>]
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"results-wrapper"</span><span style='color:#7f0055; '>></span>
    &vellip;
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    &vellip;
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>


<p>That's the initiator, now on the the actual scroller which is, of course, going to be
a bit more complex. We need to use the global values we just saved to work out how
far we've scrolled and then move the results div accordingly. We also should
check if we need to do any scrolling at all - there might be no overflow of content!</p>

<p>A first bash looks like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//do vertical scrolling for ontouchmove</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> doVerticalDragScrolling(elementToScroll, eventClientY)
{
    <span style='color:#3f7f59; '>//console.log('do scrolling');</span>
    
    <span style='color:#3f7f59; '>//if height of results content is less than height of results pane,</span>
    <span style='color:#3f7f59; '>//we have no content overflow and so don't need to scroll    </span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(global_scrollDivHeight &lt; global_scrollWindowHeight)
    {
        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'no overflow'</span>);
        <span style='color:#7f0055; font-weight:bold; '>return</span>;
    }
    
    <span style='color:#3f7f59; '>//calculate distance travelled by touch point</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> distance = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(eventClientY) - global_scrollStartY;
    
    <span style='color:#3f7f59; '>//new CSS top for elementToScroll</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> newTop = global_scrollDivTop + distance;
    
    <span style='color:#3f7f59; '>//set the new top value for the div we are moving</span>
    elementToScroll.style.top = newTop + <span style='color:#2a00ff; '>'px'</span>;
}</code>

<p>First and foremost, we return immediately if we see that we don't need to do any scrolling
because the results content div is shorter than the results pane. This prevents the user from
being able to scroll a single result up and down the pane!
Next, we have to work out how far away we are from the touch start point. This distance
becomes the amount we have to add to - or subtract from - the top value of the results
div.
We access the CSS top value directly with <code>elementToScroll.style.top</code>.</p>

<p>This works! Run it on you device! Nice! Just one problem, which we can see with
these screenshots:</p>

<div class="figure">
    <img src="img/figure/fig_340.png">
    <p>Figure 34. We can scroll content past the top (left) and bottom (right) of the scroll viewport</p>
</div>

<p>Currently, we can scroll the content too far in either direction.
We can fix this by editing <code>doVerticalDragScrolling()</code> to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//do vertical scrolling for ontouchmove</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> doVerticalDragScrolling(elementToScroll, eventClientY)
{
    <span style='color:#3f7f59; '>//console.log('do scrolling');</span>
    
    <span style='color:#3f7f59; '>//if height of results content is less than height of results pane,</span>
    <span style='color:#3f7f59; '>//we have no content overflow and so don't need to scroll    </span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(global_scrollDivHeight &lt; global_scrollWindowHeight)
    {
        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'no overflow'</span>);
        <span style='color:#7f0055; font-weight:bold; '>return</span>;
    }
    
    <span style='color:#3f7f59; '>//calculate distance travelled by touch point</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> distance = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(eventClientY) - global_scrollStartY;
    
    <span style='color:#3f7f59; '>//new CSS top for elementToScroll</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> newTop = global_scrollDivTop + distance;
    
    <span style='color:#3f7f59; '>//disallow scrolling bottom of content higher than bottom of results pane</span>
    <span style='color:#3f7f59; '>//(using height of results pane)</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(newTop &lt; ((0 - global_scrollDivHeight) + global_scrollWindowHeight))
    {
        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'top cushion'</span>);
        <span style='color:#7f0055; font-weight:bold; '>return</span>; <span style='color:#3f7f59; '>//return false??</span>
    }
    
    <span style='color:#3f7f59; '>//disallow scrolling top of content lower than top of results pane</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(newTop > 0)
    {
        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'bottom cushion'</span>);
        <span style='color:#7f0055; font-weight:bold; '>return</span>; <span style='color:#3f7f59; '>//return false?</span>
    }
    
    <span style='color:#3f7f59; '>//set the new top value for the div we are moving</span>
    elementToScroll.style.top = newTop + <span style='color:#2a00ff; '>'px'</span>;
}</code>

<p>(The changes are the two <code>if</code> clauses before the final <code>elementToScroll.style.top</code>.)
To stop the top of the results going lower than the top of the results pane, we simply
prevent the results div's top property from going higher than zero.
To prevent the bottom of the results from going higher than the bottom of the results pane,
we have to prevent the top value from going less than negative(results height + results pane
height). If the height of the results is 1000 pixels, and we set the results div top to -1000 pixels,
this will put the bottom of the results right at the top of the results pane. From this
state, adding, to top, the height of the results div will put the bottom of the results at the
bottom of the results pane. This is the minimum height we enforce here.
[NOTETOSELF the height of the results div.(?)]
</p>

<p>Run this on your device and you'll see that scrolling is "locked" and behaves
more like native Android.</p>

<p>Great, just one more problem which you might already be thinking about.
Run the app and search for "it's" which produces lots of results. Scroll right to the
bottom of the results. No problems there. But then do a search that only gives a few results
like "gas". Eh? Where are the results? Well, when you scrolled to the bottom of the results
for "it's" you moved the top value of the search results div to quite a high negative number.
This means that the top of the div is very high up on the page, probably higher
that the top of the screen! When you search again, the div is still up there and a short
amount of content will be obscured and not "reach down" to the visible results pane.
Clearly we need to reset the search result div's top on every display of search results.
We can do this quite easily by a simple addition to <code>putResultsOnPage()</code> in
our <code class="file">search_interface.js</code> file. Edit the start of this function to look like:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> putResultsOnPage(results)
{
    <span style='color:#3f7f59; '>//get search results div</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> theDiv = document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>);
    
    <span style='color:#3f7f59; '>//clear current content</span>
    theDiv.innerHTML = <span style='color:#2a00ff; '>''</span>;
    
    <span style='color:#3f7f59; '>//reset Y position because it might have changed after some touch scrolling frenzy!</span>
    theDiv.style.top = <span style='color:#2a00ff; '>'0'</span>;
    &vellip;
}</code>

<p>The only change here is the new line setting <code>style.top</code> to zero. This is all we need to
fix the scroll problem we've just experienced. Try it!</p>

<p>Money in the bank! Searching and scrolling is operational now and we are ready
to move on to the next tab. But do you remember we talked about, for debugging purposes,
simulating the touch scrolling with mouse events for desktop Chrome? Here's a whistle-stop tour
on getting that working:</p>

<p>At the top of <code class="file">search_interface.js</code> put:</p>
<code class="multiline">var global_mouseButtonDown = false;</code>

<p>At the bottom of <code>receivedEvent()</code> in <code class="file">index.js</code> put:</p>

<code class="multiline">configureSearchMouseScrolling();</code>

<p>In <code class="file">search_results.js</code> add:</p>

<code class="multiline"><span style='color:#3f7f59; '>//configure mouse dragging for search results</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureSearchMouseScrolling()
{
    <span style='color:#3f7f59; '>//simulated touch (ie. mouse) dragging for results</span>
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'mousedown'</span>, mousedownForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'mousemove'</span>, mousemoveForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    document.getElementById(<span style='color:#2a00ff; '>'search-results'</span>)
            .addEventListener(<span style='color:#2a00ff; '>'mouseup'</span>, mouseupForSearchResults, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code> 

<p>In <code class="file">search_interface.js</code> add:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Mousedown event handler for search results div - initiates simulated touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mousedownForSearchResults(event)
{
    <span style='color:#3f7f59; '>//console.log('mousedown event on scrollable');</span>
    
    global_mouseButtonDown = <span style='color:#7f0055; font-weight:bold; '>true</span>;  <span style='color:#3f7f59; '>//set global</span>
    
    startVerticalDragScrolling(<span style='color:#7f0055; font-weight:bold; '>this</span>, event.clientY);
    
    event.preventDefault(); <span style='color:#3f7f59; '>//prevent default click behaviour (ie. select text or whatever)</span>
}

<span style='color:#3f7f59; '>//Mousemove event handler for search results div - performs simulated touch scrolling</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mousemoveForSearchResults(event)
{
    <span style='color:#3f7f59; '>//console.log('mousemove event on scrollable');</span>
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(!global_mouseButtonDown)
    {
        <span style='color:#7f0055; font-weight:bold; '>return</span> <span style='color:#7f0055; font-weight:bold; '>false</span>;   <span style='color:#3f7f59; '>//do nothing if the mouse button isn't pressed down</span>
        <span style='color:#3f7f59; '>//false is ok to return?</span>
    }
    
    doVerticalDragScrolling(<span style='color:#7f0055; font-weight:bold; '>this</span>, event.clientY);
    
    event.preventDefault();
}

<span style='color:#3f7f59; '>//Mouseup event handler for search results div</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mouseupForSearchResults(event)
{
    <span style='color:#3f7f59; '>//console.log('mouseup event on scrollable');</span>
    
    global_mouseButtonDown = <span style='color:#7f0055; font-weight:bold; '>false</span>;
    event.preventDefault(); <span style='color:#3f7f59; '>//need?</span>
}</code> 

<p>We simply recycle our existing scrolling helpers. The biggest difference is
we need to track if the mouse button is down or not as we don't
want to scroll on a mousemove when the mouse button isn't down.</p>

[NOTETOSELF mention using libraries for mobile touch scrolling etc]
[NOTETOSELF and the android webkit hack that you found]

<h3 id="the_search_tab_v">Extra credit challenges</h3>

<p>Solutions not provided. Try to add:</p>

<ol>
<li>"Content has become scrollable" indicator</li>
<li>"Can't scroll anymore" indicator (the "flare" that native Android scrolling usually has)</li>
<li>Our scrolling lacks the slippy, momentous feel that native Android scrolling usually has. Try to add this (this will be very challenging!).</li>
</ol>



<h2 id="the_discover_tab">The <em>Discover</em> tab</h2>

<h3 id="the_discover_tab_i">Layout and interface</h3>

<p>Now we move on to our second tab, Discover. This is going to be much simpler than the
previous tab so don't worry! This chapter is a bit of a breather before we move on to
the more complex Write tab.</p>

<p>The discover tab is simply going to be a passive list of the latest Japanese words
as tweeted by the <a href="https://twitter.com/japxlate">@japxlate</a> bot. There will be no interactivity.</p>

<p>Note that, to speed up development and debugging, we can temporarily set the Discover tab to
be the app's default tab. This saves you having to tap on the tab every time you run the app when following
this chapter. Simply move the <code>class="current"</code>s off the Search tab and content div and onto the Discover tab and content div.</p>

<p>Conveniently, anyone with a Twitter account can go into Settings --> Widgets
and create embeddable timeline widgets - of their own feed or anyone else's - 
based on User timeline, Favourites, List or Search.</p>

<p>I've set up a User timeline widget under the actual <a href="https://twitter.com/japxlate">@japxlate</a> account using these
settings:</p>

<div class="figure">
    <img src="img/figure/fig_350.png">
    <p>Figure 35. Creating a User timeline widget on Twitter</p>
</div>

<p>Note that in order to show only our tweets out (ie. word definitions) we exclude replies
and we do not auto-expand photos.
Note also that the widget <strong>must</strong> have a height in pixels - either the Twitter default or
your specification. After creating the widget, we get the similar-looking Configuration page:</p>

<div class="figure">
    <img src="img/figure/fig_360.png">
    <p>Figure 36. Configuring a User timeline widget on Twitter</p>
</div>

<p>This tells us that we can embed the widget anywhere we want by using this code snippet:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> class=<span style='color:#2a00ff; '>"twitter-timeline"</span> href=<span style='color:#2a00ff; '>"https://twitter.com/japxlate"</span> data-widget-id=<span style='color:#2a00ff; '>"378630691635728384"</span><span style='color:#7f0055; '>></span>Tweets by @japxlate<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>!<span style='color:#7f0055; font-weight:bold; '>function</span>(d,s,id){<span style='color:#7f0055; font-weight:bold; '>var</span> js,fjs=d.getElementsByTagName(s)[0],p<span style='color:#2a00ff; '>=</span><span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>^</span><span style='color:#2a00ff; '>http:</span><span style='color:#2a00ff; '>/</span>.<span style='color:#7f0055; font-weight:bold; '>test</span>(d.location)?<span style='color:#2a00ff; '>'http'</span>:<span style='color:#2a00ff; '>'https'</span>;<span style='color:#7f0055; font-weight:bold; '>if</span>(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>://platform.twitter.com/widgets.js</span><span style='color:#2a00ff; '>"</span>;fjs.parentNode.insertBefore(js,fjs);}}(document,<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>script</span><span style='color:#2a00ff; '>"</span>,<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>twitter-wjs</span><span style='color:#2a00ff; '>"</span>);<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span></code>

<p>Which is a stylised &lt;a> element followed by some arcane looking JavaScript
which actually creates, programatically, a &lt;script> tag with the appropriate
JavaScript from Twitter to turn the &lt;a> element into the correct widget.
Clever!</p>

<p>Let's go ahead and stick this in the HTML for our Discover tab and see what happens.
Make the Discover tab in <code class="file">index.html</code> look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"discover"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span> class=<span style='color:#2a00ff; '>"twitter-timeline"</span> href=<span style='color:#2a00ff; '>"https://twitter.com/japxlate"</span> data-widget-id=<span style='color:#2a00ff; '>"378630691635728384"</span><span style='color:#7f0055; '>></span>
        Tweets by @japxlate (network connection required) <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/spinner.gif"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>!<span style='color:#7f0055; font-weight:bold; '>function</span>(d,s,id){<span style='color:#7f0055; font-weight:bold; '>var</span> js,fjs=d.getElementsByTagName(s)[0],p<span style='color:#2a00ff; '>=</span><span style='color:#2a00ff; '>/</span><span style='color:#2a00ff; '>^</span><span style='color:#2a00ff; '>http:</span><span style='color:#2a00ff; '>/</span>.<span style='color:#7f0055; font-weight:bold; '>test</span>(d.location)?<span style='color:#2a00ff; '>'http'</span>:<span style='color:#2a00ff; '>'https'</span>;<span style='color:#7f0055; font-weight:bold; '>if</span>(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>://platform.twitter.com/widgets.js</span><span style='color:#2a00ff; '>"</span>;fjs.parentNode.insertBefore(js,fjs);}}(document,<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>script</span><span style='color:#2a00ff; '>"</span>,<span style='color:#2a00ff; '>"</span><span style='color:#2a00ff; '>twitter-wjs</span><span style='color:#2a00ff; '>"</span>);<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>

<p>(Note here we have made Discover the default content div as mentioned before - make sure to also set the
Discover tab too.)</p>

<p>We've changed the &lt;a> inner text a bit. This text shows <em>before</em> the widget has loaded.</p>

<p>Running this looks like:</p>

<div class="figure">
    <img src="img/figure/fig_370.png">
    <p>Figure 37. Embed of default Twitter User timeline widget</p>
</div>

<p>Which is pretty much a disaster! We've got a header and footer to the widget that doesn't
make sense in this <em>read-only</em> context - we want just the tweets remember?
We've also got a scrollbar due to overflowing content - again we don't want this.
Digging deeper into the Twitter documentation, we see from <a href="https://dev.twitter.com/docs/embedded-timelines#customization">https://dev.twitter.com/docs/embedded-timelines#customization</a>
that adding:</p>

<code class="multiline">data-chrome="noheader nofooter"</code>

<p>to the &lt;a> tag will remove the header and footer. ("Chrome" here means the framing and embellishment
of the widget - not Chrome browser!) 
Note that the <code>noscrollbar</code> option mentioned in the above Twitter documentation will only <em>visually</em> remove the scrollbar, scrollability is still present
and so we will instead remove scrollbars and scrollability with CSS techniques soon.</p>

<p>Add <code>data-chrome="noheader nofooter"</code> to the &lt;a> and running it looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_380.png">
    <p>Figure 38. Embed of headerless and footerless Twitter User timeline widget</p>
</div>

<p>The widget header and footer have indeed gone, but there is still the scrolling issue. Also, the widget
is rather narrow and doesn't take up the full width of the screen.
Debugging in desktop Chrome we can use the "inspect element" tool which is the magnifying glass
at the bottom of the F12 console. This tells us that the &lt;a> is replaced with an iframe.
An iframe is, simplistically, like an embedded browser window in your web page. This
will have ramifications for our app which we mention later on.</p>

<p>The above Twitter documentation for timelines says:
"Setting a width is not required, and by default the widget will shrink to the width of its parent element in the page." 
Which implies that if we put the &lt;a> in a parent div of <code>width:100%</code>, then the widget will fill the width
of the screen. Let's try it. Put the &lt;a> and &lt;script> in a parent tag thus:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"twitter-iframe-container"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>…<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>a</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>…<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>script</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>

<p>Then style this parent div in <code class="file">index.css</code> like this:</p>

<code class="multiline">#twitter-<span style='color:#7f0055; font-weight:bold; '>iframe</span>-container {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;  <span style='color:#3f7f59; '>/*can now position relative to .japxlate_app which is*/</span>
    <span style='color:#7f0055; font-weight:bold; '>top</span>:0;              <span style='color:#3f7f59; '>/*this div's first non-static parent*/</span>
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:0;
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>overflow</span>:hidden;    <span style='color:#3f7f59; '>/*clip overflowing content*/</span>
}</code>

<p>A <code>position:absolute</code> element can be positioned relative to its first non-static (static being <code>position:static</code> or the default position for when position is unspecified) parent.
For us here that means the .japxlate_app div which slots perfectly between the app header and footer.
Setting a top and bottom of zero here means our div will stretch to fill the area that .japxlate_app covers.
(Which conveniently gets rid of the <code>padding-top:1em;</code> we gave to .japxlate_app which is less
than useful here.)
So this is going to remove the Twitter widget scrolling and width issues you say? Check it out:</p>

<div class="figure">
    <img src="img/figure/fig_390.png">
    <p>Figure 39. Widget scrolling removed but only for desktop Chrome</p>
</div>

<p>OK, so scrolling is fixed. <strong>But</strong> only on desktop Chrome and not the device. The widget width is also still static:</p>

<div class="figure">
    <img src="img/figure/fig_400.png">
    <p>Figure 40. Widget width is fixed and does not fill the available space</p>
</div>

<p>Well, we've got the perfect size <em>container</em> for this widget now, so what about forcing the
width and height of the generated &lt;iframe> to the full size of this container? It's actually
pretty easy to do this by adding some CSS rules for &lt;iframe>s in our <code class="file">index.css</code>:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>iframe</span> {
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>max-height</span>:100%;
}</code>

<p>We simply say that the &lt;iframe> should fill its parent's width, and should never go taller than
the parent's height.
Run this on your device and it works! You can go landscape or portrait and the widget always
fills the available width and never scrolls.</p>

<p>We mentioned earlier some issues with &lt;iframe>s. Well, the Discover widget timeline contains
any links that the tweets themselves contain. Also, there are some buttons for Twitter
"intents" like replying, favouriting and retweeting. Clicking on any link actually opens that
link in the &lt;iframe> - replacing the widget - which looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_410.png">
    <p>Figure 41. Links in the User timeline widget can be clicked - opening the page</p>
</div>

<p>Disaster! Clicking one of the Twitter intents (which would actually be kinda
cool to get working from the app), for example "reply", flows like this:</p>

<div class="figure">
    <img src="img/figure/fig_420.png">
    <p>Figure 42. Flow when clicking "reply" from timeline widget</p>
</div>

<p>So it already sorta kinda works in two different ways, but each has its issues. We are going to let this slide for the first release of the app, but this issue
really needs to be addressed. Perhaps the widget itself has some useful customisation options?
Or maybe links could be made to look non-linky by some CSS in our app? Or JavaScript
click catching?</p>




<h3 id="the_discover_tab_ii">Extra credit challenges</h3>

<p>Solutions not provided. Try to add:</p>

<ol>
<li>Disabling of clickable intents on tweets in the timeline widget OR..</li>
<li>..Correct functioning of the clickable intents when the Twitter app is selected (and not the browser)</li>
<li>Instead of simply displaying "(network connection required)", use the <a href="http://docs.phonegap.com/en/3.1.0/cordova_connection_connection.md.html#Connection">Connection API plugin</a> to properly detect if the device is currently online or not. If it's not online, then do something to inform the user that the Discover tab needs the device to be online.</li>
</ol>




<h2 id="the_write_tab">The <em>Write</em> tab</h2>

<h3 id="the_write_tab_i">Layout and interface</h3>

<p>Our third and final tab now which is Write. This is more complex than the previous
Discover tab, but slightly quicker to implement than the first Search tab - mostly
due to not having any scrolling woes to care about.</p>

<p>The write tab is going to be a little scratchpad area for the user to practice
writing Japanese phonic characters. We'll present a random character and then an empty
canvas for the user to finger draw the character. A wireframe might look like this:</p>

<div class="figure">
    <img src="img/figure/fig_430.png">
    <p>Figure 43. Quick wireframe of the Write tab layout</p>
</div>

<p>We simply present a character and a space for them to practice drawing it in.</p>

<p>Let's start with the markup, and a dollop of CSS, first. Edit the write &lt;div> of <code class="file">index.html</code>
to look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"write"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>p</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>text-align</span>:center;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>Write this character:
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>font-size</span>:2em;<span style='color:#2a00ff; '>"</span> id=<span style='color:#2a00ff; '>"char-to-write"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> id=<span style='color:#2a00ff; '>"char-explanation"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>p</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; '>canvas</span> id=<span style='color:#2a00ff; '>"paper"</span> width=<span style='color:#2a00ff; '>"300"</span> height=<span style='color:#2a00ff; '>"300"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; '>canvas</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>br</span><span style='color:#7f0055; '>></span>    
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"canvas-clear"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-right</span>:1%; <span style='color:#7f0055; font-weight:bold; '>float</span>:right;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/paste.png"</span><span style='color:#7f0055; '>></span> Clear
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"canvas-new"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-left</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/file.png"</span><span style='color:#7f0055; '>></span> New character
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>

<p>(Note that, like we did with the Discover tab, we've temporarily made this content div - and it's corresponding tab - 
<code>class="current"</code> to speed up our development a tad.)</p>

<p>We have an explanatory paragraph for our random character, and placeholders for both the character
to write (in a larger font) and its explanation.</p>

<p>Then comes the magic and the main focus of this chapter, the whizz-bang HTML5 &lt;canvas>
element which you may or may not have seen before. It's an element that allows for
programmatic and interactive display and manipulation of simple 2D graphics.
It's kind of like Microsoft Paint but in the browser and you have to program it with JavaScript.
(It's actually <em>waaaaay</em> better than I've just made it sound!)</p>

<p>If you've got alarm bells ringing because we appear to have hard-coded the canvas dimensions
(300px x 300px) then you are right. We will come back and improve this shortly.</p>

<p>We end with two buttons, a Clear button which we want to erase the user's scribbling so far,
and a New character button which will display a new random Japanese character to draw.
Well if you run all of this, it looks like:</p>

<div class="figure">
    <img src="img/figure/fig_440.png">
    <p>Figure 44. Initial Write tab appearance</p>
</div>

<p>Clearly the &lt;canvas> needs a bit of styling. Add a style for the &lt;canvas> element to
<code class="file">index.css</code> thus:</p>

<code class="multiline">canvas {
    <span style='color:#7f0055; font-weight:bold; '>border</span>:1px solid grey;
    <span style='color:#7f0055; font-weight:bold; '>background-color</span>:#ffa;  <span style='color:#3f7f59; '>/*Post-It yellow*/</span>
    <span style='color:#7f0055; font-weight:bold; '>margin-left</span>:auto;       <span style='color:#3f7f59; '>/*these two lines will*/</span>
    <span style='color:#7f0055; font-weight:bold; '>margin-right</span>:auto;      <span style='color:#3f7f59; '>/*centre the element horizontally*/</span>
    <span style='color:#7f0055; font-weight:bold; '>display</span>:block;
}</code>

<p>Running looks like this now:</p>

<div class="figure">
    <img src="img/figure/fig_450.png">
    <p>Figure 45. Write tab appearance with styled &lt;canvas></p>
</div>

<p>Better!</p>

<h3 id="the_write_tab_ii">Filling the screen</h3>

<p>Hmmm, but Android devices come in all shapes and sizes. What to do about the size of the canvas?
We would want, ideally, the biggest square (Japanese characters tend to be rather squareish) 
that would fit on the screen at that time - for portrait or lanscape.</p>

<p>We'll take an approach like this:</p>

<ol class="roman">
<li>Put the two buttons at the bottom of the screen</li>
<li>Make a containing &lt;div> for the &lt;canvas> that fills 100% of its available width and height
    (the height under "Write this character" and above the buttons, then the full width of the screen)</li>
<li>Set the size of the canvas to be the biggest <em>square</em> that will fit in this container. Centred
    in the container</li>
<li>When the device is rotated, we will have to resize the &lt;canvas> to be the biggest square
    in the newly created container size</li>
</ol>

<p>OK, tackling [i] and [ii] first, we need a new layout. We are going to do the same thing we did for
the app's header, content and footer; position them absolutely relative to parent. But this time the parent will be our .japxlate_app div.
Edit the write div in <code class="file">index.html</code> to look like this:</p>

<code class="multiline"><span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"write"</span> class=<span style='color:#2a00ff; '>"current"</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>p</span> id=<span style='color:#2a00ff; '>"write-intro"</span><span style='color:#7f0055; '>></span>Write this character: <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>font-size</span>:2em;<span style='color:#2a00ff; '>"</span> id=<span style='color:#2a00ff; '>"char-to-write"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
                <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>span</span> id=<span style='color:#2a00ff; '>"char-explanation"</span><span style='color:#7f0055; '>></span><span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>span</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>p</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"write-canvas-container"</span><span style='color:#7f0055; '>></span>
        <span style='color:#3f7f59; '>&lt;!--&lt;canvas id="paper" width="300" height="300">&lt;/canvas>--></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>div</span> id=<span style='color:#2a00ff; '>"write-buttons"</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"canvas-clear"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-right</span>:1%; <span style='color:#7f0055; font-weight:bold; '>float</span>:right;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/paste.png"</span><span style='color:#7f0055; '>></span> Clear
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
        <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>button</span> type=<span style='color:#2a00ff; '>"button"</span> id=<span style='color:#2a00ff; '>"canvas-new"</span> style=<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; font-weight:bold; '>width</span>:45%; <span style='color:#7f0055; font-weight:bold; '>margin-left</span>:1%;<span style='color:#2a00ff; '>"</span><span style='color:#7f0055; '>></span>
            <span style='color:#7f0055; '>&lt;</span><span style='color:#7f0055; font-weight:bold; '>img</span> src=<span style='color:#2a00ff; '>"img/file.png"</span><span style='color:#7f0055; '>></span> New character
        <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>button</span><span style='color:#7f0055; '>></span>
    <span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span>
<span style='color:#7f0055; '>&lt;/</span><span style='color:#7f0055; font-weight:bold; '>div</span><span style='color:#7f0055; '>></span></code>

<p>We've given the intro paragraph an id. We've commmented the &lt;canvas> out for the time being
but we've put it in a container div of #write-canvas-container.
The buttons have also been placed in a containing div of #write-buttons.
Now we need to position and size these elements such that the intro paragraph will be right at the
top, the buttons will be right at the bottom, and the canvas container will fill <strong>all</strong>
the space inbetween.
Add these CSS rules to <code class="file">index.css</code>:</p>

<code class="multiline">#write-intro {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>top</span>:0;              <span style='color:#3f7f59; '>/*absolute top of .japxlate_app*/</span>
    <span style='color:#7f0055; font-weight:bold; '>height</span>:40px;        <span style='color:#3f7f59; '>/*make arbitrarily big enough for our 2em character*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
    <span style='color:#7f0055; font-weight:bold; '>margin-bottom</span>:0;    <span style='color:#3f7f59; '>/*so #write-canvas-container is flush*/</span>
    <span style='color:#7f0055; font-weight:bold; '>margin-top</span>:10px;     <span style='color:#3f7f59; '>/*so we aren't directly under the navigation tabs*/</span>
    <span style='color:#7f0055; font-weight:bold; '>text-align</span>:center;  <span style='color:#3f7f59; '>/*centre text horizontally*/</span>
    <span style='color:#3f7f59; '>/*background-color:green;*/</span>
}

#write-canvas-container {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>top</span>:50px;           <span style='color:#3f7f59; '>/*make flush with #write-intro*/</span>
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:40px;        <span style='color:#3f7f59; '>/*stop 40px up from the botton of .japxlate_app*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;    
}

#write-buttons {
    <span style='color:#7f0055; font-weight:bold; '>position</span>:absolute;
    <span style='color:#7f0055; font-weight:bold; '>bottom</span>:0;           <span style='color:#3f7f59; '>/*absolute bottom of .japxlate_app*/</span>
    <span style='color:#7f0055; font-weight:bold; '>height</span>:40px;        <span style='color:#3f7f59; '>/*make flush with bottom of #write-canvas-container*/</span>
    <span style='color:#7f0055; font-weight:bold; '>width</span>:100%;
}</code>

<p>We simply make write-intro and write-buttons a little bit bigger than they need to be, and set
canvas container to fill the remaining space.
We set margin-top of #write-intro to 10px so that the intro paragraph text is not too close to the tabs
and so that we know the top of #write-canvas-container is 50px.
We have previously set padding-top of .japxlate_app to 1em but this is obliterated with the
<code>position:absolute</code> and <code>top:0</code> of #write-intro.
(So yes, we've set a default top padding of 1em on .japxlate_app but only used it in the Search tab
as we positioned over it on the Discover tab and this tab!).
If you like you can confirm the size and shape of these divs by setting a different background-color
in each of the CSS rules and then changing the size of desktop Chrome or rotating your device.</p>

<p>For [iii] we need to programatically get the dimensions of #write-canvas-container,
work out the biggest square that will fit in those dimensions (possibly trimming a bit off
so our canvas isn't too close to the buttons etc), and then dynamically add the appropriate
canvas element into #write-canvas-container - centreing it.</p>

<p>For [iv] we need to catch a device rotation event and then do the steps for [iii] again.</p>

<p>Create a file called <code class="file">canvas.js</code> in <code class="file">assets/www/js</code>. Include this JavaScipt file from the bottom
of <code class="file">index.html</code> (above the include for <code class="file">index.js</code>).</p>

<p>We are going to implement a function in <code class="file">canvas.js</code> called <code>adjustCanvas()</code> which will be our step
[iii]. <code>adjustCanvas()</code> looks like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//adjust - creating if necessary - the canvas element</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> adjustCanvas()
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> container = document.getElementById(<span style='color:#2a00ff; '>'write-canvas-container'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> style = window.getComputedStyle(container);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> width = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(style.width);
    <span style='color:#7f0055; font-weight:bold; '>var</span> height = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(style.height);
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> smallestDim = width;    <span style='color:#3f7f59; '>//smallest dimension is width (= portrait)</span>
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(height &lt; width)  <span style='color:#3f7f59; '>//ie. landscape</span>
    {
        smallestDim = height;
    }
    
    <span style='color:#3f7f59; '>//invisible frame around canvas so it's not flush with buttons etc</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> frameGap = 15;
    smallestDim -= (frameGap * 2);  <span style='color:#3f7f59; '>//gap at top and bottom (left and right)</span>
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> canvas = <span style='color:#7f0055; font-weight:bold; '>null</span>;  <span style='color:#3f7f59; '>//we proceed to get or create this</span>
    
    <span style='color:#3f7f59; '>//element existence check</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> firstTime = !document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(firstTime)   <span style='color:#3f7f59; '>//create canvas element with correct id</span>
    {
        canvas = document.createElement(<span style='color:#2a00ff; '>'canvas'</span>);
        canvas.id = <span style='color:#2a00ff; '>'paper'</span>;
        canvas.style.position = <span style='color:#2a00ff; '>'relative'</span>; <span style='color:#3f7f59; '>//so we can "top" the canvas down</span>
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span>    <span style='color:#3f7f59; '>//get existing canvas element</span>
    {
        canvas = document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    }
    
    <span style='color:#3f7f59; '>//size and position the canvas</span>
    canvas.width = smallestDim;
    canvas.height = smallestDim;
    canvas.style.top = frameGap + <span style='color:#2a00ff; '>'px'</span>;
    
    <span style='color:#3f7f59; '>//add canvas (as child of container) if first time</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(firstTime)
    {
        container.appendChild(canvas);
    }
}</code>

<p>Wow, this is our longest piece of JavaScript so far.
With the first two lines we get the container element for the &lt;canvas>, and its style.
We then save the width and height of the container.
We get the smallest dimension of the container (which will be the squared size of
our canvas) by assuming the container is portrait shaped. If container height is less than
container width, we say it is landscape shaped. (A perfectly square container will be covered by the
portrait assumption which will be fine as <em>any</em> of its side measurements is fine to use in that case.)
We then put an imaginary frame around the canvas of 15 pixels so that the bottom of the canvas
is not flush with our buttons.</p>

<p>Thinking ahead to step [iv], it would be nice if this function to set up the &lt;canvas> initially could
also be used to adjust the canvas for a device rotate.
We tackle this with the concept of "first time". Basically, if the function is happening for the first time
 - ie. the canvas does not exist - then it must <em>create</em> the canvas. If not the first time
then it simply needs to alter the existing canvas.
We action this by:</p>

<code class="multiline">var firstTime = !document.getElementById('paper');</code>

<p>Which relies on <code>document.getElementById('someId')</code> returning boolean false if an element with the id
of someId does not exist on the page.
So we get or create the canvas element and set its size to the smallest dimension of the container.
Minus our frame gap of course.
The first time around we have to insert the created &lt;canvas> element into the DOM
(<code>document.createElement('elementname');</code> creates the element in memory only)
which we do with <code>container.appendChild(canvas);</code>.</p>

<p>Go ahead and delete the line:</p>

<code class="multiline">canvas.style.position = 'relative';</code>

<p>and put that in the <code>canvas{}</code> rule in <code class="file">index.css</code> as that makes more sense.</p>

<p>Next, mosey on over to <code>firstLoadForTab_Write()</code> in <code class="file">japxlate.js</code> and add a call to
<code>adjustCanvas()</code> thus:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> firstLoadForTab_Write()
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'first load for write tab'</span>);
    
    adjustCanvas();    <span style='color:#3f7f59; '>//create canvas element of correct size</span>
    
    global_pagesLoaded.write = <span style='color:#7f0055; font-weight:bold; '>true</span>;
}</code>

<p>Remember <code>firstLoadForTab_Write()</code> is our one-off initialiser for the Write tab
and so running the app now looks like:</p>

<div class="figure">
    <img src="img/figure/fig_460.png">
    <p>Figure 46. &lt;canvas> now fills available space</p>
</div>

<p>Pretty good! You can test that the &lt;canvas> fills the available space by closing the page,
resizing the browser and loading the page again (desktop Chrome) or closing the app, rotating your phone,
reopening the app (device).

<p>OK, that was actually the easy bit! Our next step is [iv] and this is a bit fiddly as we
need to figure out how to detect a device rotation.</p>

<p>Well, the proper way is to catch the "orientationchange" event (of the window object)
with a handler.
(Interestingly there is no PhoneGap API to do this.)
 Orientationchange will fire for each and every orientation <em>change</em>
of the device. And then in that handler you can use the window.orientation
property to work out the device orientation.
Window.orientation will be 0 meaning portrait,
90 meaning landscape (top of phone pointing right) or
-90 meaning landscape (top of phone pointing left).
These values represent the number of degrees the phone has
been rotated from the resting - or zero - position which is
portrait.
Android does not allow the screen to be rotated upside-down and so there is no 180 value.</p>

<p>As you would expect, our desktop Chrome browser doesn't
support the orientationchange event. (You can try to spin your monitor around but don't blame me if you wreck anything!).
Keeping our spirit of making the app work as an app and in 
the desktop Chrome, we are going to do something a little
different. (Although orientationchange is the "correct" way to do it.)</p>

<p>The closest thing to orientationchange on a desktop browser,
and something that will also work on our WebView browser,
is the "resize" event of the window object. This event fires
for every resize - big or small - of the browser window.
This includes the resize that our device will do to the
WebView when we rotate the device.</p>

<p>OK, let's get the ball rolling (or should that be rotating? LOL). Stick a call to <code>configureCanvasRotationAdjustment();</code>
at the bottom of </code>receivedEvent()</code> in </code>index.js</code>.
We define this function in </code>canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//device "rotation" handler</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureCanvasRotationAdjustment()
{
    window.addEventListener(<span style='color:#2a00ff; '>'resize'</span>, adjustCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>Run this and you can see that the &lt;canvas> resizes when
you rotate the device OR when you resize the desktop
Chrome.</p>

<p>But there's a problem, if you click on a different tab (not Write), rotate the device / resize
the browser and then click back on the Write tab, you get a tiny canvas like this:</p>

<div class="figure">
    <img src="img/figure/fig_470.png">
    <p>Figure 47. &lt;canvas> can become too small</p>
</div>

<p>What's happening is this: Our onresize handler (<code>adjustCanvas()</code>) triggers when the <strong>browser</strong>
resizes, regardless of whichever tab we are on.
The &lt;canvas> container will not be visible when not on the Write tab because of
our whole tabbing mechanism. But <code>adjustCanvas()</code> will still get called and create or adjust
the canvas. It seems like <code>.getComputedStyle()</code> picks up the &lt;canvas> container smallest dimension as
100px when it is not visible. This resizes the &lt;canvas> to a tiny size - it just isn't visible
until you click the Write tab.</p>
<p>Remember we put <code>adjustCanvas()</code> in <code>firstLoadForTab_Write()</code>?
This means that when we go back to the Write tab after clicking another tab, <code>adjustCanvas()</code> is <strong>not</strong> called.
One solution would be to somehow only action the resize handler when on the Write tab.
But what we will do instead is move the call to <code>adjustCanvas()</code> out of <code>firstLoadForTab_Write()</code>
and into <code>onclickForTab_Write()</code> such that the canvas is adjusted on every clicking
of the Write tab. So remove <code>adjustCanvas()</code> from <code>firstLoadForTab_Write()</code> and stick it in
<code>onclickForTab_Write()</code> so it looks like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> onclickForTab_Write()
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'click on write tab'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(!global_pagesLoaded.write)
    {
        firstLoadForTab_Write();
    }
    
    adjustCanvas(); <span style='color:#3f7f59; '>//adjust - creating if necessary - the canvas element</span>
}</code>

<p>Run this and the problem has been resolved. Nice.</p>

<p>Phew, so the canvas display and layout is pretty hot and tasty right now and should be appropriate
for any device that the app runs on.</p>

<h3 id="the_write_tab_iii">Displaying a random character</h3>

<p>Now, even before we get to the New character and Clear buttons, we need to present a random
Japanese character for the user to draw. And of course we need to make finger movements on the
canvas actually write something!</p>

<p>Put a call to the soon-to-be-implemented <code>doNewChar()</code> at the end of <code>onclickForTab_Write()</code> (so
that every click on the Write tab will present a new character to practice) such that it looks
like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> onclickForTab_Write()
{
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'click on write tab'</span>);
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(!global_pagesLoaded.write)
    {
        firstLoadForTab_Write();
    }
    
    adjustCanvas(); <span style='color:#3f7f59; '>//adjust - creating if necessary - the canvas element</span>
    
    <span style='color:#3f7f59; '>//get and display a random Japanese character to practice writing</span>
    doNewChar();
}</code>

<p><code>doNewChar()</code> is going to get a random Japanese character, and display it above the canvas
for the user's reference. So before we implement <code>doNewChar()</code>, we need a slight detour - we
need the function to get a random Japanese character!
We will put this in, you guessed, <code class="file">linguistics.js</code>.:</p>

<code class="multiline"><span style='color:#3f7f59; '>//return a random (non-chiisai, non-obsolete) hiragana or katakana</span>
<span style='color:#3f7f59; '>//RETURNs object like {char:'く', romaji:'ku', type:'hiragana'}</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> getRandomKana()
{
    <span style='color:#3f7f59; '>//indices to ignore from coreHiragana:</span>
    <span style='color:#3f7f59; '>//64,65,68,>=74</span>
    <span style='color:#3f7f59; '>//so this is indices of coreHiragana of chars that we WANT to practice</span>
    <span style='color:#3f7f59; '>//(ie. not chiisai or obsolete):</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> coreIndices =
    [
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
        10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
        20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
        30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
        40, 41, 42, 43, 44, 45, 46, 47, 48, 49,
        50, 51, 52, 53, 54, 55, 56, 57, 58, 59,
        60, 61, 62, 63, 66, 67, 69, 70, 71, 72,
        73
    ];
    
    <span style='color:#3f7f59; '>//get one of above indices at random</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> index = coreIndices[Math.<span style='color:#7f0055; font-weight:bold; '>floor</span>(Math.<span style='color:#7f0055; font-weight:bold; '>random</span>() * coreIndices.length)];
    
    <span style='color:#3f7f59; '>//default to hiragana...</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> char = coreHiragana[index]; <span style='color:#3f7f59; '>//use our random index</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> type = <span style='color:#2a00ff; '>'hiragana'</span>;
    
    <span style='color:#3f7f59; '>//...but have a 50% chance of returning katakana</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(Math.<span style='color:#7f0055; font-weight:bold; '>random</span>() > 0.50)
    {
        char = hira_to_kata(char);
        type = <span style='color:#2a00ff; '>'katakana'</span>;
    }
    
    <span style='color:#3f7f59; '>//return a useful object</span>
    <span style='color:#7f0055; font-weight:bold; '>return</span> {char:char, romaji:kana_to_romaji(char), type:type};
}</code>

<p>This again might be something that's best ignored and treated as a black box, but basically we 
cherry pick a phonetic character from coreHiragana based on some desired indices (to give us a 
full size and non-obsolete character). We then convert that character into katakana
50% of the time. We return an object with the character itself and some metadata.</p>

<p>Let's use this function in <code>doNewChar()</code> which we define in <code class="file">canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Get and display (with explanation) a random Japanese character</span>
<span style='color:#3f7f59; '>//to practice writing</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> doNewChar()
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> randomKana = getRandomKana();
    
    document.getElementById(<span style='color:#2a00ff; '>'char-to-write'</span>).innerHTML = randomKana.char;
    
    document.getElementById(<span style='color:#2a00ff; '>'char-explanation'</span>).innerHTML = <span style='color:#2a00ff; '>'("'</span> + randomKana.romaji + <span style='color:#2a00ff; '>'" in '</span> + randomKana.type + <span style='color:#2a00ff; '>')'</span>;
}</code>

<p>Running the app now looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_480.png">
    <p>Figure 48. Random Japanese character with metadata is displayed</p>
</div>

<p>Pretty cool! We get the random character to practice writing in a nice big font, the English
spelling / pronunciation and the type of script it's from.</p>

<p>Wait, I've just had a good idea. How about, before we let them start writing, if we flash up
the character on the canvas, filling the canvas and then fading out for them to start copying
it! That's gonna be awesome!</p>

<hr>


<p>Note that this next bit (an initial, fading character on the &lt;canvas>) is going to be somewhat difficult and involves recursive
JavaScript.</p>

<p>We'll want to do this character fading for every new character that we present. So a good place
to call our fading function will be from <code>doNewChar()</code> in <code class="file">canvas.js</code>.
Add this as the last line in <code>doNewChar()</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//put character on canvas and fade to nothing (starting at 1 opacity)</span>
<span style='color:#3f7f59; '>//our trademark #990000 red is rgb(153, 0, 0)</span>
fadeCharOnCanvas(randomKana.char, 153, 0, 0, 1, 1, 100, 10);</code>

<p>We call <code>fadeCharOnCanvas()</code> with a <strong>lot</strong> of parameters.
Let's implement <code>fadeCharOnCanvas()</code> - also in <code class="file">canvas.js</code> - right now.
It's a biggie because it uses a few helper functions and variables that we'll implement shortly.
So don't be scared if you see something that hasn't been referenced yet! OK, implement <code>fadeCharOnCanvas()</code>
to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Animate a fade out of a single (Japanese) character on the canvas.</span>
<span style='color:#3f7f59; '>//Starting from opacity of startAlpha and stepping down to zero opacity</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> fadeCharOnCanvas(char, startR, startG, startB, startAlpha, thisAlpha, msDelay, frameCount)
{
    <span style='color:#3f7f59; '>//calc the step down amount</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> dec = startAlpha / frameCount;
    
    <span style='color:#3f7f59; '>//what will the *next* opacity be?</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> nextAlpha = thisAlpha - dec;
    
    <span style='color:#3f7f59; '>//console.log('thisAlpha:' + thisAlpha + ' -- nextAlpha:' + nextAlpha);</span>
    
    <span style='color:#3f7f59; '>//dues to floating point rounding we prob won't reach exactly zero</span>
    <span style='color:#3f7f59; '>//BUT we want exactly zero for the char to disappear</span>
    <span style='color:#3f7f59; '>//SO if thisAlpha is on the last frame, force to zero</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(thisAlpha &lt;= (startAlpha - ((frameCount - 1) * dec)))
    {
        <span style='color:#3f7f59; '>//console.log('last frame reached');</span>
        thisAlpha = 0;
    }
    
    clearCanvas();  <span style='color:#3f7f59; '>//else we are drawing a lighter char over a darker one!</span>
    
    <span style='color:#3f7f59; '>//console.log(global_canvasElement.width);</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> fontSize = <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(global_canvasElement.width * 0.833);
    <span style='color:#3f7f59; '>//console.log(fontSize);</span>
    global_canvas.font = <span style='color:#2a00ff; '>'normal '</span> + fontSize + <span style='color:#2a00ff; '>'px serif'</span>;
    global_canvas.fillStyle = <span style='color:#2a00ff; '>'rgba('</span> + startR + <span style='color:#2a00ff; '>','</span> + startG + <span style='color:#2a00ff; '>','</span> + startB + <span style='color:#2a00ff; '>','</span> + thisAlpha + <span style='color:#2a00ff; '>')'</span>;    <span style='color:#3f7f59; '>//rgb alpha</span>
    global_canvas.fillText(char, <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(global_canvasElement.width * 0.05), <span style='color:#7f0055; font-weight:bold; '>parseInt</span>(global_canvasElement.width * 0.78));
    
    <span style='color:#7f0055; font-weight:bold; '>if</span>(nextAlpha &lt; 0)
    {
        <span style='color:#3f7f59; '>//console.log('last frame drawn - exiting');</span>
        <span style='color:#7f0055; font-weight:bold; '>return</span>;
    }
    
    <span style='color:#3f7f59; '>//recurse!</span>
    setTimeout(<span style='color:#7f0055; font-weight:bold; '>function</span>(){fadeCharOnCanvas(char, startR, startG, startB, startAlpha, nextAlpha, msDelay, frameCount)}, msDelay);
}</code>





<p>The &lt;canvas> API lets us write text in any colour and at any opacity. We set the opacity using what's called an <em>alpha</em>
value; one meaning fully opaque and zero meaning fully transparent. In a nutshell, we simply
draw the character on the canvas a bunch of times and increase the transparency at each step.
OK, let's have a fuller explanation..</p>

<p>We accept, in order of appearance, these parameters:</p>

<ol>
<li>char - the single Japanese character to draw</li>
<li>startR - red element of colour to use for drawing (integer 0 - 255)</li>
<li>startG - green element of colour to use for drawing (integer 0 - 255)</li>
<li>startB - blue element of colour to use for drawing (integer 0 - 255)</li>
<li>startAlpha - opacity used to draw the <em>first</em> frame (float 0.0 - 1.0)</li>
<li>thisAlpha - opacity used to draw the <em>current</em> frame (float 0.0 - 1.0)</li>
<li>msDelay - the delay, in milliseconds, between each frame</li>
<li>frameCount - how many frames to take to get down to zero opacity</li>
</ol>

<p>(Note that startR, startG and startB don't actually change value at any step of the recursion.)
</p>

<p>We save in <code>dec</code> the amount we have to decrement the starting opacity (startAlpha) by each step
to reach zero opacity after the specified number of frames (frameCount).</p>
<p>We then use <code>dec</code> to work out what the opacity of the <em>next</em> frame will be. We'll use this value a bit later on.</p>

<p>Next we have a workaround for the vagaries of floating point arithmetic. Basically, due to
rounding, we might not reach an opacity of exactly zero on our last frame. So we do an <code>if</code>
check here to see if we are more-or-less on the last frame now (ie. (frameCount - 1) frames have already happened).
If we are, we force the current opacity to zero.</p>

<p>Next, and before we draw anything, we clear the canvas. We will define <code>clearCanvas()</code> shortly.</p>

<p>Next we calculate <code>fontSize</code> to make the character best fill the canvas.
During development I saw that for a 300px by 300px canvas, a font size of 250px was best.
This is the equivalent of the font size being 83.3% of the canvas size. Trial-and-error
with some different canvas sizes told me that this percentage <em>just works</em>.
<code>global_canvasElement</code> is the &lt;canvas> DOM element
which we need to have available when this function is called.
</p>

<p>Next we use the <code>font</code> property of <code>global_canvas</code> to set the font size
we just calculated. <code>global_canvas</code> is the <em>drawing context</em> of our &lt;canvas> element
which we need to have available when this function is called. We cover this shortly so don't worry.</p>

<p>Next we use an rgba ("red, green, blue, alpha") value to set the <code>global_canvas.fillStyle</code> property. This sets
the colour and opacity that our character will get drawn with.</p>

<p>Then we call <code>global_canvas.fillText()</code> which actually writes our character on the canvas.
The second argument is the canvas x coordinate where you want the (left edge of the) text to start drawing.
The third argument is the canvas y coordinate where you want the (bottom baseline of the) text to be.
Again by trial-and-error I saw it was best for the x coordinate to be 5% of the canvas total width,
and the y coordinate to be 78% of the canvas total height.</p>

<p>OK, that's one frame drawn, but we are still in the function and so we need to exit the function
if we have just drawn the last frame. That's what we do with the next <code>if</code> check.</p>

<p>Last but not least, if we are still in the function then we have another frame to draw. We
make the function call itself (<em>recursion</em>) at the end. <strong>But</strong> this should
only happen after the specified delay (msDelay) and so we use JavaScript's builtin <code>setTimeout()</code>
method (of the <code>window</code> object) to call ourself after the delay. <code>setTimeout()</code> works like
<code>setTimeout(someCallableThing, delayInMilliseconds);</code>. We simply call ourself with the updated
value for nextAlpha - all the other arguments are the same.</p>

<p>Great! But we still need to define <code>clearCanvas()</code> and initialise <code>global_canvas</code>
and <code>global_canvasElement</code>. Let's do the globals first, define them at the top of <code class="file">canvas.js</code>
like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>//The drawing context of our &lt;canvas></span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_canvasElement;

<span style='color:#3f7f59; '>//Our &lt;canvas> DOM element</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_canvas;</code>



<p>Nothing difficult there. Now, again in <code class="file">canvas.js</code>, define <code>initialiseCanvas()</code>
thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Save our global canvas variables</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> initialiseCanvas()
{
    <span style='color:#3f7f59; '>//set the globals</span>
    global_canvasElement = document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    global_canvas = global_canvasElement.getContext(<span style='color:#2a00ff; '>'2d'</span>);
}</code>

<p>Good old <code>document.getElementById()</code> is used to save the canvas DOM element into <code>global_canvasElement</code>.
For <code>global_canvas</code> we call <code>getContext('2d')</code> on our canvas DOM element.
This is a builtin method of the HTML5 canvas object and will return an API for 2D drawing.
(Yes, there's a 3D API - <code>getContext('webgl')</code> - but it won't work in as many browsers as the 2D API.)
</p>

<p>The question now is where to call <code>initialiseCanvas()</code>?
If you're thinking that we need to call it once and only once, then you're thinking the same as me.
However, during development I noticed an obscure quirk with the canvas drawing context whenever
the canvas was resized (ie. we rotate our device): the canvas drawing context would reset!
With this in mind we need to call <code>initialiseCanvas()</code> <strong>every</strong> time
the canvas is adjusted. This is actually easy to do and simply involves adding:</p>

<code class="multiline">initialiseCanvas();</code>

<p>as the very last line of <code>adjustCanvas()</code>.</p>

<p>Just <code>clearCanvas()</code> left now. Stick it in <code class="file">canvas.js</code> and it goes like:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Clear the canvas</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> clearCanvas()
{
    global_canvas.clearRect(0, 0, global_canvasElement.width, global_canvasElement.height);
}</code>

<p>We use the <code>clearRect()</code> canvas API method to clear a rectangle on the canvas. The rectangle we clear starts at (0, 0) in canvas space
and the width and height matches that of the canvas itself. This clears the entire canvas.</p>

<p>All done! You should now get the Japanese character fading down on the canvas for each new character!</p>




<h3 id="the_write_tab_iv">Finger doodling</h3>

<p>Right, on to the biggie now which is making something draw on the canvas when the user moves
their finger in there.
Do you remember our work on finger scrolling for the Search tab? Remember we got it working
on the device first then we simulated finger presses - using mouse events - for debugging
in desktop Chrome? Well, let's do it the other way round this time. Let's get canvas
writing working on desktop Chrome first.</p>

<p>When the mouse is down in the canvas, and then the mouse is moved, we want to leave a "trail"
on the canvas as if drawing with a calligraphy brush or what-have-you.
I mentioned earlier that HTML5 canvas is somewhat like MS Paint in the browser. Like MS Paint,
it has a line drawing API where we can start the "brush" at a certain coordinate, and then
paint a line from there to any other coordinate.</p>

<p>And, like we did for simulated finger scrolling, we are going to need a global variable
to track the mouse downness. In fact, we'll recycle the same global variable (so yes, it
might not <em>logically</em> belong in a file called search_interface.js).</p>

<p>You remember our <code>initialiseCanvas()</code> in </code>canvas.js</code> which is where we stored the canvas
in global variables just after creating it for the first time.
That seems like a good place to put the event listeners we're going to need
for our mouse drawing.
Add three <code>addEventListener()</code> calls - on the canvas element - at the bottom of <code>initialiseCanvas()</code>
such that it now looks like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> initialiseCanvas()
{
    <span style='color:#3f7f59; '>//set the globals</span>
    global_canvasElement = document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    global_canvas = global_canvasElement.getContext(<span style='color:#2a00ff; '>'2d'</span>);
    
    <span style='color:#3f7f59; '>//simulated touch (ie. mouse) dragging for writing pad</span>
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousedown'</span>, mousedownForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousemove'</span>, mousemoveForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mouseup'</span>, mouseupForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>You've guessed it we're going to define <code>mousedownForCanvas()</code>, <code>mousemoveForCanvas()</code> and
<code>mouseupForCanvas()</code> right now; also in <code class="file">canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Mousedown event handler for canvas - set "now drawing" state</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mousedownForCanvas(event)
{
    global_mouseButtonDown = <span style='color:#7f0055; font-weight:bold; '>true</span>;
    event.preventDefault();
}

<span style='color:#3f7f59; '>//Mousemove event handler for canvas - draw on canvas</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mousemoveForCanvas(event)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> x, y;
    
    <span style='color:#3f7f59; '>// Get the mouse position relative to the canvas element.</span>
    <span style='color:#3f7f59; '>//(ie. the mouse position IN CANVAS SPACE)</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span> (event.offsetX || event.offsetX == 0) { <span style='color:#3f7f59; '>// Opera and Chrome</span>
      x = event.offsetX;
      y = event.offsetY;
    }

    <span style='color:#3f7f59; '>//This event handler works like a drawing pencil which tracks the mouse </span>
    <span style='color:#3f7f59; '>//movements. We start drawing a path made up of lines.</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(global_mouseButtonDown)
    {
        doDrawOnCanvas(x, y);    <span style='color:#3f7f59; '>//our canvas API magic</span>
    }
}

<span style='color:#3f7f59; '>//Mouseup event handler for canvas - unset "now drawing" state</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> mouseupForCanvas(event)
{
    <span style='color:#3f7f59; '>//console.log('mouseup event on canvas');</span>
    
    global_mouseButtonDown = <span style='color:#7f0055; font-weight:bold; '>false</span>;
    global_startedDrawing = <span style='color:#7f0055; font-weight:bold; '>false</span>;
    event.preventDefault();
}</code>

<p><code>mousedownForCanvas()</code> simply sets our recycled global_mouseButtonDown to true.
In <code>mousemoveForCanvas()</code> we receive the mouse event and, if the mouse button is
down, call <code>doDrawOnCanvas()</code> with canvas space x and y coordinates.
Specifically we pass it offsetX and offsetY of the mouse event. 
In Chrome (and also Opera but definitely not Firefox), this is the xy coords
of the mouse event but offset to be in element space. Element space meaning
the very top-left of the element is x=0, y=0 and so on.</p>

<p>Why call <code>doDrawOnCanvas()</code> and not just do the canvas drawing logic in the 
mousemove handler? Well it's because, like we did for search results scrolling,
we want to reuse the same logic for actual finger drawing and simulated finger drawing
with the mouse. We'll get on to <code>doDrawOnCanvas()</code> in a moment.</p>

<p>Finally in <code>mouseupForCanvas()</code> we set global_mouseButtonDown to false.
We also set global_startedDrawing to false but we haven't defined that yet.
Let's define it first then I'll explain. Stick:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Are we already drawing on the canvas?</span>
<span style='color:#7f0055; font-weight:bold; '>var</span> global_startedDrawing = <span style='color:#7f0055; font-weight:bold; '>false</span>;</code>

<p>at the top of <code class="file">canvas.js</code> with the other globals.</p>

<p>We need to keep track of this because, as we will see shortly, with canvas API
we have two very distinct steps of drawing lines; moving the brush to a certain point to
start the path and then actually moving the brush from that point.
So most of the magic happens in our <code>doDrawOnCanvas()</code> which we will define right now, also
in <code class="file">canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Universal canvas line plotter. for onmousemove etc</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> doDrawOnCanvas(canvasX, canvasY)
{
    <span style='color:#3f7f59; '>//This works like a drawing pencil which tracks the mouse / touch </span>
    <span style='color:#3f7f59; '>//movements. We draw a path made up of lines.</span>
    <span style='color:#7f0055; font-weight:bold; '>if</span>(!global_startedDrawing) <span style='color:#3f7f59; '>//first time</span>
    {
        global_canvas.beginPath();
        global_canvas.moveTo(canvasX, canvasY);
        global_startedDrawing = <span style='color:#7f0055; font-weight:bold; '>true</span>;
    }
    
    <span style='color:#7f0055; font-weight:bold; '>else</span>
    {
        global_canvas.lineTo(canvasX, canvasY);
        global_canvas.stroke();
    }
}</code>

<p>We expect to receive x and y coordinates in canvas space, which is conveniently provided
by .offsetX and Y on the mousemove event. (The offsetX and Y properties will contain
the screen coordinates of the mouse converted into element space such that
if the mouse is in the very top-left of the element - our canvas - the offsetX and Y
will be 0,0.)</p>

<p>For the first time that drawing has started, we call a couple of canvas API methods
to get ready for drawing. We call <code>beginPath()</code> which starts a new path. A path is
basically a line or curve that we draw onto the canvas. We then call <code>moveTo()</code> which
positions the "brush" but does not actually paint anything.
We then, for subsequent mousemoves or finger drags set global_startedDrawing to true
so that the next bit can happen&hellip;</p>

<p>Which is simply to call two more canvas API methods. We call <code>lineTo()</code> with the updated
mouse / finger position (again in canvas space) which will move the brush from its
path starting point to the point specified. Note that even this will not paint anything 
on the canvas. For that we need to call <code>stroke()</code> which will actually follow the path and
put the "ink" down.</p>



<p>Give it a whirl in desktop Chrome! You should be able to paint on the canvas using the mouse!</p>

<div class="figure">
    <img src="img/figure/fig_490.png">
    <p>Figure 49. Canvas painting with mouse</p>
</div>

<p>Hmmm, but that thin black line doesn't feel so great.
Let's fatten it out and make it our signature red.
HTML5 canvas exposes a bunch of properties that we can
tinker with to affect line drawing style.
The right place to change these settings feels
like our one-off canvas initialiser of <code>initialiseCanvas()</code>.
Add two lines to the bottom so it looks like:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> initialiseCanvas()
{
    <span style='color:#3f7f59; '>//set the globals</span>
    global_canvasElement = document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    global_canvas = global_canvasElement.getContext(<span style='color:#2a00ff; '>'2d'</span>);
    
    <span style='color:#3f7f59; '>//simulated touch (ie. mouse) dragging for writing pad</span>
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousedown'</span>, mousedownForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousemove'</span>, mousemoveForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mouseup'</span>, mouseupForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    <span style='color:#3f7f59; '>//line drawing style</span>
    global_canvas.strokeStyle = <span style='color:#2a00ff; '>'#990000'</span>; <span style='color:#3f7f59; '>//our trademark red</span>
    global_canvas.lineWidth = 10;
}</code>


<p>We can set the colour that <code>stroke()</code> will use with 
.strokeStyle. We can set the line width with, yes,
.lineWidth.</p>

<p>Try it!:</p>

<div class="figure">
    <img src="img/figure/fig_500.png">
    <p>Figure 50. Line angles and edges somewhat jaggedy</p>
</div>

<p>Much better! The red looks great and it feels nice and fat
like a calligraphy brush. But, and this is much easier
to notice when you're actually drawing with it and not looking
at this screenshot, there's something not quite right.
The drawn line seems to have some quite sharp edges
and generally looks jaggedy.</p>

<p>Digging deeper into the canvas API, we have some interesting properties to change the
brush drawing style.
The lineJoin property of the canvas (<a href="http://www.html5canvastutorials.com/tutorials/html5-canvas-line-joins">http://www.html5canvastutorials.com/tutorials/html5-canvas-line-joins</a> is a useful page) specifies how we want to draw the "join"
between two lines which in our case basically means the point where
we change the direction of drawing with our brush.
The default is "miter" which is a very sharp join. You can see this on the above
figure.
The remaining options are "bevel" and "round". We'll go for round
as this most resembles what a calligraphy brush would do.</p>

<p>There is also the "lineCap" property (<a href="http://www.html5canvastutorials.com/tutorials/html5-canvas-line-caps">http://www.html5canvastutorials.com/tutorials/html5-canvas-line-caps</a> is a useful page) which is how to draw the end of the line.
As you can see from the above figure, the default is "square".
For that calligraphy feel, let's make this also "round".
So add to the end of <code>initialiseCanvas()</code> so it looks like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> initialiseCanvas()
{
    <span style='color:#3f7f59; '>//set the globals</span>
    global_canvasElement = document.getElementById(<span style='color:#2a00ff; '>'paper'</span>);
    global_canvas = global_canvasElement.getContext(<span style='color:#2a00ff; '>'2d'</span>);
    
    <span style='color:#3f7f59; '>//simulated touch (ie. mouse) dragging for writing pad</span>
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousedown'</span>, mousedownForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mousemove'</span>, mousemoveForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'mouseup'</span>, mouseupForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    
    <span style='color:#3f7f59; '>//line drawing style</span>
    global_canvas.strokeStyle = <span style='color:#2a00ff; '>'#990000'</span>; <span style='color:#3f7f59; '>//our trademark red</span>
    global_canvas.lineWidth = 10;
    global_canvas.lineCap = <span style='color:#2a00ff; '>'round'</span>;   <span style='color:#3f7f59; '>//dat calligraphy feel</span>
    global_canvas.lineJoin = <span style='color:#2a00ff; '>'round'</span>;   <span style='color:#3f7f59; '>//dat calligraphy feel</span>
}</code>

<p>Try running the app now and it draws like this:</p>

<div class="figure">
    <img src="img/figure/fig_510.png">
    <p>Figure 51. Line angles and ends have a rounder feel</p>
</div>

<p>Awesome! I feel warm and fuzzy inside.</p>

<p>Right, let's quickly get our bottom buttons in the bag and then we'll
get our calligraphy brush working with our sticky fingers on our actual device.
Okey dokey, we're going to need some event handlers to do the appropriate things
for our New character and Clear buttons. Stroll over to <code class="file">index.js</code> and whack a call to
<code>configureCanvasButtons();</code> at the end of <code>receivedEvent()</code>. <code>receivedEvent()</code> will
look like this now:</p>

<code class="multiline"><span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
    receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
        console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);
        
        configureTabs();
        
        <span style='color:#3f7f59; '>//load and show whatever we've set the initial tab to be</span>
        initialiseDefaultTab();
        
        configureSearchButton();
        
        configureSearchInput();
        
        configureSearchTouchScrolling();
        
        configureSearchMouseScrolling();
        
        configureCanvasRotationAdjustment();
        
        configureCanvasButtons();
    },</code>

<p>We'll define <code>configureCanvasButtons()</code> in <code class="file">canvas.js</code> thus:</p>

<code class="multiline"><span style='color:#3f7f59; '>//"New character" and "Clear" buttons</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> configureCanvasButtons()
{
    document.getElementById(<span style='color:#2a00ff; '>'canvas-clear'</span>).addEventListener(<span style='color:#2a00ff; '>'click'</span>, clearCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
    document.getElementById(<span style='color:#2a00ff; '>'canvas-new'</span>).addEventListener(<span style='color:#2a00ff; '>'click'</span>, doNewChar, <span style='color:#7f0055; font-weight:bold; '>false</span>);
}</code>

<p>And that's it! The Clear button simply calls our existing <code>clearCanvas()</code> function,
and the New character button simply calls our existing <code>doNewChar()</code> function.
Try it! The write tab is much more fun now!</p>

<p>Right, the remaining matter is the important one of getting drawing to work
with finger moves on the device itself. We are happy with how it works in desktop Chrome
now so let's move forward and think about the device.
We isolated the <code>doDrawOnCanvas()</code> function and it is ready to accept canvas coordinates
from <em>any</em> event, not just mouse events.</p>

<p>Just like with search results scrolling, the events in question are touchstart, touchmove
and touchend. These will somewhat correlate with the mousedown, mousemove and mouseup
handlers (respectively) that we've just implemented.</p>

<p>In <code>initialiseCanvas()</code> in <code class="file">canvas.js</code>, go ahead and insert these three lines to add
our touch event handlers. Insert them after the mouse event handlers:</p>

<code class="multiline"><span style='color:#3f7f59; '>//touch dragging for writing pad</span>
global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'touchstart'</span>, touchstartForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'touchmove'</span>, touchmoveForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);
global_canvasElement.addEventListener(<span style='color:#2a00ff; '>'touchend'</span>, touchendForCanvas, <span style='color:#7f0055; font-weight:bold; '>false</span>);</code>

<p>Great, now let's define these handlers; again in <code class="file">canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Touchstart event handler for canvas</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchstartForCanvas(event)
{
    <span style='color:#3f7f59; '>//console.log('touchstart event on canvas');</span>
    
    event.preventDefault();
}

<span style='color:#3f7f59; '>//Touchmove event handler for canvas - draw on canvas</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchmoveForCanvas(event)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> touchobj = event.changedTouches[0]; <span style='color:#3f7f59; '>//reference first touch point for this event</span>
    
    <span style='color:#3f7f59; '>//where, in canvas space, has been touched?</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> x, y;
    
    x = touchobj.offsetX;
    y = touchobj.offsetY;
  
    doDrawOnCanvas(x, y);
}

<span style='color:#3f7f59; '>//Touchend event handler for canvas - unset "now drawing" state</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> touchendForCanvas(event)
{
    <span style='color:#3f7f59; '>//console.log('touchend event on canvas');</span>
    
    global_startedDrawing = <span style='color:#7f0055; font-weight:bold; '>false</span>;
    
    event.preventDefault();
}</code>




<p>We don't actually do anything in the touchstart handler, but we'll keep it
in case we do need to do anything in future.</p>

<p>In the touchmove handler we get the first touch point and, like we did for mousemove,
pass its offsetX and Y to <code>doDrawOnCanvas()</code>.</p>

<p>Finally the touchend handler simply sets the global "started drawing" state to false;
ready for the next scribble.</p>

<p>OK, so run this on your device and, hmmmm, finger drawing does not work! What gives?
The problem is that the touch object we get from the touchmove event does not
have offsetX or Y properties! Nor does the touchmove event itself! This is officially
A Very Annoying Thing. I think the JavaScript implementors are missing a bit of a trick
here honestly.
Without offsetting the touch object coordinates, they will be screen coordinates
and will not correlate to canvas space. They will basically be too big to point to anywhere
meaningful in the canvas.</p>

<p>The good news is that every DOM element under &lt;body> exposes some offset properties.
Specifically we have .offsetParent which points to an element's parent element, and we
have .offsetLeft and .offsetTop which tell us, in pixels, how far away from the top-left
of the parent the top-left of the element is.</p>

<p>The bad news is that most elements, in particular our canvas, have multiple parents.
We are going to have to programatically loop up through an element's parents and
tot up the offsets to work out a true screen offset of an element. It's actually a trivial function
and let's put it in <code class="file">canvas.js</code>:</p>

<code class="multiline"><span style='color:#3f7f59; '>//Get DOM element position on page</span>
<span style='color:#7f0055; font-weight:bold; '>function</span> getPosition(obj)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> x = 0, y = 0;
    
    <span style='color:#7f0055; font-weight:bold; '>if</span> (obj.offsetParent)
    {
        <span style='color:#7f0055; font-weight:bold; '>do</span>
        {
            x += obj.offsetLeft;
            y += obj.offsetTop;
            obj = obj.offsetParent;
        }
        <span style='color:#7f0055; font-weight:bold; '>while</span>(obj);
    }
    
    <span style='color:#7f0055; font-weight:bold; '>return</span> {<span style='color:#2a00ff; '>'x'</span>:x, <span style='color:#2a00ff; '>'y'</span>:y};
};</code>

<p>We accept a DOM element in obj. We start the x and y values - our offset - at zero.
Then, if we have an .offsetparent on obj (if not then it is &lt;body> and will have no parent)
we loop (at least once) cumulatively adding .offsetLeft to x and .offsetTop to y.
We loop as long as there is a parent up the chain.
We return the coordinates in a little object.</p>

<p>Right, with this we can go back and fix <code>touchmoveForCanvas()</code>. Edit <code>touchmoveForCanvas()</code>
to look like this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>function</span> touchmoveForCanvas(event)
{
    <span style='color:#7f0055; font-weight:bold; '>var</span> touchobj = event.changedTouches[0]; <span style='color:#3f7f59; '>//reference first touch point for this event</span>
    
    <span style='color:#3f7f59; '>//where, in canvas space, has been touched?</span>
    <span style='color:#7f0055; font-weight:bold; '>var</span> x, y;
    
    <span style='color:#7f0055; font-weight:bold; '>var</span> canvasOffset = getPosition(global_canvasElement);   <span style='color:#3f7f59; '>//why no offset x and y for if it's a touch event? :-(</span>
    x = touchobj.screenX - canvasOffset.x;
    y = touchobj.screenY - canvasOffset.y;
  
    doDrawOnCanvas(x, y);
}</code>

<p>Run this on your device. It works!</p>

<p>OMG, we've nailed it, we've finished all the tabs! Crack the beers open at this point ;-)</p>

<p>Just two more easy things. Let's have a splashscreen that displays while we are
waiting for the app to start. Also, we're going to need something other than PhoneGap's
default launcher icon!</p>



<h3 id="the_write_tab_v">Extra credit challenges</h3>

<p>Solutions not provided.</p>

<h4>Easy</h4>

<p>Prevent the current character from being displayed again when clicking the New character button</p>

<h4>Medium</h4>

<p>The way we have centred the big fading character on the &lt;canvas> is slightly ridiculous. Use the &lt;canvas> API to <em>properly</em> centre the character on the &lt;canvas> [NOTETOSELF find the good link for this]</p>

<h4>Difficult</h4>

<p>Technically what we are doing here for finger doodling is following the mouse or finger and, underneath it,
creating a multi-sectional line. We aren't actually simply placing a pixel under the
mouse or finger. Now, the effect is the same so it mostly doesn't matter, but there
is a side effect of doing it this way which is that, on the device, if you draw a very quick
semi-circle, for example, it will end up looking like this:</p>

<div class="figure">
    <img src="img/figure/fig_520.png">
    <p>Figure 52. Imperfect lines can be created</p>
</div>

<p>Re-engineer finger doodling to use HTML5 canvas's pixel manipulation API and see if that solves this problem.
<a href="http://beej.us/blog/data/html5s-canvas-2-pixel">http://beej.us/blog/data/html5s-canvas-2-pixel</a> is a useful reference here (though a few years old now)</p>



<h2 id="splash_screen">Splash screen</h2>

<p>To kill the dragon, turn to page 84. To hide in the tunnel, keep reading.
LOL that was an interactive fiction reference, because this entire chapter is optional. Why?
Well it's about implementing a <em>splash screen</em> which is a contentious issue in the
world of Android apps. (It also involves fiddling with our app's Java sources which is a bit advanced for this tutorial.)</p>

<p>A splash screen is displayed after tapping
an app's launcher icon. They tend to fill the screen and disappear after a delay and / or
when the app is ready. Plenty of apps don't have one. Most big name games have one
as those apps can take a while to load. Small utility apps (which is what Japxlate is)
seem to mostly not have one.</p>

<p>Why is this contentious? Well, the thinking is that they form a barrier to using the app.
But they are something to look at when larger apps are loading which could be useful.</p>

<p>So make up your own mind (<a href="http://cyrilmottier.com/2012/05/03/splash-screens-are-evil-dont-use-them">http://cyrilmottier.com/2012/05/03/splash-screens-are-evil-dont-use-them</a> is useful) and skip this chapter if you feel Japxlate doesn't need a splash screen.
If you think it does need one - or just want to see how it generally works - then please read on.</p>

<hr>

<p>Hopefully only the first time while the Web SQL database is created, but our app may take a while to start, and we also want to have some branding.
So, we will have a splash screen.
PhoneGap exposes splash screen control in the "Splashscreen" API.
This needs to be installed as a plugin which can be done like this:</p>


<code class="terminal"><span>you@yours$ japxlate]$</span> phonegap local plugin add https://git-wip-us.apache.org/repos/asf/cordova-plugin-splashscreen.git</code>
<p class="new_3_3_0">(From PhoneGap v3.3.0 you can simply type <code>phonegap local plugin add org.apache.cordova.splashscreen</code>)</p>
<p>Under the hood, this command will do a few things for you:</p>

<ul>
<li>Add <code>&lt;feature name="SplashScreen"></code> to <code class="file">res/xml/config.xml</code></li>
<li>Put <code class="file">SplashScreen.java</code> in newly created <code class="file">/src/org/apache/cordova/splashscreen</code> folder
    (so this is an example of a plugin that will add to the native Java sources)</li>
<li>Put plugin in <code class="file">/assets/www/plugins/</code> <span class="new_3_3_0">(Because of the new Plugman, PhoneGap v3.3.0 instead puts the plugin in <code class="file">PROJECTROOT/plugins</code>)</span></li>
<li>Add references to the plugin in <code class="file">/assets/www/cordova_plugins.js</code></li>
</ul>

<p>So now we've got the JavaScript API exposing splash screen actions (show or hide). 
But this plugin has also added some native Java (the "SplashScreen" class).
Hold on to your hats folks because we're going to have to fiddle with the app's
Java source code! Don't worry though, it's pretty straightforward.
Open up <code class="file">Japxlate.java</code> (which is in <code class="file">/src/com/drappenheimer/japxlate</code>), it will
look like this:</p>

<code class="multiline">&vellip;
<span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>class</span> Japxlate <span style='color:#7f0055; font-weight:bold; '>extends</span> CordovaActivity 
{
    @Override
    <span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>void</span> onCreate(Bundle savedInstanceState)
    {
        <span style='color:#7f0055; font-weight:bold; '>super</span>.onCreate(savedInstanceState);
        <span style='color:#7f0055; font-weight:bold; '>super</span>.init();
        <span style='color:#3f7f59; '>// Set by &amp;lt;content src="index.html" /> in config.xml</span>
        <span style='color:#7f0055; font-weight:bold; '>super</span>.loadUrl(Config.getStartUrl());
        <span style='color:#3f7f59; '>//super.loadUrl("file:///android_asset/www/index.html")</span>
    }
}</code>

<p>This is the constructor code that gets the app up and running when the launcher icon is tapped.
All we do here is load (indirectly from <code class="file">config.xml</code>) <code class="file">index.html</code> into the current activity - which
is a WebView browser.
Change it to this:</p>

<code class="multiline"><span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>class</span> Japxlate <span style='color:#7f0055; font-weight:bold; '>extends</span> CordovaActivity 
{
    @Override
    <span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>void</span> onCreate(Bundle savedInstanceState)
    {
        <span style='color:#7f0055; font-weight:bold; '>super</span>.onCreate(savedInstanceState);
        <span style='color:#7f0055; font-weight:bold; '>super</span>.init();
        <span style='color:#3f7f59; '>// Set by &amp;lt;content src="index.html" /> in config.xml</span>
        <span style='color:#7f0055; font-weight:bold; '>super</span>.setIntegerProperty(<span style='color:#2a00ff; '>"splashscreen"</span>, R.drawable.splash);
        <span style='color:#7f0055; font-weight:bold; '>super</span>.loadUrl(Config.getStartUrl(), 5000);    <span style='color:#3f7f59; '>//5 seconds timeout for splash</span>
        <span style='color:#3f7f59; '>//super.loadUrl("file:///android_asset/www/index.html")</span>
    }
}</code>

<p>Before <code>super.loadUrl()</code>, we use <code>super.setIntegerProperty()</code> to set the "splashscreen"
property to <code>R.drawable.splash</code>. "R" is a piece of Java and XML magic which basically
picks up all the files and resources in the "res" folder and exposes them as useable
properties of the "R" object. <code>R.drawable.splash</code> refers to the appropriate
<code class="file">splash.png</code> placed in the <code class="file">/res/drawable</code> folder. <code class="file">splash.png</code> will be our image file
for the splash screen. We are about to make that, but first let's take a peek at the 
<code class="file">/res</code> folder structure:</p>

<div class="figure">
    <img src="img/figure/fig_530.png">
    <p>Figure 53. Contents of <code class="file">/res</code> folder (Eclipse IDE)</p>
</div>

<p>Opening up these folders we see:</p>

<div class="figure">
    <img src="img/figure/fig_540.png">
    <p>Figure 54. Exploded contents of <code class="file">/res</code> folder (NetBeans IDE)</p>
</div>

<p>The <code class="file">icon.png</code> files are the PhoneGap default launcher icons (we'll be changing these a bit later).
As the name suggests, the <code class="file">drawable</code> folder is where we place any kind of image resource
that our app needs.
What's going on here is that, as well as the generic drawable folder, we have four other drawable
folders tailored to different screen pixel densities. A high-end Android device
will have well over 300 pixels-per-inch. In fact a full-HD phone with a compactish (5" or less) display
will probably have over 400!
Imagine our launcher icon is fixed at 32 pixels square. This is going to be tiny on a display
with 400 pixels-per-inch!
The more dense the display pixels are, the larger our launcher icon needs to be to stay the
same physical size and to show the same amount of detail. This is true for splash screen images,
launcher icons, and any drawable.
Back to these folders, we have:</p>

<ul>
<li>drawable-ldpi - "low dots-per-inch" (default launcher icon = 36x36)</li>
<li>drawble-mdpi - "medium dots-per-inch" (default launcher icon = 48x48)</li>
<li>drawable-hdpi - "high dots-per-inch" (default launcher icon = 72x72)</li>
<li>drawable-xhdpi - "eXtra high dots-per-inch" (default launcher icon = 96x96)</li>
</ul>

<p>(Gory details at <a href="http://developer.android.com/guide/practices/screens_support.html]">http://developer.android.com/guide/practices/screens_support.html</a>)</p>

<p>So for our splash screen we need to put a <code class="file">splash.png</code> of correct size
in each of these folders. But just to make sure our code works first we can simply
put one <code class="file">splash.png</code> in the "drawable" folder. Our device will suss that there is no <em>specific</em>
splash image for its native DPI and simply display the default one in the "drawable" folder. Which obviously
might look hideous if the image is too small for the display (or vice versa).
Let's do that first just to get the code working and then we can put in the proper images.</p>

<p>OK, so make (or get from the Japxlate sources) a muckabout png in portrait shape of size
320x470. It's going to be the Japxlate "J" in our signature red.</p>


<p>Put the png file in the drawable folder and run the app on your device.
You should get the image splashed onto the display for 5 seconds
before the app starts. It might look very stretched out and jaggedy. Note that the splash screen will not appear when running the app in desktop Chrome
(which is a good thing).</p>

<div class="sidenote">
<p>If you've added the status bar to the app as discussed at the end of the <a href="#first_things_first_the_layout">First things first: The layout</a> chapter,
you'll still have the status bar when the splash screen is being displayed. 
</p>
</div>

<p>Hmmm, but what if 5 seconds is too long? The app might load much quicker than that and we
want the splash screen to disappear as soon as the app loads.
Well I remember seeing something in <code class="file">config.xml</code>:</p>

<code class="multiline">&lt;preference name="auto-hide-splash-screen" value="true" /></code>

<p>So maybe the splash screen is auto hiding as soon as the app is ready, and, by coincidence, our app is taking 5 seconds to load?
Well, let's test that by changing the timeout in <code class="file">Japxlate.java</code> to 20 seconds:</p>

<code class="multiline">&vellip;
<span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>class</span> Japxlate <span style='color:#7f0055; font-weight:bold; '>extends</span> CordovaActivity 
{
    @Override
    <span style='color:#7f0055; font-weight:bold; '>public</span> <span style='color:#7f0055; font-weight:bold; '>void</span> onCreate(Bundle savedInstanceState)
    {
        <span style='color:#7f0055; font-weight:bold; '>super</span>.onCreate(savedInstanceState);
        <span style='color:#7f0055; font-weight:bold; '>super</span>.init();
        <span style='color:#3f7f59; '>// Set by &amp;lt;content src="index.html" /> in config.xml</span>
        <span style='color:#7f0055; font-weight:bold; '>super</span>.setIntegerProperty(<span style='color:#2a00ff; '>"splashscreen"</span>, R.drawable.splash);
        <span style='color:#7f0055; font-weight:bold; '>super</span>.loadUrl(Config.getStartUrl(), 20000);
        <span style='color:#3f7f59; '>//super.loadUrl("file:///android_asset/www/index.html")</span>
    }
}</code>

<p>Run this and we see that the splash screen does indeed hang around for 20 seconds. The app
is not quite that slow and so we need a way to hide the splash screen
when the app is ready.
We learn from <a href="http://docs.phonegap.com/en/3.1.0/cordova_splashscreen_splashscreen.md.html#Splashscreen">http://docs.phonegap.com/en/3.1.0/cordova_splashscreen_splashscreen.md.html#Splashscreen</a>
that "To dismiss the splash screen once the app receives the deviceready event, call the navigator.splashscreen.hide() method."

Let's try that. Edit <code>thereceivedEvent()</code> method in <code class="file">index.js</code> to look like this:</p>

<code class="multiline"><span style='color:#3f7f59; '>// Update DOM on a Received Event</span>
receivedEvent: <span style='color:#7f0055; font-weight:bold; '>function</span>(id) {
    console.<span style='color:#7f0055; font-weight:bold; '>log</span>(<span style='color:#2a00ff; '>'Received Event: '</span> + id);

    <span style='color:#7f0055; font-weight:bold; '>if</span> (window.cordova) {   <span style='color:#3f7f59; '>//actual app</span>
        navigator.splashscreen.hide();
    }
&vellip;</code>

<p>As the whole of <code>receivedEvent()</code> is called from both our actual device and debugging
in desktop Chrome*, we need to check for <code>window.cordova</code> - ie. we're on the device - before
calling <code>navigator.splashscreen.hide();</code>.</p>

<p>*Which does not need to be the case but is just how our simple app has evolved.</p>

<p>Run this on your device and you will see that the splash screen disappears when the app is ready,
much sooner than 20 seconds! great!</p>

<p>OK, we now need to create the actual splash screen images in the correct sizes.
The correct sizes for each image should be:</p>

<ul>
<li>xlarge (xhdpi): at least 960 × 720</li>
<li>large (hdpi): at least 640 × 480</li>
<li>medium (mdpi): at least 470 × 320</li>
<li>small (ldpi): at least 426 × 320</li>
</ul>

<p>So go ahead and create (or get from Japxlate repo) your final "J" images in these sizes and put them in the
correct drawables folders.</p>

<div class="sidenote">
If the image with the correct density for the device is missing, the app seems to find and use the <em>closest</em> matching one.
</div>

<p>Just one problem remains. Rotate your device into landscape and launch the app. Yuck!
Did you see the splash image? It was really stretched out and fat.</p>

<div class="figure">
    <img src="img/figure/fig_550.png">
    <p>Figure 55. Splash screen when in landscape orientation</p>
</div>

<p>Well here's the correct way to solve this. <em>Really</em> for splash images - and other drawables - you should use
a "9 patch" graphic. This is a tricky little format where PNG images have a one-pixel border
that isn't displayed, but contains control pixels telling Android which bits of the image
to stretch, shrink or leave unaltered when the device is rotated or if the target device's
aspect ratio is not the same as the drawable file in the app.</p>

<p>As you can see already, normal PNGs placed in the drawable folder essentially work, so this tutorial
won't cover 9 patch images any more other than to say that the gory details are here:</p>

<p><a href="https://developer.android.com/guide/topics/graphics/2d-graphics.html#nine-patch">https://developer.android.com/guide/topics/graphics/2d-graphics.html#nine-patch</a><br>
"A NinePatchDrawable graphic is a stretchable bitmap image, which Android will automatically resize to accommodate the contents of the View in which you have placed it as the background. An example use of a NinePatch is the backgrounds used by standard Android buttons — buttons must stretch to accommodate strings of various lengths. A NinePatch drawable is a standard PNG image that includes an extra 1-pixel-wide border. It must be saved with the extension .9.png, and saved into the res/drawable/ directory of your project."</p>

<p>and that the Android SDK has a little tool called draw9patch (in ANDROID_SDK_HOME/sdk/tools) to make
these images which looks like this:</p>

<div class="figure">
    <img src="img/figure/fig_560.png">
    <p>Figure 56. Android SDK's draw9patch utility</p>
</div>

<p class="new_3_3_0">
The PhoneGap / Cordova documentation for v3.3.0 now has a useful summary section on <a href="http://docs.phonegap.com/en/3.3.0/config_ref_images.md.html#Icons%20and%20Splash%20Screens">Icons and Splash Screens</a>.
</p>

<h2 id="launcher_icon">Launcher icon</h2>

<p>Now we move on to our launcher icon. We are provided with a default one which is like
a robot cube thing. Let's replace this with one more relevant for Japxlate. Let's
have one with our "J".
We simply replace the icon.png files in the various drawable folders.
The size of each existing icon.png will tell you the required icon
size for that density.</p>

<p><a href="http://developer.android.com/design/style/iconography.html">http://developer.android.com/design/style/iconography.html</a> is a useful design and technical reference.</p>

<p>Note that you <em>might</em>, in order for the icon to update on deploy to the device, need to do a Project --> Clean in Eclipse IDE.</p>

<p class="new_3_3_0">The PhoneGap / Cordova documentation for v3.3.0 now has a useful summary section on <a href="http://docs.phonegap.com/en/3.3.0/config_ref_images.md.html#Icons%20and%20Splash%20Screens">Icons and Splash Screens</a>.</p>

<h2 id="submitting_to_google_play">Submitting to Google Play</h2>

<p>[NOTETOSELF expand on this section]</p>

<p>This topic deserves - and has - whole books and tutorials dedicated to it. [NOTETOSELF some links would be nice]
We'll cover it in a whistle-stop fashion. To publish your app on the Play Store, follow these steps:</p>

<ol>
<li>Open <code class="file">PROJECTROOT/AndroidManifest.xml</code> and change <code>android:debuggable="true"</code> to <code>android:debuggable="false"</code></li>
<li>In Eclipse IDE, right-click on the Project and select Android Tools --> Export Signed Application Package</li>
<li>Follow the steps (choosing "create new keystore") and be sure to save the keystore file and password, and the alias password, in your favourite secure place for future reference</li>
<li>The final step creates an .apk file in the location you specify. This is what we will upload to google.</li>
<li>You will need to attach an Android Developer account to an already existing vanilla Google account. Do this by logging into Google with your vanilla account first, then signing up as an Android developer at <a href="https://play.google.com/apps/publish/signup">https://play.google.com/apps/publish/signup</a>.
<strong>You'll need a credit or debit card handy as there is a one-off registration fee of $25.</strong></li>
<li>Upload the .apk file to your shiny new Developer account, set the title, description and screenshots (you also need a 512px x 512px hi-res icon) and Bob's your uncle!</li>
</ol>


<h2 id="thats_all_folks">That's all folks!</h2>

<p>[NOTETOSELF this is going to be a wrapping up chat. talk about the app's pros and cons, PhoneGap
pros and cons. And talk about what they need to do and research going forward with their app development. strongly recommend
libraries like Sencha Touch, jQuery Mobile and iScroll especially as doing scrolling from scratch took 
me more than 50% of total development time which is ridiculous!]</p>

<p>TODO useful references</p>
        

<p>Tutorial - and app - written by Daniel Rhodes (AKA <a href="http://drappenheimer.com">Dr Appenheimer</a>) of Warp Asylum Ltd.</p>
<p>Copyright &copy; 2013 - 2014 Warp Asylum Ltd (trading as "Dr Appenheimer").</p>        
        
    </div>
    
<footer>&nbsp;<br>&nbsp;</footer>
</body>
</html>